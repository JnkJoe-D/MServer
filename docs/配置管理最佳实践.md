# 配置管理最佳实践

## 问题：硬编码配置

### 之前的问题

```csharp
// ❌ Program.cs 中硬编码
hostBuilder.ConfigureSuperSocket(options =>
{
    options.Name = "GameServer";
    options.AddListener(new ListenOptions
    {
        Ip = "Any",
        Port = 33333  // ← 硬编码！打包后无法修改
    });
});
```

**问题**：
- 打包后无法修改端口
- 不同环境（开发/测试/生产）无法使用不同配置
- 与其他配置（MySQL、Redis）不一致

---

## 解决方案：统一使用配置文件

### 修复后的实现

#### 1. appsettings.json

```json
{
  "Server": {
    "Name": "GameServer",
    "Ip": "Any",
    "Port": 33333,
    "MaxConnections": 10000,
    "BackLog": 100,
    "HeartbeatInterval": 30,
    "SessionTimeout": 300
  },
  "Database": {
    "ConnectionString": "Server=localhost;Database=gameserver;User=root;Password=xxx;"
  },
  "Redis": {
    "ConnectionString": "localhost:6379",
    "Database": 0
  }
}
```

#### 2. Program.cs

```csharp
// ✅ 从配置文件读取
hostBuilder.ConfigureSuperSocket(options =>
{
    var config = hostBuilder.HostBuilder.Services.BuildServiceProvider()
        .GetRequiredService<IConfiguration>();
    
    // 读取配置，提供默认值
    options.Name = config["Server:Name"] ?? "GameServer";
    options.AddListener(new ListenOptions
    {
        Ip = config["Server:Ip"] ?? "Any",
        Port = config.GetValue<int>("Server:Port", 33333),
        BackLog = config.GetValue<int>("Server:BackLog", 100)
    });
});
```

---

## 多环境配置

### 文件结构

```
SuperSocket/
├── appsettings.json                 # 默认配置
├── appsettings.Development.json     # 开发环境
├── appsettings.Staging.json         # 测试环境
└── appsettings.Production.json      # 生产环境
```

### 示例配置

**appsettings.Development.json**（开发环境）

```json
{
  "Server": {
    "Port": 33333,
    "Ip": "127.0.0.1"
  },
  "Database": {
    "ConnectionString": "Server=localhost;Database=gameserver_dev;..."
  }
}
```

**appsettings.Production.json**（生产环境）

```json
{
  "Server": {
    "Port": 8888,
    "Ip": "Any"
  },
  "Database": {
    "ConnectionString": "Server=prod-db.example.com;Database=gameserver;..."
  }
}
```

### 启动时指定环境

```bash
# 开发环境（默认）
dotnet run

# 生产环境
dotnet run --environment Production

# 使用环境变量
set ASPNETCORE_ENVIRONMENT=Production
dotnet run
```

---

## 命令行参数覆盖

可以通过命令行参数覆盖配置文件：

```bash
dotnet GameServer.dll --Server:Port=9999
```

**优先级**（从高到低）：
1. 命令行参数
2. 环境变量
3. 环境特定配置文件（如 `appsettings.Production.json`）
4. 默认配置文件（`appsettings.json`）

---

## 配置最佳实践

### 1. 敏感信息不要提交到代码库

```json
// ❌ 不要在 appsettings.json 中硬编码密码
{
  "Database": {
    "ConnectionString": "Server=localhost;Password=MyPassword123;"
  }
}
```

**解决方案**：使用环境变量或密钥管理

```bash
# 方式 1：环境变量
set Database__ConnectionString="Server=localhost;Password=RealPassword;"

# 方式 2：用户机密（开发时）
dotnet user-secrets set "Database:ConnectionString" "Server=..."

# 方式 3：Azure Key Vault / AWS Secrets Manager（生产）
```

### 2. 提供合理的默认值

```csharp
// ✅ 使用 ?? 和 GetValue 提供默认值
var port = config.GetValue<int>("Server:Port", 33333);  // 默认 33333
var ip = config["Server:Ip"] ?? "Any";                  // 默认 "Any"
```

### 3. 配置项分组

```json
{
  "Server": { ... },      // 服务器配置
  "Database": { ... },    // 数据库配置
  "Redis": { ... },       // 缓存配置
  "Jwt": { ... },         // 认证配置
  "Logging": { ... }      // 日志配置
}
```

### 4. 使用强类型配置（可选）

**定义配置类**：

```csharp
public class ServerOptions
{
    public string Name { get; set; } = "GameServer";
    public string Ip { get; set; } = "Any";
    public int Port { get; set; } = 33333;
    public int MaxConnections { get; set; } = 10000;
}
```

**注册到 DI**：

```csharp
services.Configure<ServerOptions>(config.GetSection("Server"));
```

**使用**：

```csharp
public class MyService
{
    private readonly ServerOptions _serverOptions;
    
    public MyService(IOptions<ServerOptions> options)
    {
        _serverOptions = options.Value;
    }
}
```

---

## 当前项目配置清单

| 配置项 | 位置 | 说明 |
|--------|------|------|
| 服务器名称 | `Server:Name` | 服务器名称 |
| 监听 IP | `Server:Ip` | `Any`、`127.0.0.1` 等 |
| 监听端口 | `Server:Port` | TCP 端口 |
| 最大连接数 | `Server:MaxConnections` | 连接池大小 |
| 数据库连接 | `Database:ConnectionString` | MySQL 连接字符串 |
| Redis 连接 | `Redis:ConnectionString` | Redis 服务器地址 |
| JWT 密钥 | `Jwt:SecretKey` | 至少 32 字符 |
| 日志级别 | `Logging:MinimumLevel` | Information/Debug/Warning |

---

## 验证配置

### 查看当前配置

```csharp
var config = serviceProvider.GetRequiredService<IConfiguration>();

// 打印所有配置
foreach (var kvp in config.AsEnumerable())
{
    Console.WriteLine($"{kvp.Key} = {kvp.Value}");
}
```

### 测试不同端口

```bash
# 修改 appsettings.json 中的端口
# 或使用命令行参数
dotnet run --Server:Port=8888

# 验证
telnet localhost 8888
```

---

## 总结

| 方式 | 优点 | 缺点 |
|------|------|------|
| **硬编码** | 简单 | ❌ 打包后无法修改 |
| **配置文件** | ✅ 灵活、支持多环境 | 需要部署配置文件 |
| **环境变量** | ✅ 安全（不提交代码库） | 管理复杂 |
| **配置中心** | ✅ 集中管理、动态更新 | 需要额外基础设施 |

**推荐**：
- 开发环境：配置文件 + 用户机密
- 生产环境：配置文件 + 环境变量 + 密钥管理服务
