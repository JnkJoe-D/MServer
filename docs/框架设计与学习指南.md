# æ¸¸æˆæœåŠ¡å™¨æ¡†æ¶è®¾è®¡ä¸å­¦ä¹ æŒ‡å—

## ç›®å½•

- [1. æ•´ä½“æ¶æ„æ¦‚è§ˆ](#1-æ•´ä½“æ¶æ„æ¦‚è§ˆ)
- [2. åˆ†å±‚æ¶æ„è¯¦è§£](#2-åˆ†å±‚æ¶æ„è¯¦è§£)
- [3. è®¾è®¡æ¨¡å¼åº”ç”¨](#3-è®¾è®¡æ¨¡å¼åº”ç”¨)
- [4. æ¶ˆæ¯å¤„ç†æµç¨‹](#4-æ¶ˆæ¯å¤„ç†æµç¨‹)
- [5. æ ¸å¿ƒæ¦‚å¿µè§£é‡Š](#5-æ ¸å¿ƒæ¦‚å¿µè§£é‡Š)
- [6. å¦‚ä½•æµ‹è¯•](#6-å¦‚ä½•æµ‹è¯•)
- [7. æ‰©å±•å¼€å‘æŒ‡å—](#7-æ‰©å±•å¼€å‘æŒ‡å—)

---

## 1. æ•´ä½“æ¶æ„æ¦‚è§ˆ

### 1.1 æ¶æ„ç¤ºæ„å›¾

```mermaid
graph TB
    Client[å®¢æˆ·ç«¯] -->|TCPè¿æ¥| SS[SuperSocket]
    SS -->|è§£æåŒ…| GF[GamePackageFilter]
    GF -->|GamePackage| GW[MessageGateway]
    GW -->|è·¯ç”±| Handler[æ¶ˆæ¯å¤„ç†å™¨]
    Handler -->|ä¸šåŠ¡é€»è¾‘| Service[ä¸šåŠ¡æœåŠ¡å±‚]
    Service -->|æ•°æ®è®¿é—®| DB[(MySQL)]
    Service -->|ç¼“å­˜| Redis[(Redis)]
    Handler -->|å“åº”| Session[GameSession]
    Session -->|å‘é€æ•°æ®| Client
```

### 1.2 æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ä½œç”¨ |
|------|------|------|
| **ç½‘ç»œå±‚** | SuperSocket 2.0.2 | TCP æœåŠ¡å™¨æ¡†æ¶ |
| **åè®®å±‚** | Protobuf 3.27 | äºŒè¿›åˆ¶åºåˆ—åŒ– |
| **æ•°æ®æŒä¹…åŒ–** | EF Core + MySQL | ORM + å…³ç³»æ•°æ®åº“ |
| **ç¼“å­˜å±‚** | Redis | å†…å­˜æ•°æ®åº“ |
| **æ—¥å¿—** | Serilog | ç»“æ„åŒ–æ—¥å¿— |
| **ç›‘æ§** | Prometheus | æŒ‡æ ‡é‡‡é›† |
| **è®¤è¯** | JWT + BCrypt | ä»¤ç‰Œ + å¯†ç åŠ å¯† |

---

## 2. åˆ†å±‚æ¶æ„è¯¦è§£

### 2.1 ç½‘ç»œå±‚ï¼ˆNetworkï¼‰

**èŒè´£**ï¼šå¤„ç† TCP è¿æ¥ã€ç²˜åŒ…/æ‹†åŒ…ã€ä¼šè¯ç®¡ç†

#### æ ¸å¿ƒç±»

##### `GamePackage`
æ¸¸æˆåè®®åŒ…å®šä¹‰ï¼ŒåŒ…å«æ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ã€‚

```
åŒ…ç»“æ„ï¼š
+----------+--------+----------+---------+
| Length:4 | MsgId:2| Seq:4   | Payload |
+----------+--------+----------+---------+
```

- **Length**: æ€»é•¿åº¦ï¼ˆåŒ…å«å¤´éƒ¨ï¼‰
- **MsgId**: æ¶ˆæ¯ ID
- **Sequence**: åºåˆ—å·ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
- **Payload**: Protobuf åºåˆ—åŒ–çš„æ¶ˆæ¯ä½“

##### `GamePackageFilter`
ç»§æ‰¿è‡ª `FixedHeaderPipelineFilter`ï¼Œè´Ÿè´£å¤„ç†**ç²˜åŒ…/æ‹†åŒ…**é—®é¢˜ã€‚

**ä»€ä¹ˆæ˜¯ç²˜åŒ…/æ‹†åŒ…ï¼Ÿ**
- **ç²˜åŒ…**ï¼šå¤šä¸ªå°åŒ…ç²˜åœ¨ä¸€èµ·åˆ°è¾¾
- **æ‹†åŒ…**ï¼šä¸€ä¸ªå¤§åŒ…åˆ†å¤šæ¬¡åˆ°è¾¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è¯»å–å›ºå®šå¤´éƒ¨ï¼ˆ10å­—èŠ‚ï¼‰
2. ä»å¤´éƒ¨è·å–æ€»é•¿åº¦
3. ç­‰å¾…è¯»å–å®Œæ•´åŒ…ä½“
4. è§£æä¸º `GamePackage`

##### `GameSessionData` + æ‰©å±•æ–¹æ³•
å­˜å‚¨ä¼šè¯çš„ä¸šåŠ¡æ•°æ®ï¼ˆç”¨æˆ·IDã€è§’è‰²IDã€è®¤è¯çŠ¶æ€ç­‰ï¼‰ã€‚

```csharp
// è·å–ä¸šåŠ¡æ•°æ®
var gameData = session.GetGameData();

// å‘é€æ¶ˆæ¯ï¼ˆæ‰©å±•æ–¹æ³•ï¼‰
await session.SendMessageAsync(MsgId.Login, response);
```

##### `MessageGateway`
**æ ¸å¿ƒè·¯ç”±å™¨**ï¼Œè´Ÿè´£ï¼š
1. æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨ï¼ˆMsgId â†’ Handlerï¼‰
2. éªŒè¯åºåˆ—å·ï¼ˆé˜²é‡æ”¾ï¼‰
3. åˆ†å‘æ¶ˆæ¯åˆ°å¯¹åº”å¤„ç†å™¨
4. å¼‚å¸¸å¤„ç†å’Œç›‘æ§

---

### 2.2 åè®®å±‚ï¼ˆProtosï¼‰

ä½¿ç”¨ **Protobuf** å®šä¹‰æ‰€æœ‰é€šä¿¡æ¶ˆæ¯ã€‚

#### ä¸ºä»€ä¹ˆç”¨ Protobufï¼Ÿ

| å¯¹æ¯”é¡¹ | JSON | Protobuf |
|--------|------|----------|
| å¤§å° | å¤§ | å°ï¼ˆçº¦1/3-1/5ï¼‰ |
| é€Ÿåº¦ | æ…¢ | å¿« |
| å¯è¯»æ€§ | å¥½ | å·®ï¼ˆäºŒè¿›åˆ¶ï¼‰ |
| ç±»å‹å®‰å…¨ | å¼± | å¼º |

#### æ–‡ä»¶ç»„ç»‡

```
Protos/
â”œâ”€â”€ common.proto    # é€šç”¨æ¶ˆæ¯ï¼ˆç™»å½•ã€æ³¨å†Œã€å¿ƒè·³ï¼‰
â”œâ”€â”€ world.proto     # ä¸–ç•Œ/åœºæ™¯æ¶ˆæ¯
â””â”€â”€ room.proto      # æˆ¿é—´/æˆ˜æ–—æ¶ˆæ¯
```

#### æ¶ˆæ¯ ID æ˜ å°„

`MsgId.cs` å®šä¹‰äº†æ‰€æœ‰æ¶ˆæ¯çš„å”¯ä¸€ IDï¼š

```csharp
public static class MsgId
{
    public const ushort Heartbeat = 0x0001;
    public const ushort Login     = 0x1001;
    public const ushort Register  = 0x1002;
    // ...
}
```

---

### 2.3 ä¸šåŠ¡å±‚ï¼ˆBusinessï¼‰

**èŒè´£**ï¼šå®ç°æ ¸å¿ƒæ¸¸æˆé€»è¾‘

#### `AuthService`
è®¤è¯æœåŠ¡ï¼Œå¤„ç†ç™»å½•/æ³¨å†Œé€»è¾‘ï¼š

```csharp
// æ³¨å†Œ
await authService.RegisterAsync(username, password, email);

// ç™»å½•
var (success, message, token, user) = await authService.LoginAsync(username, password);
```

**å…³é”®æŠ€æœ¯**ï¼š
- **BCrypt**ï¼šå¯†ç å“ˆå¸Œï¼ˆä¸å¯é€†ï¼‰
- **JWT**ï¼šæ— çŠ¶æ€ä»¤ç‰Œè®¤è¯

#### `JwtService`
JWT ä»¤ç‰Œç®¡ç†ï¼š

```csharp
// ç”Ÿæˆä»¤ç‰Œ
string token = jwtService.GenerateToken(userId, username);

// éªŒè¯ä»¤ç‰Œ
var (valid, userId, username) = jwtService.ValidateToken(token);
```

#### `PlayerManager`
åœ¨çº¿ç©å®¶ç®¡ç†å™¨ï¼š

- ç»´æŠ¤åœ¨çº¿ç©å®¶å­—å…¸ï¼ˆPlayerId â†’ PlayerStateï¼‰
- ä¼šè¯æ˜ å°„ï¼ˆSessionId â†’ PlayerIdï¼‰
- ç©å®¶ä¸Šçº¿/ä¸‹çº¿
- å¹¿æ’­æ¶ˆæ¯

---

### 2.4 å¤„ç†å™¨å±‚ï¼ˆHandlersï¼‰

**èŒè´£**ï¼šå¤„ç†å…·ä½“çš„æ¶ˆæ¯è¯·æ±‚

#### æ¶ˆæ¯å¤„ç†å™¨åŸºç±»

```csharp
// åŸºç¡€å¤„ç†å™¨ï¼ˆè‡ªåŠ¨ååºåˆ—åŒ– Protobufï¼‰
public abstract class MessageHandler<TRequest> : IMessageHandler
{
    protected abstract Task HandleAsync(IAppSession session, TRequest request);
}

// éœ€è¦è®¤è¯çš„å¤„ç†å™¨
public abstract class AuthenticatedMessageHandler<TRequest> : MessageHandler<TRequest>
{
    protected abstract Task HandleAuthenticatedAsync(IAppSession session, TRequest request);
}
```

#### ç¤ºä¾‹ï¼šLoginHandler

```csharp
public class LoginHandler : MessageHandler<C2S_Login>
{
    protected override async Task HandleAsync(IAppSession session, C2S_Login request)
    {
        // 1. è°ƒç”¨ AuthService éªŒè¯
        var (success, message, token, user) = await _authService.LoginAsync(...);
        
        // 2. æŸ¥è¯¢è§’è‰²
        var player = await _db.Players.FirstOrDefaultAsync(...);
        
        // 3. è®¾ç½®ä¼šè¯çŠ¶æ€
        var gameData = session.GetGameData();
        gameData.IsAuthenticated = true;
        gameData.UserId = user.Id;
        
        // 4. æ·»åŠ åˆ°åœ¨çº¿ç©å®¶
        _playerManager.AddPlayer(new PlayerState { ... });
        
        // 5. å‘é€å“åº”
        await session.SendMessageAsync(MsgId.Login, response);
    }
}
```

---

### 2.5 æ•°æ®å±‚ï¼ˆDataï¼‰

**èŒè´£**ï¼šæ•°æ®æŒä¹…åŒ–å’Œç¼“å­˜

#### `GameDbContext`ï¼ˆEF Coreï¼‰

```csharp
public class GameDbContext : DbContext
{
    public DbSet<User> Users { get; set; }
    public DbSet<Player> Players { get; set; }
    public DbSet<PlayerItem> PlayerItems { get; set; }
    // ...
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```csharp
// æŸ¥è¯¢
var user = await _db.Users.FirstOrDefaultAsync(u => u.Username == username);

// æ’å…¥
_db.Players.Add(new Player { ... });
await _db.SaveChangesAsync();

// æ›´æ–°
player.Level = 10;
await _db.SaveChangesAsync();
```

#### `RedisService`

å°è£… Redis æ“ä½œï¼š

```csharp
// è®¾ç½®é”®å€¼
await redis.SetAsync("player:1001", playerData, TimeSpan.FromHours(1));

// è·å–é”®å€¼
var data = await redis.GetAsync<PlayerData>("player:1001");

// å‘å¸ƒ/è®¢é˜…
await redis.PublishAsync("chat:world", message);
```

---

## 3. è®¾è®¡æ¨¡å¼åº”ç”¨

### 3.1 åˆ†å±‚æ¶æ„æ¨¡å¼ï¼ˆLayered Architectureï¼‰

```
è¡¨ç°å±‚ï¼ˆHandlersï¼‰
    â†“
ä¸šåŠ¡å±‚ï¼ˆServicesï¼‰
    â†“
æ•°æ®å±‚ï¼ˆDbContext + Redisï¼‰
```

**å¥½å¤„**ï¼š
- èŒè´£æ¸…æ™°
- æ˜“äºæµ‹è¯•
- æ˜“äºç»´æŠ¤

---

### 3.2 ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰

**æ‰€æœ‰æœåŠ¡é€šè¿‡ DI å®¹å™¨ç®¡ç†**ï¼š

```csharp
services.AddSingleton<JwtService>();          // å•ä¾‹
services.AddScoped<AuthService>();            // æ¯æ¬¡è¯·æ±‚åˆ›å»º
services.AddDbContext<GameDbContext>(...);    // EF Core
```

**å¥½å¤„**ï¼š
- è§£è€¦ä¾èµ–
- æ˜“äºå•å…ƒæµ‹è¯•ï¼ˆMockï¼‰
- ç»Ÿä¸€ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

### 3.3 ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**æ¶ˆæ¯å¤„ç†å™¨**å°±æ˜¯ç­–ç•¥æ¨¡å¼ï¼š

```csharp
// ä¸åŒçš„æ¶ˆæ¯ IDï¼Œä½¿ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥
_gateway.RegisterHandler(MsgId.Login, new LoginHandler(...));
_gateway.RegisterHandler(MsgId.Register, new RegisterHandler(...));
```

**å¥½å¤„**ï¼š
- æ˜“äºæ‰©å±•æ–°æ¶ˆæ¯
- ç¬¦åˆå¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰

---

### 3.4 æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Methodï¼‰

`MessageHandler<TRequest>` ä½¿ç”¨æ¨¡æ¿æ–¹æ³•ï¼š

```csharp
public async Task HandleAsync(IAppSession session, ReadOnlyMemory<byte> payload)
{
    // 1. ååºåˆ—åŒ– Protobufï¼ˆæ¨¡æ¿å›ºå®šæµç¨‹ï¼‰
    var request = Parser.ParseFrom(payload.Span);
    
    // 2. è°ƒç”¨å­ç±»å®ç°ï¼ˆå­ç±»è‡ªå®šä¹‰ï¼‰
    await HandleAsync(session, request);
}
```

---

### 3.5 å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

**DI å®¹å™¨æœ¬èº«å°±æ˜¯å·¥å‚**ï¼š

```csharp
var handler = scope.ServiceProvider.GetRequiredService<LoginHandler>();
```

---

### 3.6 è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰

**ä¼šè¯äº‹ä»¶**ï¼š

```csharp
hostBuilder.UseSessionHandler(
    onConnected: session => { ... },   // è¿æ¥äº‹ä»¶
    onClosed: (session, reason) => { ... }  // æ–­å¼€äº‹ä»¶
);
```

---

## 4. æ¶ˆæ¯å¤„ç†æµç¨‹

### 4.1 å®Œæ•´æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant SS as SuperSocket
    participant Filter as GamePackageFilter
    participant Gateway as MessageGateway
    participant Handler as LoginHandler
    participant AuthService as AuthService
    participant DB as MySQL
    participant Redis as Redis
    
    Client->>SS: å‘é€TCPæ•°æ®æµ
    SS->>Filter: å­—èŠ‚æµ
    Filter->>Filter: ç²˜åŒ…/æ‹†åŒ…å¤„ç†
    Filter->>Gateway: GamePackage
    Gateway->>Gateway: éªŒè¯åºåˆ—å·
    Gateway->>Handler: è·¯ç”±åˆ°å¤„ç†å™¨
    Handler->>AuthService: è°ƒç”¨ä¸šåŠ¡é€»è¾‘
    AuthService->>DB: æŸ¥è¯¢ç”¨æˆ·
    DB-->>AuthService: è¿”å›ç”¨æˆ·
    AuthService->>Redis: å­˜å‚¨ Token
    Redis-->>AuthService: ç¡®è®¤
    AuthService-->>Handler: è¿”å›ç»“æœ
    Handler->>Client: å‘é€å“åº”ï¼ˆProtobufï¼‰
```

### 4.2 è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤ 1ï¼šå®¢æˆ·ç«¯è¿æ¥

```csharp
// SuperSocket è‡ªåŠ¨æ¥å—è¿æ¥
onConnected: session => {
    Metrics.ActiveConnections.Inc();
    Log.Information("å®¢æˆ·ç«¯è¿æ¥: {SessionId}", session.SessionID);
}
```

#### æ­¥éª¤ 2ï¼šæ¥æ”¶æ•°æ®æµ

SuperSocket æŒç»­è¯»å– TCP æ•°æ®æµã€‚

#### æ­¥éª¤ 3ï¼šç²˜åŒ…/æ‹†åŒ…

`GamePackageFilter` å¤„ç†ï¼š

```csharp
protected override int GetBodyLengthFromHeader(ref ReadOnlySequence<byte> buffer)
{
    // è¯»å–å‰4å­—èŠ‚ï¼ˆæ€»é•¿åº¦ï¼‰
    reader.TryReadLittleEndian(out int totalLength);
    return totalLength - GamePackage.HeaderSize;
}
```

#### æ­¥éª¤ 4ï¼šè·¯ç”±æ¶ˆæ¯

`MessageGateway.RouteMessageAsync`ï¼š

```csharp
// 1. éªŒè¯åºåˆ—å·
if (!gameData.ValidateSequence(package.Sequence)) return;

// 2. æŸ¥æ‰¾å¤„ç†å™¨
if (!_handlers.TryGetValue(package.MsgId, out var handler)) return;

// 3. æ‰§è¡Œå¤„ç†å™¨
await handler.HandleAsync(session, package.Payload);
```

#### æ­¥éª¤ 5ï¼šä¸šåŠ¡å¤„ç†

`LoginHandler` ç¤ºä¾‹ï¼š

```csharp
// 1. éªŒè¯ç”¨æˆ·åå¯†ç ï¼ˆBCryptï¼‰
var user = await _db.Users.FirstOrDefaultAsync(...);
bool valid = BCrypt.Net.BCrypt.Verify(password, user.PasswordHash);

// 2. ç”Ÿæˆ JWT Token
string token = _jwtService.GenerateToken(user.Id, user.Username);

// 3. æŸ¥è¯¢è§’è‰²
var player = await _db.Players.FirstOrDefaultAsync(...);

// 4. è®¾ç½®ä¼šè¯çŠ¶æ€
gameData.IsAuthenticated = true;
gameData.UserId = user.Id;

// 5. æ·»åŠ åˆ°åœ¨çº¿ç©å®¶
_playerManager.AddPlayer(new PlayerState { ... });
```

#### æ­¥éª¤ 6ï¼šå‘é€å“åº”

```csharp
await session.SendMessageAsync(MsgId.Login, new S2C_Login
{
    Code = (int)ErrorCode.Success,
    Token = token,
    Player = playerInfo
});
```

å†…éƒ¨å®ç°ï¼š

```csharp
// 1. åºåˆ—åŒ– Protobuf
byte[] payload = message.ToByteArray();

// 2. æ„å»ºåŒ…å¤´
byte[] buffer = new byte[HeaderSize + payload.Length];
BitConverter.TryWriteBytes(buffer.AsSpan(0, 4), totalLength);  // Length
BitConverter.TryWriteBytes(buffer.AsSpan(4, 2), msgId);        // MsgId
BitConverter.TryWriteBytes(buffer.AsSpan(6, 4), 0u);           // Sequence

// 3. å‘é€
await session.SendAsync(new ReadOnlyMemory<byte>(buffer));
```

---

## 5. æ ¸å¿ƒæ¦‚å¿µè§£é‡Š

### 5.1 ä»€ä¹ˆæ˜¯ç²˜åŒ…/æ‹†åŒ…ï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼š

```
å‘é€ï¼š[åŒ…A:100å­—èŠ‚] [åŒ…B:200å­—èŠ‚]
```

å¯èƒ½æ”¶åˆ°ï¼š

```
ç²˜åŒ…ï¼š[åŒ…A+åŒ…B:300å­—èŠ‚]           â† ä¸¤ä¸ªåŒ…ç²˜åœ¨ä¸€èµ·
æ‹†åŒ…ï¼š[åŒ…Aå‰50å­—èŠ‚] [åŒ…Aå50å­—èŠ‚]  â† ä¸€ä¸ªåŒ…è¢«æ‹†å¼€
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

ä½¿ç”¨å›ºå®šå¤´éƒ¨é•¿åº¦å­—æ®µï¼š

```
+------------+--------+
| Length: 4  | Payload |
+------------+--------+
```

1. å…ˆè¯»å– 4 å­—èŠ‚çš„é•¿åº¦å­—æ®µ
2. æ ¹æ®é•¿åº¦è¯»å–å¯¹åº”å­—èŠ‚æ•°
3. ä¿è¯è¯»å–å®Œæ•´åŒ…

---

### 5.2 ä»€ä¹ˆæ˜¯åºåˆ—å·ï¼ˆSequenceï¼‰ï¼Ÿ

**é˜²æ­¢é‡æ”¾æ”»å‡»**ï¼š

```
æ”»å‡»è€…ï¼šæˆªè· "è½¬è´¦100å…ƒ" çš„åŒ…
æ”»å‡»è€…ï¼šé‡å¤å‘é€10æ¬¡ â†’ è½¬è´¦1000å…ƒï¼
```

**é˜²å¾¡æ–¹æ¡ˆ**ï¼š

æ¯ä¸ªåŒ…å¸¦åºåˆ—å·ï¼ŒæœåŠ¡å™¨è®°å½•æœ€åä¸€ä¸ªåºåˆ—å·ï¼š

```csharp
public bool ValidateSequence(uint sequence)
{
    if (sequence <= LastSequence)
        return false;  // é‡æ”¾æ”»å‡»ï¼
    LastSequence = sequence;
    return true;
}
```

---

### 5.3 ä»€ä¹ˆæ˜¯ JWTï¼Ÿ

**JWTï¼ˆJSON Web Tokenï¼‰** æ˜¯æ— çŠ¶æ€è®¤è¯æ–¹æ¡ˆã€‚

**ä¼ ç»Ÿ Session æ–¹å¼**ï¼š

```
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šç”¨æˆ·å+å¯†ç 
æœåŠ¡å™¨ï¼šåœ¨å†…å­˜å­˜å‚¨ SessionId â†’ UserId
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šè¿”å› SessionId

åç»­è¯·æ±‚ï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šå¸¦ SessionId
æœåŠ¡å™¨ï¼šæŸ¥å†…å­˜è·å– UserId
```

**é—®é¢˜**ï¼š
- æœåŠ¡å™¨éœ€è¦å­˜å‚¨æ‰€æœ‰ Sessionï¼ˆå å†…å­˜ï¼‰
- åˆ†å¸ƒå¼éƒ¨ç½²å›°éš¾ï¼ˆSession å…±äº«ï¼‰

**JWT æ–¹å¼**ï¼š

```
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šç”¨æˆ·å+å¯†ç 
æœåŠ¡å™¨ï¼šç”Ÿæˆ Tokenï¼ˆåŒ…å« UserIdï¼ŒåŠ å¯†ç­¾åï¼‰
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šè¿”å› Token

åç»­è¯·æ±‚ï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šå¸¦ Token
æœåŠ¡å™¨ï¼šéªŒè¯ç­¾åï¼Œè§£æå‡º UserId
```

**ä¼˜ç‚¹**ï¼š
- æ— çŠ¶æ€ï¼ˆæœåŠ¡å™¨ä¸å­˜å‚¨ï¼‰
- æ˜“äºæ‰©å±•ï¼ˆå¤šå°æœåŠ¡å™¨å…±ç”¨å¯†é’¥ï¼‰

**JWT ç»“æ„**ï¼š

```
Header.Payload.Signature
```

```json
// Header
{
  "alg": "HS256",
  "typ": "JWT"
}

// Payload
{
  "userId": 1001,
  "username": "player1",
  "exp": 1733647200
}

// Signature = HMAC-SHA256(Header + Payload, SecretKey)
```

---

### 5.4 ä»€ä¹ˆæ˜¯ BCryptï¼Ÿ

**BCrypt** æ˜¯å¯†ç å“ˆå¸Œç®—æ³•ï¼ˆå•å‘åŠ å¯†ï¼‰ã€‚

**ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥å­˜å‚¨æ˜æ–‡å¯†ç ï¼Ÿ**

```
æ•°æ®åº“æ³„éœ² â†’ æ‰€æœ‰ç”¨æˆ·å¯†ç æš´éœ² â†’ æ’åº“æ”»å‡»
```

**ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ MD5/SHA256ï¼Ÿ**

```
å½©è™¹è¡¨æ”»å‡»ï¼šé¢„è®¡ç®—å¸¸è§å¯†ç çš„ MD5 å€¼
123456 â†’ e10adc3949ba59abbe56e057f20f883e
```

**BCrypt çš„ä¼˜åŠ¿**ï¼š

1. **è‡ªåŠ¨åŠ ç›**ï¼šæ¯æ¬¡å“ˆå¸Œç»“æœä¸åŒ
2. **æ…¢é€Ÿç®—æ³•**ï¼šæš´åŠ›ç ´è§£æˆæœ¬é«˜
3. **å¯è°ƒèŠ‚æˆæœ¬**ï¼šéšç¡¬ä»¶å‡çº§è°ƒæ•´éš¾åº¦

```csharp
// æ³¨å†Œæ—¶
string hash = BCrypt.Net.BCrypt.HashPassword(password);
// å­˜å‚¨ hash åˆ°æ•°æ®åº“

// ç™»å½•æ—¶
bool valid = BCrypt.Net.BCrypt.Verify(password, hash);
```

---

## 6. å¦‚ä½•æµ‹è¯•

### 6.1 å•å…ƒæµ‹è¯•

#### æµ‹è¯•ä¸šåŠ¡é€»è¾‘ï¼ˆAuthServiceï¼‰

```csharp
[Fact]
public async Task RegisterAsync_ShouldCreateUser()
{
    // Arrange
    var dbContext = CreateInMemoryDbContext();
    var authService = new AuthService(dbContext, logger, jwtService);
    
    // Act
    var (success, message) = await authService.RegisterAsync(
        "testuser", "password123", "test@example.com");
    
    // Assert
    Assert.True(success);
    var user = await dbContext.Users.FirstOrDefaultAsync(u => u.Username == "testuser");
    Assert.NotNull(user);
}
```

#### æµ‹è¯•æ¶ˆæ¯å¤„ç†å™¨ï¼ˆLoginHandlerï¼‰

```csharp
[Fact]
public async Task LoginHandler_ShouldAuthenticateUser()
{
    // Arrange
    var mockSession = new Mock<IAppSession>();
    var handler = new LoginHandler(logger, authService, db, playerManager);
    var request = new C2S_Login { Username = "user1", Password = "pass123" };
    
    // Act
    await handler.HandleAsync(mockSession.Object, request);
    
    // Assert
    mockSession.Verify(s => s.SendAsync(It.IsAny<ReadOnlyMemory<byte>>()), Times.Once);
}
```

---

### 6.2 é›†æˆæµ‹è¯•

#### æµ‹è¯•å®Œæ•´ç™»å½•æµç¨‹

```csharp
[Fact]
public async Task Integration_LoginFlow()
{
    // 1. å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
    var host = CreateTestHost();
    await host.StartAsync();
    
    // 2. è¿æ¥å®¢æˆ·ç«¯
    var client = new TcpClient();
    await client.ConnectAsync("127.0.0.1", 33333);
    
    // 3. å‘é€ç™»å½•è¯·æ±‚
    var request = new C2S_Login { Username = "test", Password = "123456" };
    await SendPackageAsync(client, MsgId.Login, request);
    
    // 4. æ¥æ”¶å“åº”
    var response = await ReceivePackageAsync<S2C_Login>(client);
    
    // 5. éªŒè¯
    Assert.Equal((int)ErrorCode.Success, response.Code);
    Assert.NotEmpty(response.Token);
}
```

---

### 6.3 å‹åŠ›æµ‹è¯•

ä½¿ç”¨å·¥å…·æ¨¡æ‹Ÿå¤§é‡å¹¶å‘è¿æ¥ï¼š

```bash
# ä½¿ç”¨ k6 è¿›è¡Œå‹åŠ›æµ‹è¯•
k6 run --vus 1000 --duration 30s load_test.js
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- æ´»è·ƒè¿æ¥æ•°ï¼š`Metrics.ActiveConnections`
- æ¶ˆæ¯å¤„ç†é€Ÿåº¦ï¼š`Metrics.MessageCount`
- é”™è¯¯ç‡ï¼š`Metrics.MessageErrors`

---

### 6.4 æ‰‹åŠ¨æµ‹è¯•å·¥å…·

#### ä½¿ç”¨ Telnet æµ‹è¯•ï¼ˆä»…é™æ–‡æœ¬åè®®ï¼‰

```bash
telnet localhost 33333
```

#### ä½¿ç”¨è‡ªå®šä¹‰å®¢æˆ·ç«¯

åˆ›å»ºç®€å•çš„æ§åˆ¶å°å®¢æˆ·ç«¯ï¼š

```csharp
class Program
{
    static async Task Main()
    {
        var client = new TcpClient();
        await client.ConnectAsync("127.0.0.1", 33333);
        var stream = client.GetStream();
        
        // å‘é€ç™»å½•è¯·æ±‚
        var request = new C2S_Login { Username = "test", Password = "123456" };
        await SendAsync(stream, MsgId.Login, request);
        
        // æ¥æ”¶å“åº”
        var response = await ReceiveAsync<S2C_Login>(stream);
        Console.WriteLine($"ç™»å½•ç»“æœ: {response.Message}");
    }
}
```

---

## 7. æ‰©å±•å¼€å‘æŒ‡å—

### 7.1 å¦‚ä½•æ·»åŠ æ–°çš„æ¶ˆæ¯ï¼Ÿ

#### æ­¥éª¤ 1ï¼šå®šä¹‰ Protobuf æ¶ˆæ¯

ç¼–è¾‘ `Protos/common.proto`ï¼š

```protobuf
// è¯·æ±‚
message C2S_GetPlayerInfo {
  int64 player_id = 1;
}

// å“åº”
message S2C_GetPlayerInfo {
  int32 code = 1;
  string message = 2;
  PlayerInfo player = 3;
}
```

#### æ­¥éª¤ 2ï¼šæ·»åŠ æ¶ˆæ¯ ID

ç¼–è¾‘ `Network/MsgId.cs`ï¼š

```csharp
public const ushort GetPlayerInfo = 0x1010;
```

#### æ­¥éª¤ 3ï¼šåˆ›å»ºå¤„ç†å™¨

åˆ›å»º `Handlers/PlayerHandlers.cs`ï¼š

```csharp
public class GetPlayerInfoHandler : AuthenticatedMessageHandler<C2S_GetPlayerInfo>
{
    private readonly GameDbContext _db;
    
    public GetPlayerInfoHandler(GameDbContext db)
    {
        _db = db;
    }
    
    protected override async Task HandleAuthenticatedAsync(
        IAppSession session, C2S_GetPlayerInfo request)
    {
        var player = await _db.Players.FindAsync(request.PlayerId);
        
        await session.SendMessageAsync(MsgId.GetPlayerInfo, new S2C_GetPlayerInfo
        {
            Code = player != null ? (int)ErrorCode.Success : (int)ErrorCode.NotFound,
            Player = player?.ToProto()
        });
    }
}
```

#### æ­¥éª¤ 4ï¼šæ³¨å†Œå¤„ç†å™¨

ç¼–è¾‘ `Program.cs`ï¼š

```csharp
// ConfigureServices
services.AddScoped<GetPlayerInfoHandler>();

// MessageHandlerRegistration.StartAsync
_gateway.RegisterHandler(MsgId.GetPlayerInfo, 
    scope.ServiceProvider.GetRequiredService<GetPlayerInfoHandler>());
```

#### æ­¥éª¤ 5ï¼šç¼–è¯‘æµ‹è¯•

```bash
dotnet build
dotnet run
```

---

### 7.2 å¦‚ä½•æ·»åŠ æ–°çš„ä¸šåŠ¡æœåŠ¡ï¼Ÿ

#### åˆ›å»º `ItemService.cs`

```csharp
public class ItemService
{
    private readonly GameDbContext _db;
    private readonly ILogger<ItemService> _logger;
    
    public ItemService(GameDbContext db, ILogger<ItemService> logger)
    {
        _db = db;
        _logger = logger;
    }
    
    public async Task<bool> AddItemToPlayerAsync(long playerId, int itemId, int count)
    {
        var playerItem = await _db.PlayerItems
            .FirstOrDefaultAsync(pi => pi.PlayerId == playerId && pi.ItemId == itemId);
        
        if (playerItem == null)
        {
            _db.PlayerItems.Add(new PlayerItem
            {
                PlayerId = playerId,
                ItemId = itemId,
                Count = count
            });
        }
        else
        {
            playerItem.Count += count;
        }
        
        await _db.SaveChangesAsync();
        return true;
    }
}
```

#### æ³¨å†ŒæœåŠ¡

```csharp
services.AddScoped<ItemService>();
```

---

### 7.3 å¦‚ä½•ä½¿ç”¨ Redis ç¼“å­˜ï¼Ÿ

#### ç¼“å­˜ç©å®¶æ•°æ®

```csharp
public class PlayerService
{
    private readonly RedisService _redis;
    private readonly GameDbContext _db;
    
    public async Task<Player?> GetPlayerAsync(long playerId)
    {
        // 1. å°è¯•ä» Redis è·å–
        var cacheKey = $"player:{playerId}";
        var cached = await _redis.GetAsync<Player>(cacheKey);
        if (cached != null)
            return cached;
        
        // 2. ä»æ•°æ®åº“æŸ¥è¯¢
        var player = await _db.Players.FindAsync(playerId);
        
        // 3. å†™å…¥ç¼“å­˜ï¼ˆ1å°æ—¶è¿‡æœŸï¼‰
        if (player != null)
            await _redis.SetAsync(cacheKey, player, TimeSpan.FromHours(1));
        
        return player;
    }
}
```

---

### 7.4 å¦‚ä½•æ·»åŠ ç›‘æ§æŒ‡æ ‡ï¼Ÿ

#### å®šä¹‰æŒ‡æ ‡

ç¼–è¾‘ `Infrastructure/Metrics.cs`ï¼š

```csharp
public static readonly Counter ItemPickupCount = Prometheus.Metrics.CreateCounter(
    "game_item_pickup_total",
    "ç‰©å“æ‹¾å–æ¬¡æ•°",
    new CounterConfiguration
    {
        LabelNames = new[] { "item_id" }
    });
```

#### ä½¿ç”¨æŒ‡æ ‡

```csharp
public async Task PickupItemAsync(int itemId)
{
    // ä¸šåŠ¡é€»è¾‘
    await _itemService.AddItemToPlayerAsync(playerId, itemId, 1);
    
    // è®°å½•æŒ‡æ ‡
    Metrics.ItemPickupCount.WithLabels(itemId.ToString()).Inc();
}
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **åˆ†å±‚æ¶æ„**ï¼šç½‘ç»œå±‚ â†’ å¤„ç†å™¨å±‚ â†’ ä¸šåŠ¡å±‚ â†’ æ•°æ®å±‚
2. **ä¾èµ–æ³¨å…¥**ï¼šæ‰€æœ‰æœåŠ¡é€šè¿‡ DI ç®¡ç†
3. **Protobuf**ï¼šé«˜æ•ˆçš„äºŒè¿›åˆ¶åºåˆ—åŒ–
4. **SuperSocket**ï¼šå¤„ç† TCP è¿æ¥å’Œç²˜åŒ…/æ‹†åŒ…
5. **JWT + BCrypt**ï¼šå®‰å…¨çš„è®¤è¯æ–¹æ¡ˆ

### å­¦ä¹ å»ºè®®

1. **ä»æµç¨‹å…¥æ‰‹**ï¼šè·Ÿè¸ªä¸€ä¸ªç™»å½•è¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
2. **é˜…è¯»æºç **ï¼šé€ä¸ªç±»é˜…è¯»ï¼Œç†è§£èŒè´£
3. **åŠ¨æ‰‹å®è·µ**ï¼šæ·»åŠ æ–°æ¶ˆæ¯ã€æ–°åŠŸèƒ½
4. **ç›‘æ§æ—¥å¿—**ï¼šè§‚å¯Ÿè¿è¡Œæ—¶è¡Œä¸º

### è¿›é˜¶ä¸»é¢˜

- åˆ†å¸ƒå¼éƒ¨ç½²ï¼ˆå¤šå°æœåŠ¡å™¨ï¼‰
- çƒ­æ›´æ–°ï¼ˆä¸åœæœæ›´æ–°ï¼‰
- æˆ˜æ–—åŒæ­¥ï¼ˆå¸§åŒæ­¥/çŠ¶æ€åŒæ­¥ï¼‰
- æ•°æ®åº“ä¼˜åŒ–ï¼ˆç´¢å¼•ã€åˆ†è¡¨ï¼‰
- å®‰å…¨åŠ å›ºï¼ˆDDoS é˜²æŠ¤ã€åä½œå¼Šï¼‰

---

**ç¥å­¦ä¹ æ„‰å¿«ï¼** ğŸš€
