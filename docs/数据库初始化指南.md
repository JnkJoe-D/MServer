# MySQL 数据库初始化指南

## 问题诊断

**错误信息**：`Table 'gameserver.users' doesn't exist`

**根本原因**：数据库表还未创建。

---

## 解决方案

### 方案 1：使用现有 SQL 脚本初始化（推荐）

#### 步骤 1：修改数据库名称

**选项 A**：修改 SQL 脚本中的数据库名（推荐）

编辑 `sql/init.sql`，将 `game` 改为 `gameserver`：

```sql
-- 第 7 行
CREATE DATABASE IF NOT EXISTS `gameserver` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE `gameserver`;
```

**选项 B**：修改配置文件中的数据库名

编辑 `appsettings.json`：

```json
{
  "Database": {
    "ConnectionString": "Server=127.0.0.1;Port=23333;Database=game;..."
  }
}
```

#### 步骤 2：执行 SQL 脚本

**方式 A：使用 MySQL 命令行**

```bash
# 登录 MySQL
mysql -h 127.0.0.1 -P 23333 -u GameServer -p

# 执行脚本
source D:/DesKtop/Project/MServer/sql/init.sql

# 或一行命令
mysql -h 127.0.0.1 -P 23333 -u GameServer -p < D:/DesKtop/Project/MServer/sql/init.sql
```

**方式 B：使用宝塔面板**

1. 登录宝塔面板
2. 数据库 → phpMyAdmin
3. 选择数据库（或新建）
4. 导入 → 选择 `sql/init.sql`
5. 执行

**方式 C：使用 Navicat/MySQL Workbench**

1. 连接到数据库
2. 文件 → 打开SQL文件
3. 选择 `sql/init.sql`
4. 运行脚本

#### 步骤 3：验证

```sql
USE gameserver;  -- 或 game
SHOW TABLES;
-- 应该显示：users, players, player_items 等 8 个表

SELECT COUNT(*) FROM users;
-- 应该显示：1（测试用户）
```

---

### 方案 2：使用 EF Core 迁移（高级）

如果您熟悉 EF Core，可以使用迁移自动创建表。

#### 1. 安装 EF Core 工具

```bash
dotnet tool install --global dotnet-ef
```

#### 2. 创建迁移

```bash
cd D:\DesKtop\Project\MServer
dotnet ef migrations add InitialCreate
```

#### 3. 应用迁移

```bash
dotnet ef database update
```

---

## 推荐步骤（最简单）

### 1. 修改 SQL 脚本

```sql
-- sql/init.sql 第 7 行
CREATE DATABASE IF NOT EXISTS `gameserver` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE `gameserver`;
```

### 2. 执行脚本

```bash
# Windows PowerShell
Get-Content "D:\DesKtop\Project\MServer\sql\init.sql" | mysql -h 127.0.0.1 -P 23333 -u GameServer -p
```

### 3. 重新运行程序

```bash
dotnet run
```

**预期日志**：

```log
[时间 INF] 测试 MySQL 连接...
[时间 INF] ✅ MySQL 连接成功！当前用户数: 1
```

---

## 测试用户

SQL 脚本会创建一个测试用户：

| 字段 | 值 |
|------|-----|
| 用户名 | `test` |
| 邮箱 | `test@test.com` |
| 密码 | `12345678` |

---

## 常见问题

### Q1: 执行 SQL 时提示权限不足

**错误**：`Access denied for user 'GameServer'@'%' to database 'gameserver'`

**解决**：

```sql
-- 使用 root 用户登录
mysql -u root -p

-- 授权
GRANT ALL PRIVILEGES ON gameserver.* TO 'GameServer'@'%';
FLUSH PRIVILEGES;
```

### Q2: 表已存在但依然报错

**检查数据库名称**：

```sql
-- 查看所有数据库
SHOW DATABASES;

-- 查看当前使用的数据库
SELECT DATABASE();

-- 查看 users 表在哪个数据库
SELECT TABLE_SCHEMA, TABLE_NAME 
FROM information_schema.TABLES 
WHERE TABLE_NAME = 'users';
```

### Q3: 生产环境数据库初始化

**不要直接执行 init.sql**，因为它会插入测试数据。

建议：

1. 只执行建表部分（去掉最后的 INSERT）
2. 或使用 EF Core 迁移

---

## 完整的初始化脚本（修正版）

如果需要，我可以创建一个修正版本的 init.sql，自动使用配置文件中的数据库名。
