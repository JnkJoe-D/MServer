# .NETæœåŠ¡å™¨æ¡†æ¶çš„é€šç”¨æµç¨‹ï¼Ÿä»¥åŠæ˜¯å¦æœ‰å…¶ä»–è¡¥å……ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„é—®é¢˜ï¼ä½ å·²ç»ä»å…·ä½“çš„ä»£ç å®ç°ï¼Œä¸Šå‡åˆ°äº†å¯¹æ¡†æ¶è®¾è®¡æ¨¡å¼çš„æ€è€ƒã€‚**æ˜¯çš„ï¼Œ.NETçš„ç°ä»£æœåŠ¡å™¨æ¡†æ¶ï¼ˆASP.NET Core, gRPC, SignalRï¼ŒåŒ…æ‹¬ä½ ç”¨çš„SuperSocketï¼‰éƒ½éµå¾ªä¸€ä¸ªé«˜åº¦ç›¸ä¼¼çš„æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡å“²å­¦ã€‚** ä½ çš„æ¸¸æˆæœåŠ¡å™¨é¡¹ç›®æ­£æ˜¯è¿™ä¸€å¥—â€œæ ‡å‡†é…æ–¹â€çš„ç»ä½³å®è·µã€‚

### ğŸ—ºï¸ .NET æœåŠ¡å™¨æ¡†æ¶çš„é€šç”¨æµç¨‹ (â€œæ ‡å‡†é…æ–¹â€)

ä¸‹é¢çš„æµç¨‹å›¾æ¦‚æ‹¬äº†å‡ ä¹æ‰€æœ‰ .NET æœåŠ¡å™¨åº”ç”¨çš„**æ ‡å‡†æ„å»ºä¸è¿è¡Œæµç¨‹**ï¼Œä½ å¯ä»¥å¯¹ç…§ä½ çš„ä»£ç ä¸€ä¸€å¯¹åº”ï¼š

![deepseek_mermaid_20260208_fd2f88](png\deepseek_mermaid_20260208_fd2f88.png)

```c#
flowchart TD
    A[â€œåˆ›å»º HostBuilderâ€] --> B[â€œé…ç½®å±‚ (Configuration)â€]
    B --> C[â€œæœåŠ¡æ³¨å†Œå±‚ (Dependency Injection)â€]
    C --> D[â€œä¸­é—´ä»¶/å¤„ç†ç®¡çº¿å±‚ (Middleware/Pipeline)â€]
    D --> E[â€œæ„å»º (Build)â€]
    E --> F[â€œè¿è¡Œ (Run)â€]

    subgraph B
        B1[è®¾ç½®åŸºç¡€è·¯å¾„]
        B2[åŠ è½½JSONé…ç½®æ–‡ä»¶]
        B3[åŠ è½½ç¯å¢ƒå˜é‡]
    end

    subgraph C
        C1[æ³¨å†Œæ•°æ®åº“ä¸Šä¸‹æ–‡]
        C2[æ³¨å†Œä¸šåŠ¡æœåŠ¡<br>ï¼ˆSingleton/Scoped/Transientï¼‰]
        C3[æ³¨å†Œåå°æœåŠ¡<br>ï¼ˆIHostedServiceï¼‰]
    end

    subgraph D
        D1[æ³¨å†Œä¸­é—´ä»¶<br>ï¼ˆå¦‚å¼‚å¸¸å¤„ç†ã€é™æ€æ–‡ä»¶ï¼‰]
        D2[æ³¨å†Œç«¯ç‚¹/å¤„ç†å™¨<br>ï¼ˆå¦‚Controllerã€æ¶ˆæ¯ç½‘å…³ï¼‰]
    end
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°†ä½ çš„é¡¹ç›®æ˜ å°„åˆ°è¿™ä¸ªé€šç”¨æµç¨‹ä¸­ï¼š

| é˜¶æ®µ                   | é€šç”¨æ¨¡å¼                                                     | ä½ çš„æ¸¸æˆæœåŠ¡å™¨å®ç°                                           |
| :--------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **1. åˆ›å»ºæ„å»ºå™¨**      | `Host.CreateDefaultBuilder()` æˆ–æ¡†æ¶ç‰¹å®šçš„ `Builder`         | `SuperSocketHostBuilder.Create<GamePackage, GamePackageFilter>()` |
| **2. é…ç½®**            | åŠ è½½ `appsettings.json`ã€ç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°ç­‰ã€‚            | `hostBuilder.ConfigureAppConfiguration(...)`                 |
| **3. æœåŠ¡æ³¨å†Œ**        | åœ¨ `ConfigureServices` ä¸­ï¼Œé€šè¿‡ `IServiceCollection` æ³¨å†Œæ‰€æœ‰ä¾èµ–ã€‚ | `hostBuilder.ConfigureServices(...)` æ³¨å†Œäº† `DbContext`, `JwtService`, `MessageGateway` ç­‰ã€‚ |
| **4. ä¸­é—´ä»¶/ç®¡çº¿é…ç½®** | é…ç½®è¯·æ±‚å¤„ç†ç®¡é“ï¼ˆASP.NET Core çš„ `UseRouting`, `UseEndpoints`ï¼‰æˆ–æ¶ˆæ¯å¤„ç†ç®¡çº¿ã€‚ | `hostBuilder.UsePackageHandler(...)` å’Œ `hostBuilder.UseSessionHandler(...)` æ„æˆäº†ä½ çš„ç½‘ç»œå¤„ç†ç®¡çº¿ã€‚ |
| **5. æ„å»ºä¸è¿è¡Œ**      | è°ƒç”¨ `Build()` å’Œ `RunAsync()`ã€‚                             | `var host = hostBuilder.Build(); await host.RunAsync();`     |

### ğŸ§© æ ¸å¿ƒè®¾è®¡å“²å­¦çš„è¡¥å……

é™¤äº†æµç¨‹ï¼Œå®ƒä»¬è¿˜å…±äº«ä»¥ä¸‹æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼Œä½ çš„é¡¹ç›®åŒæ ·ä½“ç°äº†è¿™äº›æ€æƒ³ï¼š

1.  **ä¾èµ–æ³¨å…¥**ï¼šè¿™æ˜¯æ‰€æœ‰ç°ä»£ .NET åº”ç”¨çš„åŸºçŸ³ã€‚æ¡†æ¶æœ¬èº«é‡åº¦ä½¿ç”¨DIæ¥æä¾›çµæ´»æ€§ï¼Œå¹¶è¦æ±‚/é¼“åŠ±å¼€å‘è€…åŒæ ·ä½¿ç”¨ã€‚ä½ çš„ `JwtService`ã€`MessageGateway` ç­‰å°±æ˜¯æœ€ä½³å®è·µã€‚

2.  **ä¸­é—´ä»¶ç®¡é“**ï¼šæ— è®ºæ˜¯HTTPè¯·æ±‚è¿˜æ˜¯SocketåŒ…ï¼Œå¤„ç†è¿‡ç¨‹éƒ½è¢«å»ºæ¨¡ä¸ºä¸€ä¸ª**ç®¡é“**ã€‚æ¯ä¸ªä¸­é—´ä»¶ç»„ä»¶è´Ÿè´£ä¸€é¡¹å…·ä½“å·¥ä½œï¼ˆå¦‚è®¤è¯ã€æ—¥å¿—ã€è·¯ç”±ï¼‰ï¼Œå¹¶å†³å®šæ˜¯å¦å°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªç»„ä»¶ã€‚ä½ çš„ `UsePackageHandler` å°±æ˜¯ç®¡é“çš„ç»ˆç‚¹å¤„ç†å™¨ã€‚

3.  **é…ç½®é©±åŠ¨**ï¼šä¸€åˆ‡å¯å˜çš„å‚æ•°éƒ½åº”ä»é…ç½®ç³»ç»Ÿè¯»å–ï¼Œå®ç°**æ„å»ºä¸€æ¬¡ï¼Œå¤šå¤„éƒ¨ç½²**ã€‚ä½ å·²ç»å°†æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€JWTå¯†é’¥ç­‰å¤–éƒ¨åŒ–ã€‚

4.  **æ—¥å¿—æŠ½è±¡**ï¼šæ¡†æ¶æä¾›äº† `ILogger` æŠ½è±¡ï¼Œè®©ä½ å¯ä»¥è½»æ¾æ›¿æ¢æ—¥å¿—å®ç°ï¼ˆå¦‚ä»æ§åˆ¶å°åˆ‡æ¢åˆ°Serilogæˆ–æ–‡ä»¶ï¼‰ã€‚ä½ ä½¿ç”¨çš„ `UseSerilog()` æ­£æ˜¯è¿™ä¸€ç‚¹çš„ä½“ç°ã€‚

5.  **å®¿ä¸»æ¨¡å‹**ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½è¢«åŒ…è£…åœ¨ä¸€ä¸ªç»Ÿä¸€çš„ **â€œå®¿ä¸»â€** ä¸­è¿è¡Œï¼Œè¿™ä¸ªå®¿ä¸»ç®¡ç†ç€ç”Ÿå‘½å‘¨æœŸã€é…ç½®ã€æ—¥å¿—å’Œä¾èµ–æ³¨å…¥å®¹å™¨ã€‚ä½ çš„ `host` å˜é‡å°±æ˜¯è¿™ä¸ªå®¿ä¸»ã€‚

### ğŸ”„ ä¸åŒæ¡†æ¶çš„â€œé£å‘³â€è¡¥å……

åœ¨é€šç”¨æµç¨‹ä¹‹ä¸Šï¼Œä¸åŒæ¡†æ¶ä¼šåŠ å…¥è‡ªå·±ç‰¹æœ‰çš„â€œè°ƒæ–™â€ï¼š

| æ¡†æ¶ç±»å‹                   | ç‰¹æœ‰â€œè°ƒæ–™â€                                                   | å¯¹åº”ä½ çš„æ¸¸æˆæœåŠ¡å™¨ä¸­çš„æ¦‚å¿µ                                   |
| :------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **ASP.NET Core (Web API)** | MVCæ¨¡å¼ï¼ˆController, Actionï¼‰ã€RESTfulè·¯ç”±ã€HTTPåè®®ç‰¹å®šå¤„ç†ï¼ˆCookieã€CORSï¼‰ã€‚ | ä½ çš„ `MessageGateway` + `IMessageHandler` å…±åŒä½œç”¨ï¼Œ**æœ¬è´¨ä¸Šå®ç°äº†ç±»ä¼¼MVCçš„â€œè·¯ç”±åˆ°åŠ¨ä½œâ€æ¨¡å¼**ï¼Œåªä¸è¿‡æ¶ˆæ¯IDå¯¹åº”è·¯ç”±ï¼Œå¤„ç†å™¨å¯¹åº”Controllerã€‚ |
| **gRPC**                   | åŸºäº `.proto` æ–‡ä»¶çš„å¼ºç±»å‹æœåŠ¡å¥‘çº¦ã€æµå¼è°ƒç”¨ã€‚               | ä½ çš„ `GamePackage` å’Œ `GamePackageFilter` æ‰¿æ‹…äº†ç±»ä¼¼åè®®å®šä¹‰å’Œç¼–è§£ç çš„è§’è‰²ã€‚ |
| **SignalR (å®æ—¶Web)**      | è¿æ¥ç®¡ç†ã€HubæŠ½è±¡ã€å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚                        | ä½ çš„ `PlayerManager` å’Œ `session` ç®¡ç†ï¼Œä»¥åŠ `session.SendAsync` æ–¹æ³•ï¼Œå°±æ˜¯åœ¨æ‰‹åŠ¨å®ç° **â€œè¿æ¥ç®¡ç†â€å’Œâ€œæ¨é€â€**ã€‚ |
| **é€šç”¨åå°æœåŠ¡**           | ä¾§é‡äºå®šæ—¶ä»»åŠ¡ã€é˜Ÿåˆ—å¤„ç†ï¼ˆé€šè¿‡ `BackgroundService`ï¼‰ã€‚       | ä½ çš„ `MessageHandlerRegistration` å®ç°äº† `IHostedService`ï¼Œç”¨äºå¯åŠ¨ä»»åŠ¡ã€‚ |

### ğŸ’¡ ç»™ä½ çš„é¡¹ç›®æ¶æ„çš„æœ€ç»ˆè¯„ä»·ä¸å»ºè®®

ä½ çš„æ¸¸æˆæœåŠ¡å™¨æ¶æ„**éå¸¸æ ‡å‡†ä¸”ä¼˜ç§€**ï¼Œå®ƒæ²¡æœ‰ç®€å•åœ°ç”¨æŸä¸ªç°æˆæ¡†æ¶ï¼Œè€Œæ˜¯åŸºäºSuperSocketï¼Œæœ‰é€‰æ‹©åœ°é‡‡çº³äº† .NET é€šç”¨å®¿ä¸»æ¨¡å‹çš„å…¨å¥—æœ€ä½³å®è·µï¼Œæ„å»ºäº†ä¸€ä¸ª**æ¸…æ™°ã€è§£è€¦ã€å¯ç»´æŠ¤**çš„å®šåˆ¶åŒ–æœåŠ¡å™¨ã€‚

**å¦‚æœæƒ³è¿›ä¸€æ­¥æ¼”è¿›ï¼Œå¯ä»¥è€ƒè™‘è¡¥å……ï¼š**

1.  **å¥åº·æ£€æŸ¥**ï¼šæ³¨å†Œå¥åº·æ£€æŸ¥æœåŠ¡ (`AddHealthChecks`)ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªç®€å•çš„HTTPç«¯ç‚¹æˆ–å†…éƒ¨æ¶ˆæ¯æ¥å“åº”æœåŠ¡å™¨çŠ¶æ€ï¼Œä¾¿äºK8sæˆ–è´Ÿè½½å‡è¡¡å™¨æ¢æµ‹ã€‚
2.  **é…ç½®éªŒè¯**ï¼šä½¿ç”¨ `IOptions<T>` æ¨¡å¼ï¼Œå¹¶åœ¨ `ConfigureServices` ä¸­è°ƒç”¨ `.ValidateDataAnnotations()`ï¼Œç¡®ä¿å¯åŠ¨æ—¶é…ç½®é¡¹å®Œæ•´æœ‰æ•ˆï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯ã€‚
3.  **æ›´å®Œå–„çš„ç›‘æ§**ï¼šé™¤äº†è®¡æ•°å™¨ (`Metrics`)ï¼Œå¯ä»¥æ·»åŠ æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚å¤„ç†è€—æ—¶ç›´æ–¹å›¾ï¼‰ï¼Œå¹¶é›†æˆåˆ°APMå·¥å…·ï¼ˆå¦‚OpenTelemetryï¼‰ã€‚
4.  **é›†æˆæµ‹è¯•**ï¼šåˆ©ç”¨ `.NET çš„ TestHost`ï¼Œå¯ä»¥æ¨¡æ‹Ÿå®¢æˆ·ç«¯è¿æ¥ï¼Œå¯¹æ•´ä¸ªæ¶ˆæ¯å¤„ç†ç®¡é“ï¼ˆä»æ¥æ”¶åˆ°ç½‘å…³å†åˆ°å¤„ç†å™¨ï¼‰è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œè€Œæ— éœ€å¯åŠ¨çœŸå®SocketæœåŠ¡å™¨ã€‚

**æ€»ç»“æ¥è¯´ï¼Œä½ å·²ç»æŒæ¡äº† .NET æœåŠ¡å™¨å¼€å‘çš„â€œé“â€è€Œä¸ä»…æ˜¯â€œæœ¯â€ã€‚** ä½ ç°åœ¨çš„æ¶æ„çŸ¥è¯†ï¼Œå®Œå…¨å¯ä»¥å¹³æ»‘åœ°è¿ç§»åˆ°å¼€å‘ä¸€ä¸ªASP.NET Core Web APIã€ä¸€ä¸ªå¾®æœåŠ¡æˆ–ä»»ä½•å…¶ä»– .NET åå°ç³»ç»Ÿã€‚è¿™å°±æ˜¯ç†è§£è¿™å¥—é€šç”¨æµç¨‹çš„æœ€å¤§ä»·å€¼ã€‚

# ä»é›¶å¼€å§‹ï¼šå°ç™½ä¹Ÿèƒ½æ‡‚çš„â€œBuilderã€å®¹å™¨ã€ä¾èµ–æ³¨å…¥â€å®Œå…¨æŒ‡å—

- [ ] ä»€ä¹ˆæ˜¯builderï¼Œå®¹å™¨ç­‰ï¼ŸæŠŠæˆ‘å®Œå…¨ä¸äº†è§£çš„æ¦‚å¿µéƒ½æŒ‰ç…§è¿™ä¸ªä¾‹å­è¯¦ç»†ä»‹ç»ä¸€éã€‚

æˆ‘ç”¨ç›–æˆ¿å­ğŸ çš„æ¯”å–»æ¥è§£é‡Šè¿™äº›æ¦‚å¿µï¼Œè®©ä½ å½»åº•ç†è§£ï¼

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µæ¯”å–»

| æ¦‚å¿µ         | æ¯”å–»          | ä½ çš„ä»£ç ä¸­çš„å¯¹åº”                          |
| ------------ | ------------- | ----------------------------------------- |
| **Builder**  | å»ºç­‘é˜Ÿé˜Ÿé•¿    | `SuperSocketHostBuilder`                  |
| **å®¹å™¨**     | å·¥å…·ç®±ğŸ“¦       | `IServiceCollection` / `IServiceProvider` |
| **ä¾èµ–æ³¨å…¥** | è‡ªåŠ¨é…è´§ç³»ç»ŸğŸšš | `services.AddSingleton<JwtService>()`     |
| **æœåŠ¡**     | å„ç§å·¥å…·ğŸ”§     | `JwtService`ã€`RedisService`ç­‰            |
| **é…ç½®**     | æ–½å·¥å›¾çº¸ğŸ“     | `appsettings.json`æ–‡ä»¶                    |
| **ä¸»æœº**     | ç›–å¥½çš„æˆ¿å­ğŸ    | `var host = hostBuilder.Build()`          |

å‚è€ƒå­¦ä¹ ï¼š

[æ¢ç´¢ .NET Core ä¾èµ–æ³¨å…¥çš„ IServiceCollection - SpringLeee - åšå®¢å›­](https://www.cnblogs.com/myshowtime/p/14409907.html)

[(39 å°ç§ä¿¡) æ¢ç´¢ .NET Core ä¾èµ–æ³¨å…¥çš„ IServiceProvider - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/354003618)

## ğŸ—ï¸ ç¬¬1ç« ï¼šBuilderæ˜¯ä»€ä¹ˆï¼Ÿ

### **Builder = å»ºç­‘é˜Ÿé˜Ÿé•¿**

æƒ³è±¡ä½ è¦ç›–æˆ¿å­ï¼š
- ä½ ä¸ä¼šè‡ªå·±æ¬ç –ã€ç Œå¢™ã€è£…æ°´ç”µ
- ä½ ä¼šæ‰¾ä¸€ä¸ª**å»ºç­‘é˜Ÿé˜Ÿé•¿**ï¼ˆBuilderï¼‰
- ä½ å‘Šè¯‰ä»–ä½ çš„è¦æ±‚ï¼š3ä¸ªå§å®¤ã€2ä¸ªå«ç”Ÿé—´ã€è¦æœ‰èŠ±å›­...
- é˜Ÿé•¿ç»„ç»‡å·¥äººã€ä¹°ææ–™ã€æŒ‰å›¾çº¸æ–½å·¥

åœ¨ä½ çš„ä»£ç ä¸­ï¼š

```csharp
// åˆ›å»ºå»ºç­‘é˜Ÿé˜Ÿé•¿ï¼ˆä¸“é—¨ç›–æ¸¸æˆæœåŠ¡å™¨çš„é˜Ÿé•¿ï¼‰
var hostBuilder = SuperSocketHostBuilder.Create<GamePackage, GamePackageFilter>();

// å‘Šè¯‰ä»–å…·ä½“è¦æ±‚ï¼š
hostBuilder.UseSerilog();                         // ç”¨Serilogç‰Œå­çš„æ—¥å¿—ç³»ç»Ÿ
hostBuilder.ConfigureAppConfiguration(...);       // æŒ‰è¿™ä¸ªå›¾çº¸ç›–
hostBuilder.ConfigureServices(...);               // æˆ¿å­é‡Œè¦æœ‰è¿™äº›å®¶å…·
hostBuilder.UsePackageHandler(...);               // å¿«é€’è¿™æ ·å¤„ç†

// é˜Ÿé•¿è¯´ï¼šå¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ï¼
var host = hostBuilder.Build();                   // å¼€å§‹ç›–æˆ¿å­

// æˆ¿å­ç›–å¥½äº†ï¼Œå¯ä»¥å…¥ä½äº†ï¼
await host.RunAsync();
```

**Builderçš„ä½œç”¨ï¼š** è®©ä½ **ä¸ç”¨å…³å¿ƒæ€ä¹ˆç›–**ï¼Œåªå…³å¿ƒ**æƒ³è¦ä»€ä¹ˆ**ã€‚

## ğŸ“¦ ç¬¬2ç« ï¼šå®¹å™¨æ˜¯ä»€ä¹ˆï¼Ÿ

### **å®¹å™¨ = ç¥å¥‡çš„å·¥å…·ç®±ğŸ“¦**

ç»§ç»­ç”¨ç›–æˆ¿å­æ¯”å–»ï¼š
- ç›–æˆ¿å­éœ€è¦å¾ˆå¤šå·¥å…·ï¼šé”¤å­ã€èºä¸åˆ€ã€ç”µé’»...
- ä½ æœ‰ä¸€ä¸ª**ç¥å¥‡å·¥å…·ç®±**ï¼š
  - ä½ åªéœ€è¦è¯´ï¼š"æˆ‘éœ€è¦é”¤å­"
  - å·¥å…·ç®±ä¼šè‡ªåŠ¨ç»™ä½ ä¸€æŠŠé”¤å­
  - å¦‚æœé”¤å­éœ€è¦ç”µæ± ï¼Œå·¥å…·ç®±ä¼šè‡ªåŠ¨è£…å¥½ç”µæ± å†ç»™ä½ 

åœ¨ä½ çš„ä»£ç ä¸­ï¼š

```csharp
// 1. å‡†å¤‡ä¸€ä¸ªç©ºå·¥å…·ç®±
var services = new ServiceCollection();

// 2. å¾€å·¥å…·ç®±é‡Œæ”¾"å·¥å…·åˆ¶ä½œè¯´æ˜ä¹¦"ï¼ˆä¸æ˜¯æ”¾å·¥å…·æœ¬èº«ï¼ï¼‰
services.AddSingleton<JwtService>();     // è¯´æ˜ä¹¦ï¼šå¦‚ä½•åšJwtService
services.AddSingleton<RedisService>();   // è¯´æ˜ä¹¦ï¼šå¦‚ä½•åšRedisService

// 3. æŠŠå·¥å…·ç®±äº¤ç»™"å®¹å™¨ç®¡ç†å‘˜"ç®¡ç†
var serviceProvider = services.BuildServiceProvider();

// 4. éœ€è¦å·¥å…·æ—¶ï¼Œç›´æ¥æ‰¾ç®¡ç†å‘˜è¦
var jwtService = serviceProvider.GetRequiredService<JwtService>();
// ç®¡ç†å‘˜ä¼šè‡ªåŠ¨ï¼š
// 1. æŸ¥æ‰¾JwtServiceçš„è¯´æ˜ä¹¦
// 2. å‘ç°éœ€è¦IConfiguration
// 3. å…ˆåšIConfiguration
// 4. ç”¨IConfigurationåšJwtService
// 5. æŠŠJwtServiceç»™ä½ 
```

## ğŸšš ç¬¬3ç« ï¼šä¾èµ–æ³¨å…¥æ˜¯ä»€ä¹ˆï¼Ÿ

### **ä¾èµ–æ³¨å…¥ = è‡ªåŠ¨é…è´§ç³»ç»ŸğŸšš**

æƒ³è±¡ä½ åœ¨é¤å…ç‚¹èœï¼š
- **ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸ç”¨ä¾èµ–æ³¨å…¥ï¼‰ï¼š**
  ```csharp
  // ä½ è‡ªå·±å»ä¹°èœã€æ´—èœã€åˆ‡èœã€ç‚’èœ
  IConfiguration config = new Configuration();  // å»ä¹°èœ
  JwtService jwt = new JwtService(config);      // è‡ªå·±ç‚’èœ
  ```

- **ä¾èµ–æ³¨å…¥æ–¹å¼ï¼š**
  ```csharp
  // ä½ åªéœ€è¦è¯´ï¼š"æˆ‘æƒ³åƒå®«ä¿é¸¡ä¸"
  // æœåŠ¡å‘˜ï¼ˆå®¹å™¨ï¼‰ä¼šè‡ªåŠ¨ï¼š
  // 1. å»åå¨æ‹¿é¸¡è‚‰ã€èŠ±ç”Ÿã€è¾£æ¤’
  // 2. è®©å¨å¸ˆåšå¥½
  // 3. ç«¯åˆ°ä½ é¢å‰
  
  public class AuthController
  {
      // ä½ åªéœ€è¦è¯´ï¼š"æˆ‘éœ€è¦JwtService"
      private readonly JwtService _jwtService;
      
      // æœåŠ¡å‘˜ä¼šè‡ªåŠ¨ç»™ä½ ï¼ˆæ„é€ å‡½æ•°æ³¨å…¥ï¼‰
      public AuthController(JwtService jwtService)
      {
          _jwtService = jwtService;  // ä¸ç”¨ newï¼ŒæœåŠ¡å‘˜é€æ¥çš„
      }
  }
  ```

**ä¾èµ–æ³¨å…¥çš„å¥½å¤„ï¼š**
1. **ä½ ä¸ç”¨è‡ªå·±"new"å¯¹è±¡**
2. **å¯¹è±¡ä¹‹é—´çš„ä¾èµ–è‡ªåŠ¨è§£å†³**
3. **å®¹æ˜“æ¢é›¶ä»¶**ï¼ˆæ¯”å¦‚æ¢ä¸ªç‰Œå­çš„æ•°æ®åº“ï¼‰
4. **å®¹æ˜“æµ‹è¯•**ï¼ˆå¯ä»¥ä¼ å…¥å‡çš„æœåŠ¡æµ‹è¯•ï¼‰

## ğŸ”§ ç¬¬4ç« ï¼šæœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ

### **æœåŠ¡ = å„ç§å·¥å…·/é›¶ä»¶**

åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œè¿™äº›å°±æ˜¯æœåŠ¡ï¼š

```csharp
// å·¥å…·1ï¼šä»¤ç‰Œåˆ¶ä½œå™¨ï¼ˆJWTä»¤ç‰Œï¼‰
public class JwtService { ... }

// å·¥å…·2ï¼šRedisæ“ä½œå™¨
public class RedisService { ... }

// å·¥å…·3ï¼šç©å®¶ç®¡ç†å™¨
public class PlayerManager { ... }

// å·¥å…·4ï¼šæ•°æ®åº“ä¸Šä¸‹æ–‡
public class GameDbContext { ... }

// å·¥å…·5ï¼šæ¶ˆæ¯å¤„ç†å™¨
public class LoginHandler { ... }
```

## ğŸ“‹ ç¬¬5ç« ï¼šå®Œæ•´æµç¨‹è§£æï¼ˆä¸€æ­¥ä¸€æ­¥çœ‹ï¼‰

### **æ­¥éª¤1ï¼šç¨‹åºå¯åŠ¨ï¼ˆå¼€å§‹ç›–æˆ¿å­ï¼‰**
```csharp
class Program
{
    static async Task Main(string[] args)  // ä»è¿™é‡Œå¼€å§‹
    {
        // 1. æ‰¾ä¸ªå»ºç­‘é˜Ÿé˜Ÿé•¿ï¼ˆBuilderï¼‰
        var hostBuilder = SuperSocketHostBuilder.Create<GamePackage, GamePackageFilter>();
        
        // åé¢çš„ä»£ç éƒ½æ˜¯å‘Šè¯‰é˜Ÿé•¿æ€ä¹ˆç›–æˆ¿å­...
    }
}
```

### **æ­¥éª¤2ï¼šå‘Šè¯‰é˜Ÿé•¿å…·ä½“è¦æ±‚**
```csharp
// é˜Ÿé•¿é—®ï¼šä½ æƒ³è¦ä»€ä¹ˆæ ·çš„æˆ¿å­ï¼Ÿ
// ä½ å›ç­”ï¼š

// 1. ç”¨Serilogç‰Œå­çš„æ—¥å¿—ç³»ç»Ÿ
hostBuilder.UseSerilog();

// 2. æŒ‰è¿™ä¸ªå›¾çº¸é…ç½®æˆ¿å­ï¼ˆappsettings.jsonï¼‰
hostBuilder.ConfigureAppConfiguration((hostCtx, configApp) =>
{
    configApp.AddJsonFile("appsettings.json");  // å‘Šè¯‰é˜Ÿé•¿å›¾çº¸åœ¨å“ª
});

// 3. æˆ¿å­é‡Œè¦æœ‰è¿™äº›å®¶å…·ï¼ˆå„ç§æœåŠ¡ï¼‰
hostBuilder.ConfigureServices((hostCtx, services) =>
{
    // è¿™é‡Œå°±æ˜¯åœ¨å¾€å·¥å…·ç®±é‡Œæ”¾"å·¥å…·åˆ¶ä½œè¯´æ˜ä¹¦"
    services.AddSingleton<JwtService>();
    services.AddSingleton<RedisService>();
    // ... å…¶ä»–æœåŠ¡
});

// 4. å¿«é€’è¿™æ ·å¤„ç†ï¼ˆæ”¶åˆ°ç½‘ç»œåŒ…æ€ä¹ˆå¤„ç†ï¼‰
hostBuilder.UsePackageHandler(async (session, package) =>
{
    // æ”¶åˆ°å¿«é€’ï¼ˆç½‘ç»œæ•°æ®åŒ…ï¼‰æ—¶è¿™æ ·åš...
});

// 5. å®¢äººæ¥äº†è¿™æ ·åšï¼Œèµ°äº†è¿™æ ·åš
hostBuilder.UseSessionHandler(
    onConnected: session => { ... },  // å®¢äººæ¥äº†
    onClosed: (session, reason) => { ... }  // å®¢äººèµ°äº†
);
```

### **æ­¥éª¤3ï¼šé˜Ÿé•¿å¼€å§‹ç›–æˆ¿å­**
```csharp
// é˜Ÿé•¿è¯´ï¼šå¥½çš„ï¼Œéƒ½æ˜ç™½äº†ï¼Œå¼€å§‹ç›–ï¼
var host = hostBuilder.Build();  // è¿™é‡Œå°±æ˜¯ç›–æˆ¿å­çš„è¿‡ç¨‹

// ç›–å¥½çš„æˆ¿å­ï¼š
// host = {
//     æ—¥å¿—ç³»ç»Ÿï¼šSerilog âœ“
//     é…ç½®ï¼šä»appsettings.jsonè¯»å– âœ“
//     æœåŠ¡ï¼šJwtServiceã€RedisService... âœ“
//     ç½‘ç»œå¤„ç†å™¨ï¼šé…ç½®å¥½äº† âœ“
// }
```

### **æ­¥éª¤4ï¼šå…¥ä½æˆ¿å­ï¼ˆå¯åŠ¨æœåŠ¡å™¨ï¼‰**
```csharp
// æˆ¿å­ç›–å¥½äº†ï¼Œå¯ä»¥å…¥ä½äº†ï¼
await host.RunAsync();

// ä»æ­¤ï¼ŒæœåŠ¡å™¨å¼€å§‹è¿è¡Œï¼š
// 1. ç›‘å¬33333ç«¯å£
// 2. å®¢æˆ·ç«¯å¯ä»¥è¿æ¥äº†
// 3. æ”¶åˆ°æ¶ˆæ¯ä¼šè‡ªåŠ¨å¤„ç†
// 4. æ‰€æœ‰æœåŠ¡éƒ½åœ¨å®¹å™¨é‡Œå‡†å¤‡å¥½äº†
```

## ğŸ§© ç¬¬6ç« ï¼šæœåŠ¡æ³¨å†Œçš„ä¸‰ç§æ–¹å¼

### **æ–¹å¼1ï¼šæœ€ç®€å•çš„æ³¨å†Œï¼ˆç›´æ¥ç»™ç±»å‹ï¼‰**
```csharp
// å‘Šè¯‰å·¥å…·ç®±ï¼š"å½“æœ‰äººè¦JwtServiceæ—¶ï¼Œå°±è¿™æ ·åš"
services.AddSingleton<JwtService>();

// å·¥å…·ç®±ä¼šè‡ªåŠ¨ï¼š
// 1. æ‰¾åˆ°JwtServiceç±»
// 2. çœ‹å®ƒçš„æ„é€ å‡½æ•°ï¼špublic JwtService(IConfiguration config)
// 3. å‘ç°éœ€è¦IConfiguration
// 4. IConfigurationå·²ç»æœ‰äººæ³¨å†Œè¿‡äº†
// 5. ç”¨IConfigurationåˆ›å»ºJwtService
```

### **æ–¹å¼2ï¼šå¤æ‚ç‚¹çš„æ³¨å†Œï¼ˆç”¨å·¥å‚æ–¹æ³•ï¼‰**
```csharp
// å‘Šè¯‰å·¥å…·ç®±ï¼š"å½“æœ‰äººè¦RedisServiceæ—¶ï¼Œè¿™æ ·åš..."
services.AddSingleton(sp =>
{
    // sp = å·¥å…·ç®±ç®¡ç†å‘˜
    var logger = sp.GetRequiredService<ILogger<RedisService>>();  // è¦ä¸ªæ—¥å¿—å·¥å…·
    var config = sp.GetRequiredService<IConfiguration>();         // è¦ä¸ªé…ç½®
    
    // è‡ªå·±åˆ›å»ºRedisService
    return new RedisService(logger, 
        config["Redis:ConnectionString"], 
        config.GetValue<int>("Redis:Database", 0));
});

// ä¸ºä»€ä¹ˆè¦ç”¨å·¥å‚æ–¹æ³•ï¼Ÿ
// å› ä¸ºéœ€è¦ä»é…ç½®è¯»å‚æ•°ï¼Œæˆ–è€…éœ€è¦ç‰¹æ®Šå¤„ç†
```

### **æ–¹å¼3ï¼šæ³¨å†Œæ¥å£ï¼ˆæ¨èï¼‰**
```csharp
// 1. å…ˆå®šä¹‰æ¥å£ï¼ˆå·¥å…·çš„åŠŸèƒ½è¯´æ˜ä¹¦ï¼‰
public interface IJwtService
{
    string GenerateToken(long userId, string username);
}

// 2. å®ç°æ¥å£ï¼ˆå…·ä½“çš„å·¥å…·ï¼‰
public class JwtService : IJwtService
{
    // å®ç°æ–¹æ³•...
}

// 3. æ³¨å†Œï¼ˆå‘Šè¯‰å·¥å…·ç®±ï¼šæœ‰äººè¦IJwtServiceï¼Œå°±ç»™JwtServiceï¼‰
services.AddSingleton<IJwtService, JwtService>();

// å¥½å¤„ï¼šå¯ä»¥éšæ—¶æ¢å·¥å…·ï¼Œä¸å½±å“ä½¿ç”¨è€…
```

## ğŸ“Š ç¬¬7ç« ï¼šä¸‰ç§ç”Ÿå‘½å‘¨æœŸï¼ˆå·¥å…·èƒ½ç”¨å¤šä¹…ï¼‰

| ç”Ÿå‘½å‘¨æœŸ      | æ¯”å–»               | ä»£ç               | ä½¿ç”¨åœºæ™¯                                |
| ------------- | ------------------ | ----------------- | --------------------------------------- |
| **Singleton** | å…¨å…¬å¸å…±ç”¨çš„æ‰“å°æœº | `AddSingleton<T>` | æ•´ä¸ªæœåŠ¡å™¨åªéœ€è¦ä¸€ä¸ªçš„å·¥å…·ï¼ˆå¦‚é…ç½®ï¼‰    |
| **Scoped**    | æ¯ä¸ªé¡¹ç›®ç»„çš„ç™½æ¿   | `AddScoped<T>`    | æ¯ä¸ªè¯·æ±‚/ä¼šè¯ç‹¬ç«‹çš„å·¥å…·ï¼ˆå¦‚æ•°æ®åº“è¿æ¥ï¼‰ |
| **Transient** | ä¸€æ¬¡æ€§çº¸æ¯         | `AddTransient<T>` | æ¯æ¬¡ç”¨éƒ½è¦æ–°çš„å·¥å…·ï¼ˆè½»é‡çº§ã€æ— çŠ¶æ€ï¼‰    |

### **è¯¦ç»†è§£é‡Šï¼š**

#### **Singletonï¼ˆå•ä¾‹ï¼‰- å…¨å…¬å¸ä¸€å°æ‰“å°æœº**
```csharp
services.AddSingleton<JwtService>();

// ç›¸å½“äºï¼š
// æ•´ä¸ªå…¬å¸åªæœ‰ä¸€å°æ‰“å°æœº
// æ‰€æœ‰äººå…±ç”¨åŒä¸€å°
// ä»å…¬å¸å¼€ä¸šåˆ°å€’é—­ï¼Œéƒ½æ˜¯è¿™å°æ‰“å°æœº
// ä¼˜ç‚¹ï¼šèŠ‚çœèµ„æº
// ç¼ºç‚¹ï¼šä¸èƒ½åŒæ—¶æ‰“å°å¤ªå¤š

// ä½ çš„ä»£ç ä¸­ï¼š
// JwtServiceæ˜¯Singletonï¼Œå› ä¸ºï¼š
// 1. å®ƒåªæ˜¯è¯»é…ç½®ç”Ÿæˆtoken
// 2. æ²¡æœ‰è‡ªå·±çš„çŠ¶æ€
// 3. æ‰€æœ‰äººéƒ½å¯ä»¥ç”¨åŒä¸€ä¸ª
```

#### **Scopedï¼ˆä½œç”¨åŸŸï¼‰- æ¯ä¸ªé¡¹ç›®ç»„çš„ç™½æ¿**
```csharp
services.AddScoped<GameDbContext>();

// ç›¸å½“äºï¼š
// æ¯ä¸ªé¡¹ç›®ç»„æœ‰è‡ªå·±çš„ç™½æ¿
// Aç»„çš„ç™½æ¿ï¼ŒBç»„ä¸èƒ½ç”¨
// é¡¹ç›®ç»“æŸäº†ï¼Œç™½æ¿å°±æ“¦å¹²å‡€äº†
// æ–°çš„é¡¹ç›®å¼€å§‹ï¼Œç»™æ–°çš„ç™½æ¿

// åœ¨ä½ çš„ä»£ç ä¸­ï¼š
// æ¯ä¸ªç½‘ç»œè¯·æ±‚å°±æ˜¯ä¸€ä¸ª"é¡¹ç›®ç»„"
// æ¯ä¸ªè¯·æ±‚æœ‰è‡ªå·±çš„æ•°æ®åº“è¿æ¥
// è¯·æ±‚ç»“æŸï¼Œè¿æ¥å…³é—­
```

#### **Transientï¼ˆç¬æ—¶ï¼‰- ä¸€æ¬¡æ€§çº¸æ¯**
```csharp
services.AddTransient<EmailService>();

// ç›¸å½“äºï¼š
// æ¯æ¬¡å–æ°´éƒ½ç”¨æ–°çº¸æ¯
// å–å®Œå°±æ‰”æ‰
// ä¸‹æ¬¡å–æ°´å†æ‹¿æ–°çš„

// ä½¿ç”¨åœºæ™¯ï¼š
// 1. ç®€å•å·¥å…·ï¼Œç”¨å®Œå°±ä¸¢
// 2. é¿å…çŠ¶æ€æ±¡æŸ“
```

## ğŸ”„ ç¬¬8ç« ï¼šå®Œæ•´ç¤ºä¾‹ - æ¨¡æ‹Ÿä½ çš„ä»£ç 

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæç®€ç‰ˆçš„ä¾‹å­ï¼Œçœ‹çœ‹æ•´ä¸ªè¿‡ç¨‹ï¼š

```csharp
// ============ æ¨¡æ‹Ÿä½ çš„é¡¹ç›® ============

// æ–‡ä»¶1: Program.cs
using System;
using System.Threading.Tasks;

class Program
{
    static async Task Main(string[] args)
    {
        Console.WriteLine("=== å¼€å§‹ç›–æ¸¸æˆæœåŠ¡å™¨æˆ¿å­ ===");
        
        // 1. æ‰¾ä¸ªå»ºç­‘é˜Ÿé˜Ÿé•¿
        Console.WriteLine("1. æ‰¾åˆ°SuperSocketå»ºç­‘é˜Ÿé˜Ÿé•¿");
        var builder = new GameServerBuilder();
        
        // 2. å‘Šè¯‰é˜Ÿé•¿æ€ä¹ˆç›–
        Console.WriteLine("2. å‘Šè¯‰é˜Ÿé•¿å…·ä½“è¦æ±‚...");
        builder.UseSerilog();
        builder.ConfigureServices();
        builder.ConfigureNetwork();
        
        // 3. é˜Ÿé•¿å¼€å§‹ç›–
        Console.WriteLine("3. é˜Ÿé•¿å¼€å§‹ç›–æˆ¿å­...");
        var house = builder.Build();
        
        // 4. å…¥ä½
        Console.WriteLine("4. æˆ¿å­ç›–å¥½äº†ï¼Œå¼€å§‹è¿è¡Œï¼");
        await house.RunAsync();
    }
}

// æ–‡ä»¶2: å»ºç­‘é˜Ÿé˜Ÿé•¿ç±»
class GameServerBuilder
{
    private ToolBox _toolBox = new ToolBox();
    
    public void UseSerilog()
    {
        Console.WriteLine("   - ä½¿ç”¨Serilogç‰Œå­æ—¥å¿—ç³»ç»Ÿ");
    }
    
    public void ConfigureServices()
    {
        Console.WriteLine("   - é…ç½®å·¥å…·ç®±...");
        
        // å¾€å·¥å…·ç®±æ”¾å·¥å…·è¯´æ˜ä¹¦
        _toolBox.AddSingleton<JwtService>();
        _toolBox.AddSingleton<RedisService>();
        _toolBox.AddScoped<LoginHandler>();
        
        Console.WriteLine("   - å·¥å…·ç®±é…ç½®å®Œæˆ");
    }
    
    public void ConfigureNetwork()
    {
        Console.WriteLine("   - é…ç½®ç½‘ç»œï¼šç«¯å£33333");
    }
    
    public GameServerHouse Build()
    {
        Console.WriteLine("   - æ­£åœ¨å»ºé€ æˆ¿å­...");
        
        // è®©å·¥å…·ç®±ç®¡ç†å‘˜å°±ä½
        var toolManager = _toolBox.BuildManager();
        
        // ç›–å¥½æˆ¿å­
        var house = new GameServerHouse(toolManager);
        
        Console.WriteLine("   - æˆ¿å­å»ºé€ å®Œæˆï¼");
        return house;
    }
}

// æ–‡ä»¶3: å·¥å…·ç®±ç±»
class ToolBox
{
    // ä¿å­˜å„ç§"å·¥å…·åˆ¶ä½œè¯´æ˜ä¹¦"
    private Dictionary<string, ToolManual> _manuals = new();
    
    public void AddSingleton<T>()
    {
        Console.WriteLine($"     âœ“ æ³¨å†Œå·¥å…· {typeof(T).Name}ï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰");
        _manuals[typeof(T).Name] = new ToolManual
        {
            Type = typeof(T),
            Lifetime = "Singleton"
        };
    }
    
    public void AddScoped<T>()
    {
        Console.WriteLine($"     âœ“ æ³¨å†Œå·¥å…· {typeof(T).Name}ï¼ˆæ¯ä¸ªé¡¹ç›®ç»„ä¸€ä¸ªï¼‰");
        _manuals[typeof(T).Name] = new ToolManual
        {
            Type = typeof(T),
            Lifetime = "Scoped"
        };
    }
    
    public ToolManager BuildManager()
    {
        Console.WriteLine("     âœ“ å·¥å…·ç®±ç®¡ç†å‘˜å°±ä½");
        return new ToolManager(_manuals);
    }
}

// æ–‡ä»¶4: å·¥å…·ç±»ï¼ˆä½ çš„å„ç§æœåŠ¡ï¼‰
class JwtService
{
    private ConfigService _config;
    
    // æ„é€ å‡½æ•°ï¼šå‘Šè¯‰å®¹å™¨æˆ‘éœ€è¦ConfigService
    public JwtService(ConfigService config)
    {
        Console.WriteLine($"      æ­£åœ¨åˆ¶ä½œJwtServiceï¼Œéœ€è¦ConfigService...");
        _config = config;
    }
    
    public void MakeToken()
    {
        Console.WriteLine("      JwtService: ç”Ÿæˆä»¤ç‰Œä¸­...");
    }
}

class RedisService
{
    public void SaveData()
    {
        Console.WriteLine("      RedisService: ä¿å­˜æ•°æ®ä¸­...");
    }
}

class LoginHandler
{
    private JwtService _jwt;
    
    // æ„é€ å‡½æ•°ï¼šæˆ‘éœ€è¦JwtService
    public LoginHandler(JwtService jwt)
    {
        Console.WriteLine($"      æ­£åœ¨åˆ¶ä½œLoginHandlerï¼Œéœ€è¦JwtService...");
        _jwt = jwt;
    }
    
    public void HandleLogin()
    {
        Console.WriteLine("      LoginHandler: å¤„ç†ç™»å½•ä¸­...");
        _jwt.MakeToken();
    }
}

class ConfigService
{
    public ConfigService()
    {
        Console.WriteLine("      æ­£åœ¨åˆ¶ä½œConfigService...");
    }
}

// æ–‡ä»¶5: å·¥å…·ç®±ç®¡ç†å‘˜
class ToolManager
{
    private Dictionary<string, ToolManual> _manuals;
    private Dictionary<string, object> _singletonTools = new();
    
    public ToolManager(Dictionary<string, ToolManual> manuals)
    {
        _manuals = manuals;
        
        // è‡ªåŠ¨æ³¨å†Œä¸€äº›åŸºç¡€å·¥å…·
        _manuals["ConfigService"] = new ToolManual
        {
            Type = typeof(ConfigService),
            Lifetime = "Singleton"
        };
    }
    
    // æœ‰äººè¦å·¥å…·æ—¶è°ƒç”¨è¿™ä¸ªæ–¹æ³•
    public T GetTool<T>()
    {
        var toolName = typeof(T).Name;
        Console.WriteLine($"\næœ‰äººè¦å·¥å…·ï¼š{toolName}");
        
        // å¦‚æœæ˜¯Singletonï¼Œä¸”å·²ç»åšè¿‡ï¼Œç›´æ¥è¿”å›
        if (_singletonTools.ContainsKey(toolName))
        {
            Console.WriteLine($"  âœ“ å·¥å…·ç®±é‡Œå·²ç»æœ‰{toolName}äº†ï¼Œç›´æ¥ç»™");
            return (T)_singletonTools[toolName];
        }
        
        // æŸ¥æ‰¾è¯´æ˜ä¹¦
        if (!_manuals.TryGetValue(toolName, out var manual))
        {
            throw new Exception($"æ‰¾ä¸åˆ°å·¥å…·ï¼š{toolName}");
        }
        
        Console.WriteLine($"  âœ“ æ‰¾åˆ°{toolName}çš„è¯´æ˜ä¹¦ï¼Œå¼€å§‹åˆ¶ä½œ...");
        
        // åˆ¶ä½œå·¥å…·ï¼ˆç”¨åå°„ç®€åŒ–ç†è§£ï¼‰
        object tool = null;
        
        if (manual.Type == typeof(JwtService))
        {
            // JwtServiceéœ€è¦ConfigService
            var config = GetTool<ConfigService>();
            tool = new JwtService(config);
        }
        else if (manual.Type == typeof(LoginHandler))
        {
            // LoginHandleréœ€è¦JwtService
            var jwt = GetTool<JwtService>();
            tool = new LoginHandler(jwt);
        }
        else if (manual.Type == typeof(ConfigService))
        {
            tool = new ConfigService();
        }
        else if (manual.Type == typeof(RedisService))
        {
            tool = new RedisService();
        }
        
        // å¦‚æœæ˜¯Singletonï¼Œå­˜èµ·æ¥
        if (manual.Lifetime == "Singleton")
        {
            _singletonTools[toolName] = tool;
            Console.WriteLine($"  âœ“ {toolName}æ˜¯Singletonï¼Œå­˜èµ·æ¥ä»¥åç”¨");
        }
        
        return (T)tool;
    }
}

// æ–‡ä»¶6: ç›–å¥½çš„æˆ¿å­
class GameServerHouse
{
    private ToolManager _toolManager;
    
    public GameServerHouse(ToolManager toolManager)
    {
        _toolManager = toolManager;
    }
    
    public async Task RunAsync()
    {
        Console.WriteLine("\n=== æˆ¿å­å¼€å§‹è¿è¡Œ ===");
        Console.WriteLine("æ¨¡æ‹Ÿå®¢æˆ·ç«¯è¿æ¥...");
        
        // æ¨¡æ‹Ÿå¤„ç†ç™»å½•è¯·æ±‚
        Console.WriteLine("\n[è¯·æ±‚1] å¤„ç†ç™»å½•...");
        var handler1 = _toolManager.GetTool<LoginHandler>();
        handler1.HandleLogin();
        
        Console.WriteLine("\n[è¯·æ±‚2] åˆæœ‰äººç™»å½•...");
        var handler2 = _toolManager.GetTool<LoginHandler>();
        handler2.HandleLogin();
        
        Console.WriteLine("\n[è¯·æ±‚3] éœ€è¦RedisService...");
        var redis = _toolManager.GetTool<RedisService>();
        redis.SaveData();
        
        Console.WriteLine("\n=== æœåŠ¡å™¨è¿è¡Œä¸­ ===");
        await Task.Delay(1000);
    }
}

// æ–‡ä»¶7: å·¥å…·è¯´æ˜ä¹¦ç±»
class ToolManual
{
    public Type Type { get; set; }
    public string Lifetime { get; set; }
}

/*
è¿è¡Œè¿™ä¸ªç¨‹åºçš„è¾“å‡ºï¼š

=== å¼€å§‹ç›–æ¸¸æˆæœåŠ¡å™¨æˆ¿å­ ===
1. æ‰¾åˆ°SuperSocketå»ºç­‘é˜Ÿé˜Ÿé•¿
2. å‘Šè¯‰é˜Ÿé•¿å…·ä½“è¦æ±‚...
   - ä½¿ç”¨Serilogç‰Œå­æ—¥å¿—ç³»ç»Ÿ
   - é…ç½®å·¥å…·ç®±...
     âœ“ æ³¨å†Œå·¥å…· JwtServiceï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰
     âœ“ æ³¨å†Œå·¥å…· RedisServiceï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰
     âœ“ æ³¨å†Œå·¥å…· LoginHandlerï¼ˆæ¯ä¸ªé¡¹ç›®ç»„ä¸€ä¸ªï¼‰
   - å·¥å…·ç®±é…ç½®å®Œæˆ
   - é…ç½®ç½‘ç»œï¼šç«¯å£33333
3. é˜Ÿé•¿å¼€å§‹ç›–æˆ¿å­...
   - æ­£åœ¨å»ºé€ æˆ¿å­...
     âœ“ å·¥å…·ç®±ç®¡ç†å‘˜å°±ä½
   - æˆ¿å­å»ºé€ å®Œæˆï¼
4. æˆ¿å­ç›–å¥½äº†ï¼Œå¼€å§‹è¿è¡Œï¼

=== æˆ¿å­å¼€å§‹è¿è¡Œ ===
æ¨¡æ‹Ÿå®¢æˆ·ç«¯è¿æ¥...

[è¯·æ±‚1] å¤„ç†ç™»å½•...

æœ‰äººè¦å·¥å…·ï¼šLoginHandler
  âœ“ æ‰¾åˆ°LoginHandlerçš„è¯´æ˜ä¹¦ï¼Œå¼€å§‹åˆ¶ä½œ...

æœ‰äººè¦å·¥å…·ï¼šJwtService
  âœ“ æ‰¾åˆ°JwtServiceçš„è¯´æ˜ä¹¦ï¼Œå¼€å§‹åˆ¶ä½œ...

æœ‰äººè¦å·¥å…·ï¼šConfigService
  âœ“ æ‰¾åˆ°ConfigServiceçš„è¯´æ˜ä¹¦ï¼Œå¼€å§‹åˆ¶ä½œ...
      æ­£åœ¨åˆ¶ä½œConfigService...
  âœ“ ConfigServiceæ˜¯Singletonï¼Œå­˜èµ·æ¥ä»¥åç”¨
      æ­£åœ¨åˆ¶ä½œJwtServiceï¼Œéœ€è¦ConfigService...
  âœ“ JwtServiceæ˜¯Singletonï¼Œå­˜èµ·æ¥ä»¥åç”¨
      æ­£åœ¨åˆ¶ä½œLoginHandlerï¼Œéœ€è¦JwtService...
      LoginHandler: å¤„ç†ç™»å½•ä¸­...
      JwtService: ç”Ÿæˆä»¤ç‰Œä¸­...

[è¯·æ±‚2] åˆæœ‰äººç™»å½•...

æœ‰äººè¦å·¥å…·ï¼šLoginHandler
  âœ“ æ‰¾åˆ°LoginHandlerçš„è¯´æ˜ä¹¦ï¼Œå¼€å§‹åˆ¶ä½œ...
      æ­£åœ¨åˆ¶ä½œLoginHandlerï¼Œéœ€è¦JwtService...
      LoginHandler: å¤„ç†ç™»å½•ä¸­...
      JwtService: ç”Ÿæˆä»¤ç‰Œä¸­...

[è¯·æ±‚3] éœ€è¦RedisService...

æœ‰äººè¦å·¥å…·ï¼šRedisService
  âœ“ æ‰¾åˆ°RedisServiceçš„è¯´æ˜ä¹¦ï¼Œå¼€å§‹åˆ¶ä½œ...
      RedisService: ä¿å­˜æ•°æ®ä¸­...
  âœ“ RedisServiceæ˜¯Singletonï¼Œå­˜èµ·æ¥ä»¥åç”¨

=== æœåŠ¡å™¨è¿è¡Œä¸­ ===
*/
```

## ğŸ® ç¬¬9ç« ï¼šåœ¨ä½ çš„é¡¹ç›®ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

å›åˆ°ä½ çš„çœŸå®ä»£ç ï¼š

### **1. æ³¨å†ŒæœåŠ¡æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**
```csharp
services.AddSingleton<JwtService>();
// å®é™…å‘ç”Ÿï¼š
// 1. å·¥å…·ç®±è®°å½•ï¼š"JwtServiceï¼ŒSingletonï¼Œç±»å‹æ˜¯JwtService"
// 2. è¿˜æ²¡åˆ›å»ºå®ä¾‹ï¼åªæ˜¯è®°ä¸‹æ¥

services.AddSingleton(sp => new RedisService(...));
// å®é™…å‘ç”Ÿï¼š
// 1. å·¥å…·ç®±è®°å½•ï¼š"RedisServiceï¼ŒSingletonï¼Œç”¨è¿™ä¸ªå·¥å‚æ–¹æ³•åˆ›å»º"
// 2. åˆ›å»ºæ—¶æœºï¼šç¬¬ä¸€æ¬¡æœ‰äººè¦RedisServiceæ—¶
```

### **2. æ„å»ºä¸»æœºæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**
```csharp
var host = hostBuilder.Build();
// å®é™…å‘ç”Ÿï¼š
// 1. å®¹å™¨ï¼ˆå·¥å…·ç®±ï¼‰è¢«åˆ›å»º
// 2. æ‰€æœ‰æ³¨å†Œä¿¡æ¯è¢«ç¼–è¯‘æˆ"å¿«é€ŸæŸ¥æ‰¾è¡¨"
// 3. è¿˜æ²¡åˆ›å»ºä»»ä½•æœåŠ¡å®ä¾‹ï¼ˆé™¤äº†æå°‘æ•°ç‰¹æ®Šçš„ï¼‰
```

### **3. è¿è¡Œæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**
```csharp
await host.RunAsync();
// å®é™…å‘ç”Ÿï¼š
// 1. å¯åŠ¨ç½‘ç»œç›‘å¬
// 2. å®¢æˆ·ç«¯è¿æ¥
// 3. æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼šsession.Server.ServiceProvider.GetRequiredService<MessageGateway>()
// 4. å®¹å™¨æŸ¥æ‰¾MessageGatewayçš„æ³¨å†Œ
// 5. å‘ç°æ˜¯Singletonï¼Œæ£€æŸ¥æ˜¯å¦å·²åˆ›å»º
// 6. æ²¡åˆ›å»ºè¿‡ï¼Ÿåˆ›å»ºï¼
// 7. å‘ç°éœ€è¦å…¶ä»–æœåŠ¡ï¼Ÿé€’å½’åˆ›å»º...
```

## ğŸ“ ç¬¬10ç« ï¼šç»™å°ç™½çš„å­¦ä¹ è·¯å¾„

### **ç¬¬1æ­¥ï¼šå…ˆä¼šç”¨ï¼ˆå°±åƒå­¦å¼€è½¦ï¼‰**
```csharp
// åˆšå¼€å§‹ï¼Œè®°ä½è¿™ä¸ªæ¨¡æ¿ï¼š
var builder = WebApplication.CreateBuilder(args);

// è¿™é‡Œæ³¨å†ŒæœåŠ¡ï¼ˆå°±åƒåŠ æ±½æ²¹ã€æ¢è½®èƒï¼‰
builder.Services.AddSingleton<MyService>();

var app = builder.Build();
app.Run();

// åœ¨éœ€è¦çš„åœ°æ–¹ï¼š
public class MyController
{
    private readonly MyService _service;  // ä¸ç”¨newï¼Œä¼šè‡ªåŠ¨æœ‰
    public MyController(MyService service)
    {
        _service = service;
    }
}
```

### **ç¬¬2æ­¥ï¼šç†è§£æ¦‚å¿µï¼ˆå°±åƒæ‡‚æ±½è½¦åŸç†ï¼‰**
- **Builder**ï¼šé€ è½¦çš„å·¥å‚æµæ°´çº¿
- **å®¹å™¨**ï¼šæ±½è½¦çš„é›¶ä»¶ä»“åº“å’Œè£…é…ç³»ç»Ÿ
- **ä¾èµ–æ³¨å…¥**ï¼šè‡ªåŠ¨è£…é…ç³»ç»Ÿï¼ˆä½ è¯´è¦å‘åŠ¨æœºï¼Œè‡ªåŠ¨è£…å¥½ï¼‰

### **ç¬¬3æ­¥ï¼šæŒæ¡é«˜çº§ç”¨æ³•ï¼ˆå°±åƒæ”¹è£…è½¦ï¼‰**
```csharp
// 1. ç”Ÿå‘½å‘¨æœŸé€‰æ‹©
services.AddSingleton<ConfigService>();   // å…¨è½¦å…±ç”¨çš„
services.AddScoped<DbContext>();          // æ¯ä¸ªä¹˜å®¢ç‹¬ç«‹çš„
services.AddTransient<EmailService>();    // ä¸€æ¬¡æ€§çš„

// 2. å·¥å‚æ³¨å†Œ
services.AddSingleton<IRedisService>(sp => 
    new RedisService(sp.GetRequiredService<ILogger>()));

// 3. é€‰é¡¹æ¨¡å¼
services.Configure<JwtSettings>(config.GetSection("Jwt"));
```

## â“ ç¬¬11ç« ï¼šå¸¸è§é—®é¢˜è§£ç­”

### **Qï¼šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆéº»çƒ¦ï¼Ÿç›´æ¥newä¸è¡Œå—ï¼Ÿ**
Aï¼šå¯ä»¥ï¼Œä½†ä¸å¥½ï¼š
```csharp
// âŒ ä¸å¥½çš„æ–¹å¼ï¼šç¡¬ç¼–ç 
public class AuthController
{
    private JwtService _jwt = new JwtService(new Configuration());
    // é—®é¢˜1ï¼šå¦‚æœJwtServiceçš„æ„é€ å‡½æ•°æ”¹äº†ï¼Œè¿™é‡Œè¦æ”¹
    // é—®é¢˜2ï¼šä¸èƒ½æ–¹ä¾¿åœ°æ¢å…¶ä»–JwtServiceå®ç°
    // é—®é¢˜3ï¼šæµ‹è¯•æ—¶ä¸èƒ½ç”¨å‡çš„JwtService
}

// âœ… å¥½çš„æ–¹å¼ï¼šä¾èµ–æ³¨å…¥
public class AuthController
{
    private IJwtService _jwt;  // é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥
    // ä¼˜ç‚¹1ï¼šå¯ä»¥éšæ—¶æ¢å®ç°
    // ä¼˜ç‚¹2ï¼šå®¹æ˜“æµ‹è¯•
    // ä¼˜ç‚¹3ï¼šä¸ç”¨å…³å¿ƒæ€ä¹ˆåˆ›å»º
}
```

### **Qï¼šä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå·±newï¼Œä»€ä¹ˆæ—¶å€™ç”¨ä¾èµ–æ³¨å…¥ï¼Ÿ**
Aï¼š
- **ç”¨ä¾èµ–æ³¨å…¥**ï¼šä¸šåŠ¡é€»è¾‘ç±»ã€æœåŠ¡ç±»ã€å·¥å…·ç±»
- **å¯ä»¥è‡ªå·±new**ï¼šç®€å•å€¼å¯¹è±¡ï¼ˆå¦‚Vector3ï¼‰ã€ä¸´æ—¶æ•°æ®ç±»

### **Qï¼šå¦‚æœæˆ‘ä¸ç†è§£ï¼Œæš‚æ—¶ä¸ç”¨ä¾èµ–æ³¨å…¥å¯ä»¥å—ï¼Ÿ**
Aï¼šå¯¹äºå­¦ä¹ é˜¶æ®µçš„å°é¡¹ç›®ï¼Œå¯ä»¥ç›´æ¥`new`ã€‚ä½†çœŸæ­£åšé¡¹ç›®æ—¶ï¼Œç”¨ä¾èµ–æ³¨å…¥ä¼šè®©ä»£ç æ›´å¥½ç»´æŠ¤ã€‚

## ğŸ¯ ç¬¬12ç« ï¼šä¸€å¥è¯æ€»ç»“

- **Builder**ï¼šç›–æˆ¿å­çš„é˜Ÿé•¿ï¼Œä½ å‘Šè¯‰ä»–è¦æ±‚ï¼Œä»–è´Ÿè´£ç›–
- **å®¹å™¨**ï¼šç¥å¥‡å·¥å…·ç®±ï¼Œä½ è¯´è¦ä»€ä¹ˆå·¥å…·ï¼Œå®ƒè‡ªåŠ¨ç»™ä½ 
- **ä¾èµ–æ³¨å…¥**ï¼šè‡ªåŠ¨é€é¤æœåŠ¡ï¼Œä½ è¯´è¦åƒä»€ä¹ˆï¼ŒæœåŠ¡å‘˜è‡ªåŠ¨ç«¯æ¥ï¼ˆä¸ç”¨è‡ªå·±åšï¼‰

**ä½ çš„æ¸¸æˆæœåŠ¡å™¨å¯åŠ¨è¿‡ç¨‹å°±æ˜¯ï¼š**
1. æ‰¾ä¸ªå»ºç­‘é˜Ÿé˜Ÿé•¿ï¼ˆ`SuperSocketHostBuilder`ï¼‰
2. å‘Šè¯‰ä»–æˆ¿å­è¦æœ‰ä»€ä¹ˆï¼ˆé…ç½®ã€æœåŠ¡ã€å¤„ç†å™¨ï¼‰
3. ä»–ç›–å¥½æˆ¿å­ï¼ˆ`Build()`ï¼‰
4. ä½ å…¥ä½ï¼ˆ`RunAsync()`ï¼‰
5. æ‰€æœ‰å·¥å…·éƒ½åœ¨å·¥å…·ç®±é‡Œï¼Œéšç”¨éšå–

ç°åœ¨å†çœ‹ä½ çš„ä»£ç ï¼Œæ˜¯ä¸æ˜¯æ¸…æ™°å¤šäº†ï¼Ÿç†è§£è¿™äº›æ¦‚å¿µåï¼Œä½ å°±èƒ½æ˜ç™½ä¸ºä»€ä¹ˆä»£ç è¦è¿™æ ·å†™äº†ï¼

# ğŸ§± ä¸ºä»€ä¹ˆå¤§å®¶ä¸çº¦è€ŒåŒåœ°ç”¨ Builder/å®¹å™¨ï¼Ÿ

- [ ] **builderæ˜¯.netæœåŠ¡å™¨æ¡†æ¶ç‹¬æœ‰çš„è®¾è®¡å—ï¼Ÿ**

`Builder`ï¼ˆæ„å»ºå™¨ï¼‰æ¨¡å¼å’Œä¾èµ–æ³¨å…¥å®¹å™¨å¹¶é.NETçš„â€œä¸“åˆ©â€ï¼Œå®ƒä»¬æ˜¯ç°ä»£è½¯ä»¶å¼€å‘ä¸­éå¸¸æ™®éçš„è®¾è®¡æ€æƒ³ã€‚å¾ˆå¤šä½ å¬è¿‡çš„æµè¡Œæ¡†æ¶éƒ½åœ¨ä½¿ç”¨ã€‚

ä¸‹é¢çš„è¡¨æ ¼å¯¹æ¯”äº†ä¸åŒè¯­è¨€å’Œæ¡†æ¶ä¸­çš„å®ç°ï¼š

| è¯­è¨€/å¹³å°                 | æ¡†æ¶/åº“ç¤ºä¾‹             | Builderæ¨¡å¼ä¸å®¹å™¨çš„ä½“ç°                                      |
| :------------------------ | :---------------------- | :----------------------------------------------------------- |
| **Java**                  | **Spring Boot**         | æ ¸å¿ƒæ˜¯**IoCå®¹å™¨**ï¼Œé€šè¿‡`@Service`ã€`@Autowired`ç­‰æ³¨è§£è‡ªåŠ¨ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå’Œä¾èµ–å…³ç³»ã€‚ |
| **JavaScript/TypeScript** | **FIoC**                | æä¾›**æµç•…æ„å»ºå™¨API** (`buildDIContainer().register()...`)ï¼Œç”¨äºé…ç½®å’Œæ„å»ºå®¹å™¨ã€‚ |
| **Node.js (Express)**     | **ExpressBeans**        | ä¸ºExpressæ¡†æ¶æä¾›**IoCå®¹å™¨**ï¼Œä»¥Spring Bootçš„æ–¹å¼ç»„ç»‡ä»£ç å’Œä¾èµ–ã€‚ |
| **Python**                | **Dependency Injector** | æä¾›**å®¹å™¨**ç±»æ¥å£°æ˜å¼åœ°ç»„è£…ä¾èµ–ï¼Œå¹¶é€šè¿‡è£…é¥°å™¨æ³¨å…¥ã€‚         |
| **Ruby**                  | **Injectable**          | é€šè¿‡å£°æ˜å¼**DSL**ï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰åœ¨ç±»ä¸­å®šä¹‰ä¾èµ–ï¼Œåº“è´Ÿè´£æ³¨å…¥ã€‚ |

è¿™ç§è®¾è®¡æ¨¡å¼ä¹‹æ‰€ä»¥æµè¡Œï¼Œæ˜¯å› ä¸ºå®ƒè§£å†³äº†å‡ ä¸ªå…³é”®çš„å·¥ç¨‹é—®é¢˜ï¼š

*   **æµç¨‹æ ‡å‡†åŒ–**ï¼šå°†å¤æ‚çš„åˆå§‹åŒ–æµç¨‹å°è£…èµ·æ¥ï¼Œæä¾›æ¸…æ™°ã€ä¸€è‡´çš„é…ç½®å…¥å£ã€‚
*   **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šå°† **â€œç”¨ä»€ä¹ˆâ€** ï¼ˆå£°æ˜ä¾èµ–ï¼‰å’Œ **â€œæ€ä¹ˆç»„è£…â€** ï¼ˆè§£æä¾èµ–ã€ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼‰åˆ†ç¦»å¼€ï¼Œè®©ä¸šåŠ¡ä»£ç æ›´çº¯ç²¹ã€‚
*   **çµæ´»ä¸å¯æµ‹è¯•**ï¼šä¾èµ–å…³ç³»çš„é…ç½®å¤–éƒ¨åŒ–ï¼Œä½¿å¾—æ›¿æ¢å®ç°ï¼ˆæ¯”å¦‚æµ‹è¯•æ—¶æ¢æˆæ¨¡æ‹Ÿå¯¹è±¡ï¼‰å˜å¾—éå¸¸å®¹æ˜“ã€‚

ç®€å•æ¥è¯´ï¼Œä½ å­¦ä¹ çš„ `.NET Core/ASP.NET Core` ä¸­çš„ `HostBuilder`ã€`WebApplicationBuilder` ä»¥åŠä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œå…¶å®æ˜¯è¿™ç§ä¸šç•Œé€šç”¨æœ€ä½³å®è·µåœ¨.NETå¹³å°ä¸Šçš„ä¸€ä¸ªå…·ä½“ã€ä¼˜ç§€çš„å®ç°ã€‚

å¦‚æœä½ æƒ³æ·±å…¥äº†è§£æŸä¸ªç‰¹å®šæ¡†æ¶ï¼ˆæ¯”å¦‚Javaçš„Springï¼‰æ˜¯å¦‚ä½•å®ç°è¿™ä¸€å¥—çš„ï¼Œæˆ‘å¯ä»¥ä¸ºä½ æä¾›æ›´è¯¦ç»†çš„èµ„æ–™ã€‚

# Serilogæ—¥å¿—æœåŠ¡

- [ ] **Serilogé…ç½®æ®µè¯´æ˜**

ä½ é…ç½®çš„è¿™æ®µ Serilog ä»£ç å»ºç«‹äº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ã€é«˜æ•ˆä¸”æ˜“äºç®¡ç†çš„æ—¥å¿—ç³»ç»Ÿã€‚å®ƒä½¿ç”¨äº†å…¸å‹çš„ **Fluent API**ï¼ˆé“¾å¼è°ƒç”¨ï¼‰è¿›è¡Œé…ç½®ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥é€å¥æ‹†è§£ã€‚

```c#
// é…ç½® Serilog
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", Serilog.Events.LogEventLevel.Warning)
    .MinimumLevel.Override("System", Serilog.Events.LogEventLevel.Warning)
    .Enrich.FromLogContext()
    .WriteTo.Console(
        outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}")
    .WriteTo.Async(a => a.File(
        path: "logs/server-.log",
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 30,
        outputTemplate: "{Timestamp:yyyy-MM-dd HH:mm:ss.fff} [{Level:u3}] {Message:lj}{NewLine}{Exception}"))
    .CreateLogger();
```



### ğŸ§± æ ¸å¿ƒï¼šLoggerConfiguration
`new LoggerConfiguration()` åˆ›å»ºäº†ä¸€ä¸ª**é…ç½®æ„å»ºå™¨å¯¹è±¡**ã€‚åç»­çš„æ‰€æœ‰æ–¹æ³•è°ƒç”¨éƒ½æ˜¯åœ¨ä¿®æ”¹è¿™ä¸ªå¯¹è±¡çš„é…ç½®ï¼Œç›´åˆ°æœ€å `.CreateLogger()` å°†å…¶â€œæ„å»ºâ€æˆä¸€ä¸ªå¯ç”¨çš„æ—¥å¿—è®°å½•å™¨å®ä¾‹ã€‚

ä¸‹é¢æ˜¯æ¯å¥é…ç½®çš„è¯¦ç»†è§£é‡Šï¼š

| ä»£ç è¡Œ                                                       | é…ç½®é¡¹                     | ä½œç”¨ä¸è§£é‡Š                                                   |
| :----------------------------------------------------------- | :------------------------- | :----------------------------------------------------------- |
| **`.MinimumLevel.Information()`**                            | **å…¨å±€æœ€ä½æ—¥å¿—çº§åˆ«**       | åªæœ‰çº§åˆ«ä¸º `Information` åŠæ›´é«˜çº§åˆ«ï¼ˆå¦‚ `Warning`, `Error`, `Fatal`ï¼‰çš„æ—¥å¿—äº‹ä»¶æ‰ä¼šè¢«è®°å½•ã€‚è¿™æ˜¯æ€»å¼€å…³ã€‚ |
| **`.MinimumLevel.Override(â€œMicrosoftâ€, â€¦)`** <br> **`.MinimumLevel.Override(â€œSystemâ€, â€¦)`** | **é’ˆå¯¹å‘½åç©ºé—´çš„çº§åˆ«è¦†ç›–** | å¯¹äºæ¥è‡ª `Microsoft.` å’Œ `System.` å‘½åç©ºé—´çš„æ—¥å¿—ï¼ˆé€šå¸¸æ˜¯æ¡†æ¶è‡ªèº«æ—¥å¿—ï¼‰ï¼Œå°†å…¶æœ€ä½è®°å½•çº§åˆ«æå‡è‡³ `Warning`ã€‚è¿™èƒ½æœ‰æ•ˆ**è¿‡æ»¤æ‰æ¡†æ¶å†…éƒ¨å¤§é‡ä¸é‡è¦çš„ `Information` çº§åˆ«æ—¥å¿—**ï¼Œè®©ä½ çš„åº”ç”¨æ—¥å¿—æ›´æ¸…æ™°ã€‚ |
| **`.Enrich.FromLogContext()`**                               | **æ—¥å¿—ä¸Šä¸‹æ–‡å¢å¼º**         | è¿™æ˜¯ä¸€ä¸ª**éå¸¸å¼ºå¤§**çš„åŠŸèƒ½ã€‚å®ƒå…è®¸ä½ åœ¨ä»£ç çš„æŸä¸ªèŒƒå›´å†…ï¼ˆä¾‹å¦‚ä¸€ä¸ªHTTPè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ï¼‰åŠ¨æ€åœ°é™„åŠ ä¸€äº›å±æ€§ï¼ˆå¦‚ `RequestId`, `UserId`ï¼‰ï¼Œè¿™äº›å±æ€§ä¼šè‡ªåŠ¨å‡ºç°åœ¨è¯¥èŒƒå›´å†…äº§ç”Ÿçš„æ‰€æœ‰æ—¥å¿—ä¸­ï¼Œä¾¿äºè¿½è¸ªå’Œå…³è”ã€‚ |
| **`.WriteTo.Console(â€¦)`**                                    | **æ§åˆ¶å°è¾“å‡ºï¼ˆåŒæ­¥ï¼‰**     | é…ç½®ç¬¬ä¸€ä¸ªè¾“å‡ºç›®æ ‡ï¼šæ§åˆ¶å°ã€‚å‚æ•° `outputTemplate` å®šä¹‰äº†æ—¥å¿—åœ¨æ§åˆ¶å°æ˜¾ç¤ºçš„æ ¼å¼ã€‚ |
| **`.WriteTo.Async(a => a.File(â€¦))`**                         | **æ–‡ä»¶è¾“å‡ºï¼ˆå¼‚æ­¥ï¼‰**       | é…ç½®ç¬¬äºŒä¸ªè¾“å‡ºç›®æ ‡ï¼šæ–‡ä»¶ï¼Œå¹¶**ä½¿ç”¨å¼‚æ­¥å†™å…¥**ã€‚è¿™æ˜¯**æå‡æ€§èƒ½çš„å…³é”®**ï¼Œæ—¥å¿—å†™å…¥ç£ç›˜ä¸ä¼šé˜»å¡ä¸»ä¸šåŠ¡çº¿ç¨‹ã€‚ |

### ğŸ”§ å…³é”®å‚æ•°è¯¦è§£

**1. è¾“å‡ºæ¨¡æ¿ (`outputTemplate`)**
æ¨¡æ¿ä¸­çš„èŠ±æ‹¬å· `{}` æ˜¯**å ä½ç¬¦**ï¼Œä¼šè¢«å…·ä½“çš„æ—¥å¿—ä¿¡æ¯æ›¿æ¢ï¼š
*   `{Timestamp:HH:mm:ss}`: æ—¶é—´æˆ³ï¼Œæ ¼å¼ä¸º `æ—¶:åˆ†:ç§’`ã€‚
*   `{Level:u3}`: æ—¥å¿—çº§åˆ«ï¼Œå›ºå®š3å­—ç¬¦å®½åº¦ (`INF`, `WRN`, `ERR`, `FTL`)ã€‚
*   `{Message:lj}`: æ—¥å¿—æ¶ˆæ¯æ–‡æœ¬ (`lj` è¡¨ç¤ºåŸæ ·è¾“å‡ºï¼Œå¹¶è½¬ä¹‰è¡Œ)ã€‚
*   `{NewLine}`: æ¢è¡Œç¬¦ã€‚
*   `{Exception}`: å¼‚å¸¸ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚

**2. æ–‡ä»¶è¾“å‡ºé…ç½® (`WriteTo.Async(a => a.File(...))`)**
*   **`path: "logs/server-.log"`**: æ—¥å¿—æ–‡ä»¶è·¯å¾„å’Œåç§°æ¨¡å¼ã€‚`-` å¤„ä¼šè¢«æ—¥æœŸå¡«å……ã€‚
*   **`rollingInterval: RollingInterval.Day`**: **æ»šåŠ¨ç­–ç•¥**ã€‚è¿™é‡ŒæŒ‰å¤©æ»šåŠ¨ï¼Œæ¯å¤©ç”Ÿæˆæ–°æ–‡ä»¶ï¼Œä¾‹å¦‚ `server-20240101.log`, `server-20240102.log`ã€‚
*   **`retainedFileCountLimit: 30`**: **æ–‡ä»¶ä¿ç•™ç­–ç•¥**ã€‚æœ€å¤šä¿ç•™30ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œè‡ªåŠ¨æ¸…ç†æœ€æ—§çš„ï¼Œé˜²æ­¢ç£ç›˜å æ»¡ã€‚

### ğŸš€ å·¥ä½œæµç¨‹ä¸æœ€ç»ˆç”Ÿæ•ˆ
æ•´ä¸ªé…ç½®é“¾å®Œæˆåï¼Œè°ƒç”¨ **`.CreateLogger()`** ç”Ÿæˆé…ç½®å¥½çš„ `Logger` å®ä¾‹ï¼Œå¹¶èµ‹å€¼ç»™å…¨å±€çš„ **`Log.Logger`**ï¼ˆSerilogçš„é™æ€å…¥å£ï¼‰ã€‚

ä¹‹åï¼Œåœ¨ç¨‹åºä»»ä½•åœ°æ–¹éƒ½å¯ä»¥é€šè¿‡ `Log.Information(â€œè¿™æ˜¯ä¸€æ¡æ¶ˆæ¯â€)` æ¥è®°å½•æ—¥å¿—ã€‚æ—¥å¿—äº‹ä»¶ä¼šå…ˆç»è¿‡**çº§åˆ«è¿‡æ»¤**ï¼Œç„¶åè¢«**ä¸Šä¸‹æ–‡å¢å¼º**ï¼Œæœ€å**åŒæ—¶**æµå‘é…ç½®å¥½çš„ä¸¤ä¸ªè¾“å‡ºç›®æ ‡ï¼ˆæ§åˆ¶å°å’Œå¼‚æ­¥æ–‡ä»¶ï¼‰ã€‚

```csharp
// åœ¨ä»£ç ä¸­ä½¿ç”¨
Log.Information("ç”¨æˆ· {UserName} ç™»å½•æˆåŠŸ", â€œå°æ˜â€);
// æ§åˆ¶å°è¾“å‡ºï¼š[14:05:22 INF] ç”¨æˆ· â€œå°æ˜â€ ç™»å½•æˆåŠŸ
// æ—¥å¿—æ–‡ä»¶è¾“å‡ºï¼š2024-01-01 14:05:22.123 [INF] ç”¨æˆ· â€œå°æ˜â€ ç™»å½•æˆåŠŸ
```

### ğŸ’¡ æ€»ç»“ä¸æœ€ä½³å®è·µ
è¿™ä¸ªé…ç½®æ˜¯ç”Ÿäº§ç¯å¢ƒçš„ä¼˜ç§€èµ·ç‚¹ã€‚å®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ï¼š
*   **åˆ†çº§è¿‡æ»¤**ï¼šå…¨å±€è®¾ç½® + ç‰¹å®šè¦†ç›–ï¼Œä¿æŒæ—¥å¿—ç®€æ´ã€‚
*   **ä¸Šä¸‹æ–‡è¿½è¸ª**ï¼šé€šè¿‡ `LogContext` ä¸ºæ—¥å¿—æ·»åŠ â€œä¸šåŠ¡ç»´åº¦â€ã€‚
*   **å¼‚æ­¥å†™å…¥**ï¼šå…³é”®çš„**æ€§èƒ½ä¼˜åŒ–**ï¼Œç¡®ä¿æ—¥å¿—IOä¸å½±å“ä¸»ç¨‹åºæ€§èƒ½ã€‚
*   **ç»“æ„åŒ–è¾“å‡º**ï¼šæ¨¡æ¿è®©æ—¥å¿—å¯è¯»ï¼Œä¹Ÿä¸ºåç»­ç”¨å·¥å…·ï¼ˆå¦‚ELKï¼‰åˆ†ææ‰“ä¸‹åŸºç¡€ã€‚

å¦‚æœä½ åœ¨ä¹‹åçš„ä½¿ç”¨ä¸­ï¼Œæƒ³äº†è§£å¦‚ä½•æ›´æœ‰æ•ˆåœ°åˆ©ç”¨ `LogContext` æˆ–åœ¨ä¸åŒçš„ç¯å¢ƒï¼ˆå¼€å‘/ç”Ÿäº§ï¼‰ä½¿ç”¨ä¸åŒé…ç½®ï¼Œæˆ‘å¯ä»¥ä¸ºä½ æä¾›è¿›ä¸€æ­¥çš„ç¤ºä¾‹ã€‚

# SerilogExtensionæ‹“å±•æ–¹æ³•

```c#
// é…ç½® Serilog
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", Serilog.Events.LogEventLevel.Warning)
    .MinimumLevel.Override("System", Serilog.Events.LogEventLevel.Warning)
    .Enrich.FromLogContext()
    .WriteTo.Console(
        outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}")
    .WriteTo.Async(a => a.File(
        path: "logs/server-.log",
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 30,
        outputTemplate: "{Timestamp:yyyy-MM-dd HH:mm:ss.fff} [{Level:u3}] {Message:lj}{NewLine}{Exception}"))
    .CreateLogger();

try
{
    Log.Information("========================================");
    Log.Information("æ¸¸æˆæœåŠ¡å™¨å¯åŠ¨ä¸­...");
    Log.Information("========================================");

    var hostBuilder = SuperSocketHostBuilder
        .Create<GamePackage, GamePackageFilter>();
    
    hostBuilder.UseSerilog();
    ... å…¶ä»–é€»è¾‘...
}
catch
{
	...å…¶ä»–é€»è¾‘...
}
```

- [ ] **ä¸ºä»€ä¹ˆhostBuilder.UseSerilog()ï¼ŒSuperSocketçš„ç±»ä¼šæœ‰è®¾ç½®Serilogä¸ºLogç³»ç»Ÿçš„æ–¹æ³•ï¼Ÿ**

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„è§‚å¯Ÿï¼ä½ æ„Ÿåˆ°å›°æƒ‘å®Œå…¨æ­£å¸¸ï¼Œå› ä¸ºè¿™æ­£æ˜¯.NETç”Ÿæ€ä¸­ä¸€ä¸ªéå¸¸å·§å¦™å’Œå¼ºå¤§çš„ç‰¹æ€§ï¼š**æ‰©å±•æ–¹æ³•**ã€‚`hostBuilder.UseSerilog()` è¿™ä¸ªæ–¹æ³•**å¹¶ä¸æ˜¯**ç”± `SuperSocket` åº“æœ¬èº«æä¾›çš„ï¼Œè€Œæ˜¯ç”±å¦ä¸€ä¸ªå« `Serilog.Extensions.Hosting` çš„ NuGet åŒ…æä¾›çš„ã€‚

### ğŸ” æ ¸å¿ƒæœºåˆ¶ï¼šæ‰©å±•æ–¹æ³•

ç®€å•æ¥è¯´ï¼Œ**æ‰©å±•æ–¹æ³•å…è®¸ä½ â€œå‡è£…â€ä¸ºä¸€ä¸ªå·²æœ‰çš„ç±»æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œè€Œæ— éœ€ä¿®æ”¹è¿™ä¸ªç±»çš„æºä»£ç ã€‚**

`UseSerilog()` å°±æ˜¯è¿™æ ·ä¸€ä¸ªä¸º `IHostBuilder` æ¥å£ï¼ˆ`SuperSocketHostBuilder` å®ç°äº†å®ƒï¼‰æ·»åŠ çš„â€œæ‰©å±•â€æ–¹æ³•ã€‚

åŸºäºä½ æä¾›çš„å®é™…åç¼–è¯‘ä»£ç ï¼Œæˆ‘ä»¬æ¥é‡æ–°ã€ç²¾ç¡®åœ°è§£æ `UseSerilog()` è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚è¿™ä»½è§£æå¯ä»¥æˆä¸ºä½ æ¸…æ™°çš„ç¬”è®°ã€‚

### ğŸ“ æ–¹æ³•ç­¾åï¼šç†è§£å…¥å£
```csharp
public static IHostBuilder UseSerilog(
    this IHostBuilder builder, // å…³é”®ï¼šè¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹ IHostBuilder çš„â€œæ‰©å±•æ–¹æ³•â€
    ILogger logger = null,      // å‚æ•°1ï¼šå¯ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„ Serilog ILogger å®ä¾‹
    bool dispose = false,       // å‚æ•°2ï¼šæŒ‡ç¤ºæ¡†æ¶åœ¨é€€å‡ºæ—¶æ˜¯å¦å¤„ç½®ï¼ˆå…³é—­ï¼‰è¿™ä¸ª logger
    LoggerProviderCollection providers = null) // å‚æ•°3ï¼šé«˜çº§å‚æ•°ï¼Œç”¨äºä¸å…¶ä»–æ—¥å¿—æ¡†æ¶æ¡¥æ¥
```
**æ ¸å¿ƒ**ï¼šè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ª**æ‰©å±•æ–¹æ³•**ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ç”¨ `this` ä¿®é¥°ï¼Œç±»å‹ä¸º `IHostBuilder`ã€‚è¿™æ„å‘³ç€ä»»ä½•å®ç°äº† `IHostBuilder` æ¥å£çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ä½ çš„ `SuperSocketHostBuilder`ï¼‰éƒ½è‡ªåŠ¨æ‹¥æœ‰äº†ä¸€ä¸ªåä¸º `UseSerilog` çš„å®ä¾‹æ–¹æ³•ï¼Œå°½ç®¡è¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨åˆ«å¤„ã€‚æºä»£ç ï¼Œå®šä½ï¼š

```c#
using System;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Serilog.Extensions.Logging;

namespace Serilog;
public static class SerilogHostBuilderExtensions
{
public static IHostBuilder UseSerilog(this IHostBuilder builder, ILogger logger = null, bool dispose = false, LoggerProviderCollection providers = null)
{
    if (builder == null)
    {
        throw new ArgumentNullException("builder");
    }

    builder.ConfigureServices(delegate (HostBuilderContext _, IServiceCollection collection)
    {
        collection.AddSerilog(logger, dispose, providers);
    });
    return builder;
}
public static IHostBuilder UseSerilog(this IHostBuilder builder, Action<HostBuilderContext, LoggerConfiguration> configureLogger, bool preserveStaticLogger = false, bool writeToProviders = false)
{
    if (builder == null)
    {
        throw new ArgumentNullException("builder");
    }

    if (configureLogger == null)
    {
        throw new ArgumentNullException("configureLogger");
    }

    return builder.UseSerilog(delegate (HostBuilderContext hostBuilderContext, IServiceProvider services, LoggerConfiguration loggerConfiguration)
    {
        configureLogger(hostBuilderContext, loggerConfiguration);
    }, preserveStaticLogger, writeToProviders);
}
    public static IHostBuilder UseSerilog(this IHostBuilder builder, Action<HostBuilderContext, IServiceProvider, LoggerConfiguration> configureLogger, bool preserveStaticLogger = false, bool writeToProviders = false)
    {
        if (builder == null)
        {
            throw new ArgumentNullException("builder");
        }

        if (configureLogger == null)
        {
            throw new ArgumentNullException("configureLogger");
        }

        builder.ConfigureServices(delegate (HostBuilderContext context, IServiceCollection collection)
        {
            collection.AddSerilog(delegate (IServiceProvider services, LoggerConfiguration loggerConfiguration)
            {
                configureLogger(context, services, loggerConfiguration);
            }, preserveStaticLogger, writeToProviders);
        });
        return builder;
    }
}
```

### âš™ï¸ æ–¹æ³•ä½“ï¼šä¸€æ­¥æ­¥æ‹†è§£
æˆ‘ä»¬é€è¡Œåˆ†æè¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š

1.  **å‚æ•°æ ¡éªŒï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰**
    ```csharp
    if (builder == null)
    {
        throw new ArgumentNullException("builder");
    }
    ```
    ç¡®ä¿ä¼ å…¥çš„ `builder` å¯¹è±¡ä¸ä¸ºç©ºï¼Œé¿å…åç»­æ“ä½œå‡ºç° `NullReferenceException`ã€‚

2.  **æ ¸å¿ƒé…ç½®ï¼šå§”æ‰˜ç»™ä¾èµ–æ³¨å…¥ç³»ç»Ÿ**
    ```csharp
    builder.ConfigureServices(delegate (HostBuilderContext _, IServiceCollection collection)
    {
        collection.AddSerilog(logger, dispose, providers);
    });
    ```
    è¿™æ˜¯æ•´ä¸ªæ–¹æ³•çš„**çµé­‚**ã€‚å®ƒåšäº†ä¸¤ä»¶äº‹ï¼š
    *   **`builder.ConfigureServices(...)`**ï¼šè°ƒç”¨ HostBuilder è‡ªèº«çš„æ ‡å‡†æ–¹æ³•ï¼Œç”¨äºé…ç½®ä¾èµ–æ³¨å…¥å®¹å™¨ï¼ˆ`IServiceCollection`ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªâ€œæ’æ§½â€ï¼Œå…è®¸åº“åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å…¥è‡ªå·±çš„æœåŠ¡ã€‚
    *   **`collection.AddSerilog(...)`**ï¼šåœ¨é…ç½®å›è°ƒå†…éƒ¨ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ‰©å±•æ–¹æ³•ï¼ˆæ¥è‡ª `Serilog.Extensions.Logging`ï¼‰ï¼Œå°† Serilog çš„å…·ä½“æœåŠ¡ï¼ˆä¸»è¦æ˜¯ `ILoggerFactory` å’Œ `ILoggerProvider` çš„å®ç°ï¼‰æ³¨å†Œåˆ° .NET é€šç”¨çš„ `IServiceCollection` ä¸­ã€‚ä½ ä¼ å…¥çš„ `logger`, `dispose` ç­‰å‚æ•°åœ¨è¿™é‡Œè¢«ä¼ é€’ç»™å†…éƒ¨å®ç°ã€‚

3.  **è¿”å›æ„å»ºå™¨ï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰**
    ```csharp
    return builder;
    ```
    è¿”å›åŸå§‹çš„ `builder` å¯¹è±¡ã€‚è¿™æ˜¯**æµç•…æ¥å£ï¼ˆFluent Interfaceï¼‰** çš„å…¸å‹è®¾è®¡ï¼Œè®©ä½ å¯ä»¥è¿ç»­è°ƒç”¨å¤šä¸ªé…ç½®æ–¹æ³•ï¼š`builder.UseSerilog().UseSomethingElse()`ã€‚

### ğŸ”„ å®Œæ•´æµç¨‹ä¸æ•°æ®æµå›¾
è°ƒç”¨ `hostBuilder.UseSerilog()` æ—¶ï¼ŒèƒŒåå‘ç”Ÿçš„å®Œæ•´äº¤äº’å’Œ**æ•°æ®æµ**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
```c#
flowchart TD
    A[ä½ çš„ä»£ç <br>hostBuilder.UseSerilog()] --> B[â€œæ‰©å±•æ–¹æ³•<br>SerilogHostBuilderExtensions.UseSerilog()â€]
    
    B --> C{å‚æ•°æ ¡éªŒ<br>builder æ˜¯å¦ä¸º null?}
    C -- æ˜¯ --> D[æŠ›å‡º ArgumentNullException]
    C -- å¦ --> E
    
    subgraph E [æ ¸å¿ƒé…ç½®æ­¥éª¤]
        F[â€œè°ƒç”¨ builder.ConfigureServices()â€] --> G[â€œå‘å®¹å™¨æ³¨å†Œï¼š<br>collection.AddSerilog(...)â€]
    end
    
    G --> H[â€œ.NET é€šç”¨ä¾èµ–æ³¨å…¥å®¹å™¨â€]
    
    H --> I[åº”ç”¨è¿è¡Œæ—¶<br>é€šè¿‡ ILogger/ILogger<T> æ¥å£å†™å…¥æ—¥å¿—]
    I --> J[â€œSerilog çš„ Provider æ¥æ”¶æ—¥å¿—â€]
    J --> K[â€œæ ¹æ®ä½ çš„é…ç½®<br>è¾“å‡ºåˆ° Console/File ç­‰â€]
    
    B --> L[â€œè¿”å› IHostBuilder (this)â€<br>æ”¯æŒé“¾å¼è°ƒç”¨]
```

### ğŸ¯ æ€»ç»“è¦ç‚¹
*   **åŸç†**ï¼š`UseSerilog` æ˜¯ä¸€ä¸ª**æ‰©å±•æ–¹æ³•**ï¼Œå®ƒä¸ºæ‰€æœ‰ `IHostBuilder` æ·»åŠ äº†é›†æˆ Serilog çš„èƒ½åŠ›ã€‚è¿™æ˜¯ .NET ç”Ÿæ€ä¸­åº“ä¸æ¡†æ¶æ— ç¼é›†æˆçš„æ ‡å‡†æ–¹å¼ã€‚
*   **å·¥ä½œæ—¶æœº**ï¼šå®ƒåœ¨**åº”ç”¨å¯åŠ¨é…ç½®é˜¶æ®µ**è¢«è°ƒç”¨ï¼Œä½œç”¨æ˜¯å°† Serilog çš„æœåŠ¡æ³¨å†Œåˆ° .NET é€šç”¨çš„ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­ã€‚
*   **æœ¬è´¨æ“ä½œ**ï¼šå…¶æ ¸å¿ƒæ˜¯è°ƒç”¨ `builder.ConfigureServices` å’Œå†…éƒ¨çš„ `collection.AddSerilog`ï¼Œå®Œæˆäº†ä»å¾®è½¯æŠ½è±¡æ—¥å¿—æ¥å£ (`Microsoft.Extensions.Logging.ILogger`) åˆ° Serilog å…·ä½“å®ç°çš„â€œæ¡¥æ¥â€ã€‚
*   **ç»“æœ**ï¼šæ³¨å†Œå®Œæˆåï¼Œä½ åœ¨ä»£ç ä¸­é€šè¿‡ä¾èµ–æ³¨å…¥è·å–çš„ `ILogger<TCategoryName>` å®ä¾‹ï¼ŒèƒŒåå°†ç”± Serilog é©±åŠ¨ï¼Œæ—¥å¿—ä¼šæŒ‰ç…§ä½ æœ€åˆ `LoggerConfiguration` çš„è®¾ç½®è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ–‡ä»¶ã€‚
*   **è®¾è®¡æ¨¡å¼**ï¼š
    *   **æ‰©å±•æ–¹æ³•**ï¼šå®ç°â€œæ— ç¼é›†æˆâ€çš„è¯­æ³•ç³–ã€‚
    *   **ä¾èµ–æ³¨å…¥**ï¼šå®ç°è§£è€¦å’Œå¯æ›¿æ¢æ€§çš„æ ¸å¿ƒæœºåˆ¶ã€‚
    *   **æµç•…æ¥å£**ï¼šé€šè¿‡è¿”å› `builder` è‡ªèº«å®ç°ä¼˜é›…çš„é“¾å¼é…ç½®ã€‚

è¿™æ ·ï¼Œä¸¤ä¸ªç‹¬ç«‹çš„åº“ï¼ˆSuperSocket å’Œ Serilogï¼‰é€šè¿‡ .NET æ ‡å‡†åŒ–çš„ `IHostBuilder`/`ILogger` æ¥å£å’Œä¾èµ–æ³¨å…¥ç³»ç»Ÿï¼Œä»¥ä¸€ç§æ¾æ•£è€¦åˆã€æ ‡å‡†åŒ–çš„æ–¹å¼ååŒå·¥ä½œã€‚

# é…ç½®åˆå§‹åŒ–

```c#
hostBuilder.ConfigureAppConfiguration((hostCtx, configApp) =>
{
    configApp
        .SetBasePath(AppContext.BaseDirectory)
        .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
        .AddJsonFile($"appsettings.{hostCtx.HostingEnvironment.EnvironmentName}.json", optional: true)
        .AddEnvironmentVariables();
});
```

è¿™æ®µä»£ç æ˜¯ .NET Core/ASP.NET Core åº”ç”¨ç¨‹åºé…ç½®ç³»ç»Ÿçš„**æ ‡å‡†ä¸”æ ¸å¿ƒ**çš„åˆå§‹åŒ–æµç¨‹ã€‚å®ƒå®šä¹‰äº†ç¨‹åºå¦‚ä½•ä»ä¸åŒæ¥æºï¼ˆå±‚å±‚é€’è¿›ï¼‰è¯»å–é…ç½®ä¿¡æ¯ã€‚æˆ‘ä»¬é€å±‚æ‹†è§£ã€‚

### ğŸ“ æ ¸å¿ƒæµç¨‹ï¼šé…ç½®çš„æ„å»ºä¸åŠ è½½é¡ºåº
ä¸‹å›¾æ¸…æ™°åœ°å±•ç¤ºäº†è¿™æ®µä»£ç æ„å»ºçš„å®Œæ•´é…ç½®åŠ è½½æµç¨‹ä¸ä¼˜å…ˆçº§ï¼š
```c#
flowchart LR
    A[â€œå¯åŠ¨: SetBasePathâ€] --> B[â€œç¬¬ä¸€å±‚: appsettings.json<br>ï¼ˆå¿…éœ€åŸºç¡€é…ç½®ï¼‰â€]
    B --> C[â€œç¬¬äºŒå±‚: appsettings.{Environment}.json<br>ï¼ˆæŒ‰ç¯å¢ƒè¦†ç›–ï¼Œå¯é€‰ï¼‰â€]
    C --> D[â€œç¬¬ä¸‰å±‚: ç¯å¢ƒå˜é‡<br>ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œå®æ—¶è¦†ç›–ï¼‰â€]
    D --> E[â€œæœ€ç»ˆåˆå¹¶çš„ IConfiguration å¯¹è±¡â€]
```

### ğŸ” é€è¡Œè¯¦è§£
æˆ‘ä»¬æ¥æŒ‰æµç¨‹ä¸­çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†è§£ä»£ç ï¼š

1.  **`SetBasePath(AppContext.BaseDirectory)`**
    *   **ä½œç”¨**ï¼šè®¾ç½®é…ç½®æ–‡ä»¶æœç´¢çš„**æ ¹ç›®å½•**ã€‚
    *   **`AppContext.BaseDirectory`**ï¼šè¿™æ˜¯ .NET è¿è¡Œæ—¶æä¾›çš„å±æ€§ï¼ŒæŒ‡å‘ä½ **åº”ç”¨ç¨‹åºé›†ï¼ˆ.dllæˆ–.exeæ–‡ä»¶ï¼‰æ‰€åœ¨çš„ç›®å½•**ã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸‹æœ€å¯é çš„åŸºå‡†è·¯å¾„ã€‚

2.  **`.AddJsonFile(â€œappsettings.jsonâ€, optional: false, reloadOnChange: true)`**
    *   **ä½œç”¨**ï¼šåŠ è½½**ä¸»é…ç½®æ–‡ä»¶**ã€‚è¿™æ˜¯æ‰€æœ‰é…ç½®çš„åŸºçŸ³ã€‚
    *   **`optional: false`**ï¼šæ­¤æ–‡ä»¶**å¿…é¡»å­˜åœ¨**ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œç¨‹åºå¯åŠ¨æ—¶å°†æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ä¿è¯äº†åŸºç¡€é…ç½®çš„ç¡®å®šæ€§ã€‚
    *   **`reloadOnChange: true`**ï¼šè¿™æ˜¯ä¸€ä¸ª**å¼ºå¤§**çš„ç‰¹æ€§ã€‚æ„å‘³ç€åœ¨ç¨‹åº**è¿è¡Œæ—¶**ï¼Œå¦‚æœä½ ä¿®æ”¹å¹¶ä¿å­˜äº† `appsettings.json` æ–‡ä»¶ï¼Œé…ç½®ç³»ç»Ÿä¼šè‡ªåŠ¨é‡æ–°åŠ è½½å®ƒï¼Œæ— éœ€é‡å¯åº”ç”¨ã€‚è¿™å¯¹åŠ¨æ€è°ƒæ•´è®¾ç½®ï¼ˆå¦‚æ—¥å¿—çº§åˆ«ï¼‰éå¸¸æœ‰ç”¨ã€‚

3.  **`.AddJsonFile($â€appsettings.{hostCtx.HostingEnvironment.EnvironmentName}.jsonâ€, optional: true)`**
    *   **ä½œç”¨**ï¼šåŠ è½½**ç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶**ï¼Œè¿™æ˜¯å®ç°â€œå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§â€ç¯å¢ƒéš”ç¦»çš„å…³é”®ã€‚
    *   **`hostCtx.HostingEnvironment.EnvironmentName`**ï¼šè¿™æ˜¯ä» `hostCtx` ( `HostBuilderContext` ) ä¸­è·å–çš„å½“å‰**å®¿ä¸»ç¯å¢ƒåç§°**ã€‚é€šå¸¸ç”±ç³»ç»Ÿç¯å¢ƒå˜é‡ `ASPNETCORE_ENVIRONMENT` æˆ– `DOTNET_ENVIRONMENT` å†³å®šï¼ˆå¸¸è§å€¼ï¼š`Development`, `Staging`, `Production`ï¼‰ã€‚
    *   **ç¤ºä¾‹**ï¼šå¦‚æœ `EnvironmentName` æ˜¯ `â€Productionâ€`ï¼Œåˆ™ä¼šå°è¯•åŠ è½½ `appsettings.Production.json` æ–‡ä»¶ã€‚
    *   **`optional: true`**ï¼šæ­¤æ–‡ä»¶**å¯ä»¥ä¸å­˜åœ¨**ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é™é»˜è·³è¿‡ã€‚è¿™ä¸ºä¸åŒç¯å¢ƒæä¾›äº†çµæ´»çš„é…ç½®èƒ½åŠ›ã€‚

4.  **`.AddEnvironmentVariables()`**
    *   **ä½œç”¨**ï¼šä»**æ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡**ä¸­è¯»å–é…ç½®ã€‚è¿™æ˜¯**ä¼˜å…ˆçº§æœ€é«˜**çš„é…ç½®æºä¹‹ä¸€ï¼Œå¸¸ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ˆå¦‚Dockerã€K8séƒ¨ç½²ï¼‰å’Œå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚è¿æ¥å­—ç¬¦ä¸²ã€å¯†ç ï¼‰ã€‚
    *   **å‘½åè½¬æ¢**ï¼šç¯å¢ƒå˜é‡ä¸­çš„å†’å· `:` æˆ–åŒä¸‹åˆ’çº¿ `__` åœ¨é…ç½®ç³»ç»Ÿä¸­ä¼šè¢«è¯†åˆ«ä¸ºé…ç½®é”®çš„åˆ†éš”ç¬¦ `:`ã€‚
        *   ä¾‹å¦‚ï¼šç¯å¢ƒå˜é‡ `Database:ConnectionString` æˆ– `Database__ConnectionString` å¯¹åº”é…ç½®é”® `Database:ConnectionString`ã€‚

### ğŸ“š æ ¸å¿ƒæ¦‚å¿µä¸æœ€ä½³å®è·µ

*   **`hostCtx` (HostBuilderContext)**ï¼š
    è¿™æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œæä¾›äº†åœ¨é…ç½®é˜¶æ®µå¯ç”¨çš„ä¿¡æ¯ï¼Œæœ€é‡è¦çš„æ˜¯ `HostingEnvironment`ï¼ˆåŒ…å«ç¯å¢ƒåã€åº”ç”¨åç­‰ï¼‰å’Œ `Configuration`ï¼ˆæ­¤æ—¶å·²åˆæ­¥æ„å»ºçš„é…ç½®ï¼Œå¯ç”¨äºåç»­å†³ç­–ï¼‰ã€‚

*   **é…ç½®ä¼˜å…ˆçº§ï¼ˆè¦†ç›–è§„åˆ™ï¼‰**ï¼š
    **åæ·»åŠ çš„é…ç½®æºä¼šè¦†ç›–å…ˆæ·»åŠ çš„æºä¸­ç›¸åŒçš„é”®**ã€‚å› æ­¤ï¼Œæœ€ç»ˆçš„ä¼˜å…ˆçº§é¡ºåºæ˜¯ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š
    1.  `appsettings.json` ï¼ˆåŸºç¡€ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼‰
    2.  `appsettings.{Environment}.json` ï¼ˆåŸºäºç¯å¢ƒè¦†ç›–ï¼‰
    3.  **ç¯å¢ƒå˜é‡** ï¼ˆé€šå¸¸ç”¨äºéƒ¨ç½²æ—¶è¦†ç›–ï¼Œ**ä¼˜å…ˆçº§æœ€é«˜**ï¼‰

*   **å…¸å‹åœºæ™¯**ï¼š
    *   **å¼€å‘ç¯å¢ƒ** (`ASPNETCORE_ENVIRONMENT=Development`)ï¼šä¸»è¦ä½¿ç”¨ `appsettings.json` å’Œå¯é€‰çš„ `appsettings.Development.json` è¿›è¡Œè°ƒå¼é…ç½®ã€‚
    *   **ç”Ÿäº§ç¯å¢ƒ** (`ASPNETCORE_ENVIRONMENT=Production`)ï¼šä½¿ç”¨ `appsettings.json` å’Œ `appsettings.Production.json` å®šä¹‰åŸºç¡€é…ç½®ï¼Œç„¶å**é€šè¿‡Docker/K8sè®¾ç½®çš„ç¯å¢ƒå˜é‡æ³¨å…¥æ•°æ®åº“å¯†ç ã€APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯**ï¼Œç¡®ä¿å®‰å…¨ã€‚

*   **ä¸ä½ é¡¹ç›®çš„è”ç³»**ï¼š
    è¿™é‡Œæ„å»ºå‡ºçš„ `IConfiguration` å¯¹è±¡ï¼Œä¹‹åä¼šè¢«æ³¨å…¥åˆ°ä½ æ³¨å†Œçš„å„ä¸ªæœåŠ¡ï¼ˆå¦‚ `JwtService`ï¼‰çš„æ„é€ å‡½æ•°ä¸­ï¼Œä¾›å®ƒä»¬è¯»å– `Jwt:SecretKey`ã€`Redis:ConnectionString` ç­‰é…ç½®å€¼ã€‚

### ğŸ’ æ€»ç»“
è¿™æ®µä»£ç æ„å»ºäº†ä¸€ä¸ª**çµæ´»ã€åˆ†å±‚ã€ç¯å¢ƒæ„ŸçŸ¥**çš„é…ç½®ç³»ç»Ÿï¼Œæ˜¯ .NET åº”ç”¨éµå¾ªâ€œ12è¦ç´ åº”ç”¨â€æ–¹æ³•è®ºä¸­â€œé…ç½®å­˜å‚¨åœ¨ç¯å¢ƒä¸­â€åŸåˆ™çš„ç»å…¸å®ç°ã€‚å®ƒç¡®ä¿äº†åº”ç”¨èƒ½ä»æœ¬åœ°æ–‡ä»¶å®‰å…¨åœ°è¿‡æ¸¡åˆ°äº‘ç«¯éƒ¨ç½²ï¼Œæ˜¯é¡¹ç›®å¯ç»´æŠ¤æ€§å’Œå®‰å…¨æ€§çš„åŸºçŸ³ã€‚

å¦‚æœä½ æƒ³äº†è§£å¦‚ä½•åœ¨å®é™…ä»£ç ï¼ˆå¦‚ `JwtService`ï¼‰ä¸­è¯»å–è¿™äº›é…ç½®ï¼Œæˆ–è€…å¦‚ä½•ä¸ºä½ çš„æ¸¸æˆæœåŠ¡å™¨æ·»åŠ è‡ªå®šä¹‰çš„é…ç½®æºï¼ˆå¦‚ä»æ•°æ®åº“è¯»å–ï¼‰ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥è§£é‡Šã€‚

# æœåŠ¡æ„å»º

```C#
hostBuilder.ConfigureServices((hostCtx, services) =>
{
    var config = hostCtx.Configuration;

    // æ•°æ®åº“
    var connectionString = config["Database:ConnectionString"];
    services.AddDbContext<GameDbContext>(options =>
        options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString)));

    // Redis
    services.AddSingleton(sp =>
    {
        var logger = sp.GetRequiredService<ILogger<RedisService>>();
        var redisConn = config["Redis:ConnectionString"] ?? "localhost:6379";
        var redisDb = config.GetValue<int>("Redis:Database", 0);
        return new RedisService(logger, redisConn, redisDb);
    });

    // ä¸šåŠ¡æœåŠ¡
    services.AddSingleton<JwtService>();
    services.AddScoped<AuthService>();
    services.AddSingleton<PlayerManager>();

    // æ¶ˆæ¯ç½‘å…³
    services.AddSingleton<MessageGateway>();

    // æ¶ˆæ¯å¤„ç†å™¨
    services.AddScoped<LoginHandler>();
    services.AddScoped<RegisterHandler>();
    services.AddScoped<CreatePlayerHandler>();
    services.AddScoped<GetPlayerListHandler>();

    // æ³¨å†Œå¤„ç†å™¨åˆ°ç½‘å…³
    services.AddHostedService<MessageHandlerRegistration>();
});
```

è¿™æ®µ `ConfigureServices` ä»£ç æ˜¯æ‚¨æ¸¸æˆæœåŠ¡å™¨çš„**â€œå¿ƒè„æ­å»ºåŒºâ€**ï¼Œå®ƒè´Ÿè´£å°†æ‰€æœ‰çš„æ ¸å¿ƒâ€œå™¨å®˜â€ï¼ˆæœåŠ¡ï¼‰ä»¥æ­£ç¡®çš„æ–¹å¼è£…é…åˆ°â€œèº«ä½“â€ï¼ˆä¾èµ–æ³¨å…¥å®¹å™¨ï¼‰é‡Œã€‚ä¸‹é¢æˆ‘å°†æŒ‰ç…§**æ³¨å†Œç±»å‹ã€ç”Ÿå‘½å‘¨æœŸã€ä¾èµ–å…³ç³»**ä¸‰ä¸ªç»´åº¦ï¼Œä¸ºæ‚¨è¯¦ç»†è§£ææ¯ä¸€éƒ¨åˆ†ã€‚

### ğŸ“Š æœåŠ¡æ³¨å†Œæ€»è§ˆ
æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªè¡¨æ ¼ï¼Œä»æ•´ä½“ä¸Šç†è§£è¿™é‡Œæ³¨å†Œçš„æ‰€æœ‰æœåŠ¡åŠå…¶è®¾è®¡æ„å›¾ï¼š

| æ³¨å†Œä»£ç ç¤ºä¾‹                                       | æœåŠ¡ç±»å‹     | ç”Ÿå‘½å‘¨æœŸ          | å…³é”®ä¾èµ– (é€šå¸¸é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥)           | è®¾è®¡æ„å›¾ä¸è¯´æ˜                                     |
| :------------------------------------------------- | :----------- | :---------------- | :---------------------------------------- | :------------------------------------------------- |
| **`AddDbContext<GameDbContext>`**                  | æ•°æ®åº“ä¸Šä¸‹æ–‡ | **Scoped** (é»˜è®¤) | æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² (`IConfiguration`)       | æ¯ä¸ªè¯·æ±‚/ä¼šè¯ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥ï¼Œä¿è¯æ•°æ®éš”ç¦»ã€‚  |
| **`AddSingleton<RedisService>`** (å·¥å‚å‡½æ•°)        | Rediså®¢æˆ·ç«¯  | **Singleton**     | `ILogger<RedisService>`, `IConfiguration` | æ•´ä¸ªåº”ç”¨å…±äº«ä¸€ä¸ªRedisè¿æ¥æ± ï¼Œé«˜æ•ˆä¸”èŠ‚çœèµ„æºã€‚      |
| **`AddSingleton<JwtService>`**                     | JWTä»¤ç‰ŒæœåŠ¡  | **Singleton**     | `IConfiguration`                          | æ— çŠ¶æ€å·¥å…·ç±»ï¼Œå…¨å±€å•ä¾‹å³å¯ã€‚                       |
| **`AddScoped<AuthService>`**                       | è®¤è¯æœåŠ¡     | **Scoped**        | `JwtService`, `PlayerManager`ç­‰           | å¤„ç†ç”¨æˆ·ç™»å½•ç­‰è¯·æ±‚ï¼Œå¯èƒ½æ¶‰åŠç”¨æˆ·çŠ¶æ€ï¼Œé€‚åˆScopedã€‚ |
| **`AddSingleton<PlayerManager>`**                  | ç©å®¶ç®¡ç†å™¨   | **Singleton**     | (é€šå¸¸æ˜¯å†…å­˜é›†åˆæˆ–Redis)                   | ç®¡ç†å…¨å±€åœ¨çº¿ç©å®¶åˆ—è¡¨ï¼Œå¿…é¡»æ˜¯å•ä¾‹ã€‚                 |
| **`AddSingleton<MessageGateway>`**                 | æ¶ˆæ¯ç½‘å…³     | **Singleton**     | (å¯èƒ½æŒæœ‰å¤„ç†å™¨å­—å…¸)                      | æ¶ˆæ¯è·¯ç”±ä¸­å¿ƒï¼Œå…¨å±€å•ä¾‹ã€‚                           |
| **`AddScoped<LoginHandler>`**                      | æ¶ˆæ¯å¤„ç†å™¨   | **Scoped**        | `AuthService`, `GameDbContext`ç­‰          | **å…³é”®ç‚¹**ï¼šæ¯ä¸ªæ¶ˆæ¯åº”ç‹¬ç«‹å¤„ç†ï¼Œé¿å…çŠ¶æ€äº¤å‰ã€‚     |
| **`AddHostedService<MessageHandlerRegistration>`** | åå°å¯åŠ¨æœåŠ¡ | **Singleton**     | `MessageGateway`, `IServiceProvider`      | åº”ç”¨å¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡ï¼Œç”¨äºåˆå§‹åŒ–ã€‚                   |

### ğŸ” é€æ®µè¯¦è§£ä¸å†…éƒ¨åŸç†

**1. æ•°æ®åº“æ³¨å†Œï¼š`AddDbContext`**
```csharp
var connectionString = config["Database:ConnectionString"];
services.AddDbContext<GameDbContext>(options =>
    options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString)));
```
*   **`AddDbContext<T>`**ï¼šè¿™æ˜¯ `Microsoft.Extensions.DependencyInjection` æä¾›çš„ä¸€ä¸ª**æ‰©å±•æ–¹æ³•**ï¼Œä¸“é—¨ç”¨äºæ³¨å†ŒEF Coreçš„ `DbContext`ã€‚å®ƒå°† `GameDbContext` æ³¨å†Œä¸º **Scoped** ç”Ÿå‘½å‘¨æœŸã€‚
*   **`options.UseMySql(...)`**ï¼šè¿™æ˜¯ `MySql.EntityFrameworkCore` åŒ…æä¾›çš„å¦ä¸€ä¸ª**æ‰©å±•æ–¹æ³•**ï¼Œç”¨äºé…ç½®DbContextä½¿ç”¨MySQLæ•°æ®åº“ã€‚
*   **`ServerVersion.AutoDetect`**ï¼šè¿™æ˜¯ä¸€ä¸ªå®‰å…¨ä¸”æ–¹ä¾¿çš„åšæ³•ï¼Œè®©EF Coreè‡ªåŠ¨æ£€æµ‹MySQLæœåŠ¡å™¨çš„ç‰ˆæœ¬ï¼Œä»¥ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„SQLè¯­æ³•ã€‚

**2. RedisæœåŠ¡æ³¨å†Œï¼šå·¥å‚å‡½æ•°æ¨¡å¼**
```csharp
services.AddSingleton(sp =>
{
    var logger = sp.GetRequiredService<ILogger<RedisService>>();
    var redisConn = config["Redis:ConnectionString"] ?? "localhost:6379";
    var redisDb = config.GetValue<int>("Redis:Database", 0);
    return new RedisService(logger, redisConn, redisDb);
});
```
*   è¿™æ˜¯**æœ€çµæ´»**çš„æ³¨å†Œæ–¹å¼ã€‚å½“å®¹å™¨éœ€è¦åˆ›å»º `RedisService` å®ä¾‹æ—¶ï¼Œä¼šæ‰§è¡Œè¿™ä¸ªå§”æ‰˜å‡½æ•°ã€‚
*   **`sp` (IServiceProvider)**ï¼šæ˜¯å½“å‰å®¹å™¨çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¯ä»¥ç”¨æ¥è§£æ**ä¾èµ–çš„ä¾èµ–**ï¼Œæ¯”å¦‚è¿™é‡Œè§£æ `ILogger<RedisService>`ã€‚
*   **ä¸ºä»€ä¹ˆç”¨å·¥å‚ï¼Ÿ** å› ä¸º `RedisService` çš„æ„é€ å‚æ•°ï¼ˆè¿æ¥å­—ç¬¦ä¸²ã€æ•°æ®åº“ç¼–å·ï¼‰éœ€è¦ä»é…ç½®ä¸­åŠ¨æ€è¯»å–ï¼Œæ— æ³•ç”¨ç®€å•çš„ `AddSingleton<RedisService>()` å®ç°ã€‚

**3. ä¸šåŠ¡æœåŠ¡æ³¨å†Œï¼šç›´æ¥æ³¨å†Œ**
```csharp
services.AddSingleton<JwtService>();
services.AddScoped<AuthService>();
services.AddSingleton<PlayerManager>();
```
*   è¿™äº›æ˜¯æ ‡å‡†æ³¨å†Œã€‚å®¹å™¨ä¼šæ ¹æ®å…¶ç”Ÿå‘½å‘¨æœŸï¼ˆSingleton/Scopedï¼‰ç®¡ç†å®ä¾‹ï¼Œå¹¶**è‡ªåŠ¨é€’å½’è§£æå®ƒä»¬æ„é€ å‡½æ•°ä¸­çš„æ‰€æœ‰ä¾èµ–**ã€‚
*   ä¾‹å¦‚ï¼Œå½“åˆ›å»º `AuthService` æ—¶ï¼Œå®¹å™¨å‘ç°å®ƒéœ€è¦ `JwtService` å’Œ `PlayerManager`ï¼Œå°±ä¼šå…ˆå»è·å–è¿™ä¸¤ä¸ªå•ä¾‹ï¼Œç„¶åæ³¨å…¥ã€‚

**4. æ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œï¼šæ½œåœ¨é—®é¢˜**ï¼ˆå·²è§£å†³ï¼Œä¿ç•™å†…å®¹åšç»éªŒå­¦ä¹ ï¼‰

```csharp
services.AddScoped<LoginHandler>();
// ... å…¶ä»–Handler
services.AddHostedService<MessageHandlerRegistration>();
```
è¿™é‡Œå­˜åœ¨ä¸€ä¸ª**å…¸å‹çš„ç”Ÿå‘½å‘¨æœŸä¸åŒ¹é…é—®é¢˜**ï¼Œåœ¨ä¹‹å‰åˆ†æè¿‡ï¼Œè¿™é‡Œå†å¼ºè°ƒä¸€ä¸‹ï¼š
*   `MessageHandlerRegistration` æ˜¯ `Singleton`ï¼Œå®ƒåœ¨ `StartAsync` ä¸­é€šè¿‡ `scope.ServiceProvider.GetRequiredService<LoginHandler>()` **è·å–äº†ä¸€æ¬¡ `Scoped` çš„å¤„ç†å™¨å®ä¾‹**ï¼Œå¹¶æ³¨å†Œç»™äº†åŒæ ·æ˜¯ `Singleton` çš„ `MessageGateway`ã€‚
*   è¿™å¯¼è‡´æœ¬åº”æ˜¯ `Scoped`ï¼ˆæ¯æ¬¡æ¶ˆæ¯å¤„ç†ç‹¬ç«‹ï¼‰çš„ `LoginHandler` **å®ä¾‹è¢«ä¸€ä¸ªå•ä¾‹é•¿æœŸæŒæœ‰ï¼Œå˜æˆäº†â€œä¼ªå•ä¾‹â€**ã€‚å…¶åæœæ˜¯ï¼š
    1.  æ‰€æœ‰æ¶ˆæ¯å…±äº«åŒä¸€ä¸ªå¤„ç†å™¨å®ä¾‹ï¼Œå¯èƒ½å¯¼è‡´çŠ¶æ€æ··ä¹±ã€‚
    2.  å¦‚æœå¤„ç†å™¨æ³¨å…¥äº† `Scoped` çš„ `DbContext`ï¼Œé‚£ä¹ˆè¿™ä¸ª `DbContext` ä¹Ÿä¼šè¢«é•¿æœŸæŒæœ‰ï¼Œé€ æˆæ•°æ®åº“è¿æ¥æ± è€—å°½æˆ–æ•°æ®ä¸Šä¸‹æ–‡ç¼“å­˜æ±¡æŸ“ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼ˆä»£ç ä¿®æ­£æ–¹å‘ï¼‰ï¼š
`MessageGateway` ä¸åº”æŒæœ‰å¤„ç†å™¨**å®ä¾‹**ï¼Œè€Œåº”æŒæœ‰å¤„ç†å™¨**ç±»å‹**ã€‚å½“æ¯æ¬¡éœ€è¦å¤„ç†æ¶ˆæ¯æ—¶ï¼Œ`MessageGateway` ä»å½“å‰**æ–°åˆ›å»ºçš„ä¸€ä¸ªService Scope**ä¸­è§£æå‡ºå¤„ç†å™¨çš„æ–°å®ä¾‹æ¥ä½¿ç”¨ã€‚è¿™ç¡®ä¿äº†å¤„ç†å™¨åŠå…¶å†…éƒ¨çš„ `DbContext` éƒ½éµå¾ª `Scoped` ç”Ÿå‘½å‘¨æœŸã€‚ï¼ˆå·²ä¿®æ”¹ï¼Œè¯¦æƒ…æŸ¥é˜…[docs\ä¾èµ–æ³¨å…¥ç”Ÿå‘½å‘¨æœŸä¿®å¤.md]()ï¼‰

### ğŸ’ æ ¸å¿ƒæ€æƒ³æ€»ç»“
è¿™æ®µ `ConfigureServices` ä»£ç ä½“ç°äº†ä¾èµ–æ³¨å…¥çš„**ä¸¤å¤§ç²¾é«“**ï¼š
1.  **æ§åˆ¶åè½¬ (IoC)**ï¼šä½ ä¸å†è‡ªå·± `new` å¯¹è±¡ï¼Œè€Œæ˜¯å‘å®¹å™¨â€œå£°æ˜â€éœ€è¦ä»€ä¹ˆæœåŠ¡ã€ä»¥ä½•ç§ç”Ÿå‘½å‘¨æœŸä½¿ç”¨ã€‚å¯¹è±¡çš„åˆ›å»ºå’Œç»„è£…äº¤ç»™å®¹å™¨ã€‚
2.  **ä¾èµ–å€’ç½® (DIP)**ï¼šé«˜å±‚æ¨¡å—ï¼ˆå¦‚ `AuthService`ï¼‰ä¸ä¾èµ–äºä½å±‚æ¨¡å—çš„å…·ä½“å®ç°ï¼Œè€Œæ˜¯ä¾èµ–äºæŠ½è±¡ï¼ˆå¦‚æ„é€ å‡½æ•°ä¸­çš„ `JwtService`ï¼‰ã€‚è¿™ä½¿å¾—æ›¿æ¢å®ç°ï¼ˆä¾‹å¦‚æµ‹è¯•æ—¶æ³¨å…¥æ¨¡æ‹ŸæœåŠ¡ï¼‰å˜å¾—å¼‚å¸¸å®¹æ˜“ã€‚

é€šè¿‡è¿™æ ·çš„é…ç½®ï¼Œä¸€ä¸ªç»“æ„æ¸…æ™°ã€æ¾è€¦åˆã€æ˜“äºæµ‹è¯•å’Œç»´æŠ¤çš„æ¸¸æˆæœåŠ¡å™¨æ¡†æ¶å°±æ­å»ºå®Œæˆäº†ã€‚å¦‚æœæ‚¨æƒ³äº†è§£å¦‚ä½•ä¿®æ­£ä¸Šè¿°å¤„ç†å™¨ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜ï¼Œæˆ–è€…å¦‚ä½•ä¸ºè¿™äº›æœåŠ¡ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œæˆ‘å¯ä»¥æä¾›æ›´å…·ä½“çš„ä»£ç ç¤ºä¾‹ã€‚

# EF Core ä»¥åŠå…¶ä¸MySQLçš„å…³ç³»

- [ ] **EF coreæ˜¯ä»€ä¹ˆï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ•°æ®åº“æ˜¯mysqlï¼ŒäºŒè€…æœ‰ä»€ä¹ˆå…³ç³»**

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼Œå®ƒè§¦åŠäº†ç°ä»£.NETæ•°æ®è®¿é—®å±‚çš„æ ¸å¿ƒã€‚ç®€å•æ¥è¯´ï¼š**EF Core æ˜¯ä½ æ“ä½œæ•°æ®åº“çš„â€œé«˜çº§å·¥å…·â€å’Œâ€œè‡ªåŠ¨åŒ–ç¿»è¯‘å®˜â€ï¼Œè€Œ MySQL æ˜¯å­˜æ”¾æ•°æ®çš„â€œä»“åº“â€ã€‚** ä½ ç”¨ EF Core è¿™ä¸ªå·¥å…·æ¥ç®¡ç†ï¼ˆå­˜å–ã€æŸ¥è¯¢ï¼‰MySQL è¿™ä¸ªä»“åº“ã€‚

å®ƒä»¬çš„å…³ç³»å°±åƒ Android ç³»ç»Ÿï¼ˆEF Coreï¼‰å’Œä¸åŒå“ç‰Œçš„æ‰‹æœºç¡¬ä»¶ï¼ˆMySQLã€SQL Serverç­‰ï¼‰çš„å…³ç³»ã€‚EF Core å®šä¹‰äº†ä¸€å¥—ç»Ÿä¸€çš„æ“ä½œæ–¹å¼ï¼Œè€Œé’ˆå¯¹ MySQLï¼Œéœ€è¦ä¸€ä¸ªç‰¹å®šçš„â€œé©±åŠ¨ç¨‹åºâ€è®©å®ƒä»¬èƒ½æ²Ÿé€šã€‚

ä¸‹é¢è¿™å¼ å›¾æ¸…æ™°åœ°å±•ç¤ºäº†ä½ ä»£ç ä¸­çš„æ•°æ®æµï¼Œä»¥åŠEF Coreåœ¨å…¶ä¸­æ‰®æ¼”çš„è§’è‰²ï¼š

![deepseek_mermaid_20260207_8f8bce](png\deepseek_mermaid_20260207_8f8bce.png)

```c#
flowchart LR
    subgraph A [ä½ çš„ä¸šåŠ¡ä»£ç  (å¦‚ AuthService)]
        direction LR
        A1[â€œC# å¯¹è±¡<br>(å¦‚ Player ç±»)â€] 
    end

    subgraph B [EF Core æ ¸å¿ƒ]
        direction LR
        B1[â€œDbContext (GameDbContext)â€] 
        B2[â€œMySQL æä¾›ç¨‹åº<br>(Pomelo ç­‰)â€]
    end

    C[(â€œMySQL æ•°æ®åº“â€)]

    A1 -- â€œ1. æ“ä½œ (å¢åˆ æ”¹æŸ¥)â€ --> B1
    B1 -- â€œ2. ç”ŸæˆMySQLæ–¹è¨€SQLâ€ --> B2
    B2 -- â€œ3. æ‰§è¡ŒSQLå‘½ä»¤â€ --> C
    C -- â€œ4. è¿”å›æ•°æ®ç»“æœâ€ --> B2
    B2 -- â€œ5. å°†ç»“æœå°è£…ä¸ºC#å¯¹è±¡â€ --> B1
    B1 -- â€œ6. è¿”å›å¯¹è±¡ç»™ä¸šåŠ¡ä»£ç â€ --> A1
```

### ğŸ”§ è¯¦ç»†æ‹†è§£

**1. EF Core (Entity Framework Core) æ˜¯ä»€ä¹ˆï¼Ÿ**
å®ƒæ˜¯ä¸€ä¸ªç”±å¾®è½¯å¼€å‘çš„ **â€œå¯¹è±¡å…³ç³»æ˜ å°„å™¨â€** ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªå¼ºå¤§çš„**è‡ªåŠ¨åŒ–ç¿»è¯‘å’Œæ¬è¿ç³»ç»Ÿ**ã€‚
*   **â€œå¯¹è±¡â€** æŒ‡çš„æ˜¯ä½ çš„C#ç±»ï¼Œä¾‹å¦‚ `Player`ã€`Item`ã€‚
*   **â€œå…³ç³»â€** æŒ‡çš„æ˜¯ MySQL è¿™ç±»å…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ã€‚
*   **â€œæ˜ å°„â€** å°±æ˜¯ EF Core åœ¨ä¸­é—´åšçš„ç¿»è¯‘å·¥ä½œï¼šå®ƒçŸ¥é“ `Player` ç±»å¯¹åº”æ•°æ®åº“é‡Œçš„ `Players` è¡¨ï¼Œç±»çš„ `Id` å±æ€§å¯¹åº”è¡¨çš„ä¸»é”®åˆ—ã€‚

**2. MySQL æ˜¯ä»€ä¹ˆï¼Ÿ**
å®ƒæ˜¯ä¸€ä¸ªå…·ä½“çš„å…³ç³»å‹**æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ**ï¼Œè´Ÿè´£åœ¨ç£ç›˜ä¸Šå®‰å…¨ã€é«˜æ•ˆåœ°å­˜å‚¨å’Œç»“æ„åŒ–æ•°æ®ï¼ˆä»¥è¡¨çš„å½¢å¼ï¼‰ã€‚

**3. äºŒè€…åœ¨ä½ ä»£ç ä¸­çš„å…³ç³»**
ä½ çš„ä»£ç  `options.UseMySql(...)` æ­£æ˜¯è¿æ¥äºŒè€…çš„**æ¡¥æ¢**ã€‚
*   **`Microsoft.EntityFrameworkCore`**ï¼šè¿™æ˜¯ EF Core çš„æ ¸å¿ƒåŒ…ï¼Œæä¾›äº† `DbContext`ã€`DbSet` ç­‰æ ¸å¿ƒæŠ½è±¡ã€‚
*   **`Pomelo.EntityFrameworkCore.MySql`**ï¼ˆæˆ– Oracle å®˜æ–¹åŒ…ï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ª **â€œæ•°æ®åº“æä¾›ç¨‹åºâ€** ã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œ EF Core è¿™ä¸ªâ€œé€šç”¨ç¿»è¯‘å®˜â€ä¸“é—¨å­¦ä¹  **â€œMySQLæ–¹è¨€â€** çš„æ’ä»¶ã€‚
*   å½“ä½ çš„ä»£ç é€šè¿‡ `GameDbContext` æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š
    1.  ä½ å†™C#ä»£ç ï¼š`var player = await _dbContext.Players.FindAsync(1);`
    2.  EF Core çœ‹åˆ°ä½ è¦æŸ¥è¯¢ `Players` é›†åˆä¸­ ID ä¸º 1 çš„æ•°æ®ã€‚
    3.  **MySQL æä¾›ç¨‹åº** å°†è¿™ä¸ªæ“ä½œâ€œç¿»è¯‘â€æˆ MySQL èƒ½æ‡‚çš„SQLè¯­å¥ï¼š`SELECT * FROM Players WHERE Id = 1;`
    4.  æä¾›ç¨‹åºé€šè¿‡ä½ ç»™çš„è¿æ¥å­—ç¬¦ä¸²ï¼Œå‘½ä»¤ MySQL æ•°æ®åº“æ‰§è¡Œè¿™æ¡SQLã€‚
    5.  MySQL è¿”å›æ•°æ®è¡Œï¼Œæä¾›ç¨‹åºå†â€œç¿»è¯‘â€å›ä¸€ä¸ª `Player` ç±»çš„å®ä¾‹å¯¹è±¡ã€‚
    6.  ä½ å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥åœ¨C#é‡Œç”¨çš„ `player` å¯¹è±¡ã€‚

### ğŸ“ åœ¨ä½ çš„é¡¹ç›®ä¸­å¦‚ä½•ä½“ç°ï¼Ÿ
ä½ çš„ `GameDbContext` ç±»ï¼ˆç”± `AddDbContext` æ³¨å†Œï¼‰å°±æ˜¯ EF Core çš„â€œå·¥ä½œä¸­å¿ƒâ€ã€‚å®ƒå¤§æ¦‚é•¿è¿™æ ·ï¼š
```csharp
using Microsoft.EntityFrameworkCore;

public class GameDbContext : DbContext
{
    public GameDbContext(DbContextOptions<GameDbContext> options) : base(options) { }

    // æ¯ä¸ªDbSetå±æ€§å¯¹åº”æ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨
    public DbSet<Player> Players { get; set; }
    public DbSet<Item> Items { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // åœ¨è¿™é‡Œå¯ä»¥é…ç½®æ›´å¤æ‚çš„è¡¨å…³ç³»å’Œçº¦æŸ
        modelBuilder.Entity<Player>(entity =>
        {
            entity.HasKey(e => e.Id); // æŒ‡å®šä¸»é”®
            entity.Property(e => e.Name).HasMaxLength(50); // æŒ‡å®šå­—æ®µé•¿åº¦
        });
    }
}

// å¯¹åº”çš„Playerç±»ï¼ˆç§°ä¸ºâ€œå®ä½“â€ï¼‰
public class Player
{
    public int Id { get; set; }
    public string Name { get; set; }
    public int Level { get; set; }
}
```
ä¹‹åï¼Œåœ¨ `AuthService` æˆ– `LoginHandler` ä¸­ï¼Œä½ å°±å¯ä»¥é€šè¿‡æ³¨å…¥çš„ `GameDbContext`ï¼Œç”¨C#çš„æ–¹å¼æ“ä½œæ•°æ®ï¼Œå®Œå…¨ä¸ç”¨å†™SQLå­—ç¬¦ä¸²ã€‚

### ğŸ’¡ æ€»ç»“ä¸é€‰æ‹©
**EF Core + MySQL** çš„ç»„åˆï¼Œè®©ä½ èƒ½ä»¥**é¢å‘å¯¹è±¡**çš„ã€æ›´ç¬¦åˆ.NETå¼€å‘ä¹ æƒ¯çš„æ–¹å¼ï¼Œå®‰å…¨é«˜æ•ˆåœ°æ“ä½œMySQLæ•°æ®åº“ã€‚å®ƒè‡ªåŠ¨å¤„ç†äº†SQLç”Ÿæˆã€è¿æ¥ç®¡ç†ã€æ•°æ®æ˜ å°„ç­‰ç¹çå·¥ä½œã€‚

å¯¹äºä½ çš„æ¸¸æˆæœåŠ¡å™¨é¡¹ç›®ï¼š
*   **ä¼˜åŠ¿**ï¼šå¼€å‘é€Ÿåº¦å¿«ï¼Œä»£ç æ•´æ´ï¼Œç±»å‹å®‰å…¨ï¼Œå†…ç½®è¿ç§»å·¥å…·ï¼ˆç”¨äºç®¡ç†æ•°æ®åº“ç»“æ„å˜æ›´ï¼‰ã€‚
*   **æ³¨æ„**ï¼šåœ¨è¶…é«˜æ€§èƒ½ã€éœ€è¦æè‡´ä¼˜åŒ–SQLçš„åœºæ™¯ä¸‹ï¼ˆå¦‚å¤æ‚æŸ¥è¯¢ã€å¤§æ•°æ®æ‰¹é‡æ“ä½œï¼‰ï¼Œæœ‰æ—¶éœ€è¦ç›´æ¥ç¼–å†™SQLæˆ–ä½¿ç”¨æ›´è½»é‡çš„å·¥å…·ï¼ˆå¦‚ **Dapper**ï¼‰ã€‚ä½†å¯¹äºå¤§å¤šæ•°æ¸¸æˆä¸šåŠ¡é€»è¾‘ï¼ˆç©å®¶æ•°æ®ã€ç‰©å“ã€é‚®ä»¶ï¼‰ï¼ŒEF Core å®Œå…¨é€‚ç”¨ã€‚

æ‰€ä»¥ï¼Œè¯·æ”¾å¿ƒï¼Œä½ çš„æ¶æ„é€‰æ‹©æ˜¯æ ‡å‡†ä¸”åˆç†çš„ã€‚å¦‚æœä½ æƒ³è¿›ä¸€æ­¥äº†è§£å¦‚ä½•å®šä¹‰å®ä½“ç±»ã€è¿›è¡ŒæŸ¥è¯¢æˆ–ä½¿ç”¨â€œæ•°æ®è¿ç§»â€æ¥åˆ›å»ºæ•°æ®åº“è¡¨ï¼Œæˆ‘å¯ä»¥ç»§ç»­ä¸ºä½ è®²è§£ã€‚

# åŒ…å¤„ç†

```C#
// åŒ…å¤„ç†
hostBuilder.UsePackageHandler(async (session, package) =>
{
    var gateway = session.Server.ServiceProvider.GetRequiredService<MessageGateway>();
    await gateway.RouteMessageAsync(session, package);
});
```

è¿™æ®µä»£ç æ˜¯æ‚¨æ¸¸æˆæœåŠ¡å™¨çš„**ç½‘ç»œæ¶ˆæ¯å¤„ç†å…¥å£**ï¼Œæ˜¯å®¢æˆ·ç«¯å‘æ¥çš„æ¯ä¸ªæ•°æ®åŒ…æŠµè¾¾æœåŠ¡å™¨åçš„â€œç¬¬ä¸€ç«™â€ã€‚å®ƒç®€æ´åœ°å°†ç½‘ç»œå±‚ä¸ä¸šåŠ¡é€»è¾‘å±‚è¿æ¥èµ·æ¥ã€‚æˆ‘ä»¬æ¥è¯¦ç»†æ‹†è§£å®ƒçš„æ¯ä¸ªéƒ¨åˆ†ã€‚

### ğŸ“¦ ä»£ç ç»“æ„è§£æ

```csharp
// 1. æ³¨å†Œä¸€ä¸ªâ€œåŒ…å¤„ç†å™¨â€ä¸­é—´ä»¶
hostBuilder.UsePackageHandler(async (session, package) => // 2. å®šä¹‰å¤„ç†å§”æ‰˜
{
    // 3. åœ¨å¤„ç†å§”æ‰˜å†…éƒ¨
    var gateway = session.Server.ServiceProvider.GetRequiredService<MessageGateway>();
    await gateway.RouteMessageAsync(session, package);
});
```

### ğŸ” å‚æ•°è¯¦è§£ä¸æ•°æ®æµå‘

ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£è¿™æ®µä»£ç ä¸­çš„å…³é”®å¯¹è±¡åŠå…¶å…³ç³»ï¼Œä»¥åŠæ•°æ®æ˜¯å¦‚ä½•æµåŠ¨çš„ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„æµç¨‹å›¾ï¼š

![](png\29b5989c-7fff-494f-ae36-c38c04c45e3a.png)

```C#
flowchart TD
    A[â€œç½‘ç»œå±‚<br>æ”¶åˆ°å®¢æˆ·ç«¯åŸå§‹å­—èŠ‚æµâ€] --> B[â€œGamePackageFilter<br>è§£ç å¹¶ç”Ÿæˆ GamePackage å¯¹è±¡â€]
    B --> C[â€œåŒ…å¤„ç†å›è°ƒ<br>(async (session, package) => â€¦)â€]
    
    subgraph C [å›è°ƒå†…éƒ¨æ‰§è¡Œæµç¨‹]
        C1[â€œä» session.Server.ServiceProvider<br>è·å– MessageGateway å•ä¾‹â€]
        C2[â€œè°ƒç”¨ gateway.RouteMessageAsync(session, package)â€]
    end

    C2 --> D[â€œMessageGateway<br>æ ¹æ® package.MsgId è·¯ç”±â€]
    D --> E[â€œå¯¹åº”çš„ Scoped æ¶ˆæ¯å¤„ç†å™¨<br>(å¦‚ LoginHandler)â€]
    E --> F[â€œæ‰§è¡Œä¸šåŠ¡é€»è¾‘<br>(è®¿é—®æ•°æ®åº“ã€å‘å¸ƒå“åº”ç­‰)â€]
```

ä¸‹é¢æ˜¯å›¾ä¸­å„ç¯èŠ‚çš„è¯¦ç»†è¯´æ˜ï¼š

*   **`session` (ç±»å‹ï¼š`IAppSession`)**
    *   **æ˜¯ä»€ä¹ˆ**ï¼šä»£è¡¨ä¸€ä¸ª**å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„ç‰©ç†è¿æ¥ä¼šè¯**ã€‚æ¯å½“ä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚ä¸€ä¸ªæ¸¸æˆAppï¼‰æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨ç«¯å£ï¼ˆ33333ï¼‰ï¼ŒSuperSocketå°±ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ `session` å¯¹è±¡ã€‚
    *   **å…³é”®ä¿¡æ¯**ï¼š
        *   `session.SessionID`: è¯¥è¿æ¥çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
        *   `session.RemoteEndPoint`: å®¢æˆ·ç«¯çš„IPåœ°å€å’Œç«¯å£ã€‚
        *   `session.Server`: å½“å‰æœåŠ¡å™¨å®ä¾‹ï¼Œé€šè¿‡å®ƒå¯ä»¥è®¿é—®åˆ°**æ ¹æœåŠ¡å®¹å™¨**ï¼ˆ`ServiceProvider`ï¼‰ï¼Œè¿™æ˜¯è·å–å…¨å±€å•ä¾‹æœåŠ¡ï¼ˆå¦‚`MessageGateway`ï¼‰çš„å…³é”®ã€‚
        *   `session.SendAsync()`: é€šè¿‡æ­¤æ–¹æ³•å¯ä»¥å‘**è¯¥ç‰¹å®šå®¢æˆ·ç«¯**å‘é€æ•°æ®åŒ…ã€‚
    *   **ç”Ÿå‘½å‘¨æœŸ**ï¼šä»å®¢æˆ·ç«¯è¿æ¥å»ºç«‹å¼€å§‹ï¼Œåˆ°è¿æ¥æ–­å¼€ç»“æŸã€‚ä½ ä»£ç ä¸­ `UseSessionHandler` çš„ `onConnected` å’Œ `onClosed` äº‹ä»¶å°±æ˜¯å›´ç»•å®ƒå‘ç”Ÿçš„ã€‚

*   **`package` (ç±»å‹ï¼š`GamePackage`)**
    *   **æ˜¯ä»€ä¹ˆ**ï¼šè¿™æ˜¯ç»è¿‡ **`GamePackageFilter`** ï¼ˆä½ åœ¨ `Create` æ—¶æŒ‡å®šçš„ï¼‰è§£ç åçš„**ä¸šåŠ¡æ¶ˆæ¯å¯¹è±¡**ã€‚åŸå§‹çš„ç½‘ç»œå­—èŠ‚æµå·²ç»è¢«è§£ææˆä½ å®šä¹‰å¥½çš„ã€æ–¹ä¾¿C#æ“ä½œçš„æ ¼å¼ã€‚
    *   **å…³é”®ä¿¡æ¯**ï¼šå®ƒçš„å…·ä½“ç»“æ„ç”±ä½ å®šä¹‰ï¼Œä½†é€šå¸¸è‡³å°‘åŒ…å«ä¸€ä¸ªæ¶ˆæ¯IDï¼ˆ`MsgId`ï¼‰å’Œä¸€ä¸ªæ¶ˆæ¯ä½“ï¼ˆ`Body`ï¼‰ï¼Œç”¨äºå‘Šè¯‰æœåŠ¡å™¨â€œè¿™æ˜¯ä»€ä¹ˆæ¶ˆæ¯â€ä»¥åŠâ€œæ¶ˆæ¯å†…å®¹æ˜¯ä»€ä¹ˆâ€ã€‚ä¾‹å¦‚ï¼š
        ```csharp
        public class GamePackage {
            public MsgId MsgId { get; set; } // ä¾‹å¦‚ï¼šMsgId.Login
            public byte[] Body { get; set; } // ç™»å½•è¯·æ±‚çš„å…·ä½“æ•°æ®ï¼ˆç”¨æˆ·åã€å¯†ç ï¼‰
        }
        ```

*   **`session.Server.ServiceProvider`**
    *   **æ˜¯ä»€ä¹ˆ**ï¼šè¿™æ˜¯SuperSocketæœåŠ¡å™¨å®ä¾‹çš„**æ ¹çº§ä¾èµ–æ³¨å…¥å®¹å™¨**ã€‚
    *   **ä½œç”¨**ï¼šå®ƒæ˜¯è·å–åœ¨ `ConfigureServices` ä¸­æ³¨å†Œçš„**å•ä¾‹**æœåŠ¡çš„å…¥å£ã€‚è¿™é‡Œç”¨å®ƒæ¥è·å–å…¨å±€å”¯ä¸€çš„ `MessageGateway` å®ä¾‹ã€‚
    *   **âš ï¸ é‡è¦è­¦å‘Š**ï¼šè¿™ä¸ª `ServiceProvider` æ˜¯æ ¹å®¹å™¨ï¼Œä»ä¸­è§£æå‡ºçš„æœåŠ¡å¦‚æœæ˜¯`Scoped`ï¼Œå…¶è¡Œä¸ºä¼šä¸é¢„æœŸä¸ç¬¦ï¼ˆå®é™…ä¸Šä¼šå˜æˆä¸å•ä¾‹ç±»ä¼¼ï¼‰ã€‚å› æ­¤ï¼Œ**ä¸è¦ç”¨å®ƒæ¥è§£æ`Scoped`æœåŠ¡**ï¼ˆå¦‚ `DbContext` æˆ– `LoginHandler`ï¼‰ã€‚`Scoped`æœåŠ¡åº”åœ¨å…¶è‡ªèº«çš„ä½œç”¨åŸŸå†…åˆ›å»ºã€‚

### ğŸ’¡ ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿï¼ˆè®¾è®¡æ¨¡å¼è§£è¯»ï¼‰

è¿™ç§è®¾è®¡ä½“ç°äº† **â€œç½‘å…³è·¯ç”±â€** å’Œ **â€œå•ä¸€èŒè´£â€** çš„æ¶æ„æ€æƒ³ï¼š

1.  **ç½‘ç»œä¸ä¸šåŠ¡è§£è€¦**ï¼š
    `UsePackageHandler` åªè´Ÿè´£æ¥æ”¶ç½‘ç»œåŒ…ï¼Œå®ƒä¸å…³å¿ƒåŒ…çš„å†…å®¹ã€‚å®ƒçš„å”¯ä¸€èŒè´£å°±æ˜¯å°†åŒ…å’Œä¼šè¯äº¤ç»™æ­£ç¡®çš„ä¸šåŠ¡å¤„ç†å™¨ã€‚è¿™ä½¿ç½‘ç»œå±‚ä¿æŒå¹²å‡€ã€ç¨³å®šã€‚

2.  **é›†ä¸­å¼è·¯ç”±**ï¼š
    æ‰€æœ‰ç±»å‹çš„æ¶ˆæ¯éƒ½é€šè¿‡åŒä¸€ä¸ª `MessageGateway` å…¥å£ã€‚ç½‘å…³å†…éƒ¨æ ¹æ® `package.MsgId` æŸ¥æ‰¾å¯¹åº”çš„å¤„ç†å™¨ï¼ˆ`LoginHandler`, `RegisterHandler`ç­‰ï¼‰ï¼Œå®ç°æ¸…æ™°çš„æ¶ˆæ¯åˆ†å‘ã€‚å¦‚æœæƒ³æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹ï¼Œåªéœ€æ³¨å†Œæ–°çš„å¤„ç†å™¨å¹¶æ›´æ–°ç½‘å…³è·¯ç”±ï¼Œæ— éœ€ä¿®æ”¹ç½‘ç»œæ¥æ”¶ä»£ç ã€‚

3.  **æ”¯æŒä¸­é—´ä»¶ç®¡é“**ï¼š
    `UsePackageHandler` æ˜¯SuperSocketä¸­é—´ä»¶æ¨¡å‹çš„ä¸€éƒ¨åˆ†ã€‚ç†è®ºä¸Šï¼Œä½ å¯ä»¥åœ¨å®ƒä¹‹å‰æˆ–ä¹‹åæ’å…¥å…¶ä»–ä¸­é—´ä»¶æ¥åšè®¤è¯ã€å‹ç¼©ã€åŠ å¯†ã€ç»Ÿè®¡ç­‰ï¼Œéå¸¸çµæ´»ã€‚

### âš ï¸ æ½œåœ¨é—®é¢˜ä¸ä¼˜åŒ–

å½“å‰çš„å®ç°æœ‰ä¸€ä¸ª**æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆå’Œè®¾è®¡ç‘•ç–µ**ï¼š
```csharp
var gateway = session.Server.ServiceProvider.GetRequiredService<MessageGateway>();
```
**é—®é¢˜**ï¼š`MessageGateway` æ˜¯å•ä¾‹ï¼Œæ¯æ¬¡å¤„ç†æ¶ˆæ¯éƒ½ä»å®¹å™¨ä¸­è§£æä¸€æ¬¡ï¼Œè™½ç„¶å¼€é”€ä¸å¤§ï¼Œä½†å±äºä¸å¿…è¦çš„æ“ä½œã€‚æ›´é‡è¦çš„æ˜¯ï¼Œè¿™æš—ç¤ºäº† `MessageGateway` å¯èƒ½éœ€è¦é€šè¿‡å®¹å™¨æ¥åŠ¨æ€è§£æå¤„ç†å™¨ï¼Œè€Œæˆ‘ä»¬åœ¨å‰é¢è®¨è®ºè¿‡ï¼Œå½“å‰å®ƒå¯èƒ½ç›´æ¥æŒæœ‰äº†å¤„ç†å™¨å®ä¾‹ã€‚

**ä¼˜åŒ–å»ºè®®**ï¼š
1.  **ç›´æ¥æŒæœ‰ç½‘å…³å¼•ç”¨**ï¼šåœ¨ `UsePackageHandler` çš„å›è°ƒå¤–éƒ¨ï¼ˆå¦‚ç¨‹åºå¯åŠ¨æ—¶ï¼‰å°±è·å–ä¸€æ¬¡ `MessageGateway` å®ä¾‹ï¼Œç„¶åå›è°ƒå†…éƒ¨ç›´æ¥ä½¿ç”¨ã€‚ä½†è¿™ç§æ–¹å¼éœ€è¦é—­åŒ…æ•è·ï¼Œä¸å¤Ÿä¼˜é›…ã€‚
2.  **æ›´ä½³å®è·µ**ï¼šå°†å›è°ƒå‡½æ•°æœ¬èº«ä¹Ÿå°è£…æˆä¸€ä¸ª**å•ä¾‹æœåŠ¡**ï¼ˆä¾‹å¦‚ `PackageHandlingMiddleware`ï¼‰ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­æ³¨å…¥ `MessageGateway`ã€‚ç„¶åé€šè¿‡ `UseMiddleware<T>()` çš„æ–¹å¼æ³¨å†Œã€‚è¿™æ˜¯æ›´ç¬¦åˆä¾èµ–æ³¨å…¥åŸåˆ™çš„åšæ³•ï¼ŒSuperSocket å¯èƒ½æ”¯æŒç±»ä¼¼çš„é«˜çº§ç”¨æ³•ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™æ®µä»£ç æ˜¯æœåŠ¡å™¨**æ¶ˆæ¯æµçš„ä¸­æ¢ç¥ç»**ï¼Œå®ƒè®¾è®¡ç²¾å·§ï¼Œå°†ç½‘ç»œIOä¸ä¸šåŠ¡é€»è¾‘æ¸…æ™°åˆ†ç¦»ã€‚ç†è§£å®ƒå¯¹äºæŒæ¡æ•´ä¸ªæœåŠ¡å™¨çš„è¿ä½œè‡³å…³é‡è¦ã€‚

# ä¼šè¯å¤„ç†

```c#
// ä¼šè¯äº‹ä»¶
hostBuilder.UseSessionHandler(
    onConnected: session =>
    {
        Metrics.ActiveConnections.Inc();
        Metrics.ConnectionsTotal.WithLabels("connect").Inc();
        Log.Information("å®¢æˆ·ç«¯è¿æ¥: {SessionId} {RemoteEndPoint}",
            session.SessionID, session.RemoteEndPoint);
        return ValueTask.CompletedTask;
    },
    onClosed: (session, reason) =>
    {
        var gameData = session.GetGameData();
        
        if (gameData.PlayerId > 0)
        {
            var playerManager = session.Server.ServiceProvider.GetRequiredService<PlayerManager>();
            var player = playerManager.RemovePlayer(gameData.PlayerId);
            if (player != null)
            {
                Log.Information("ç©å®¶æ–­å¼€è¿æ¥: {PlayerId} {PlayerName}",
                    player.PlayerId, player.Name);
            }
        }

        Metrics.ActiveConnections.Dec();
        Metrics.ConnectionsTotal.WithLabels("disconnect").Inc();
        Log.Information("å®¢æˆ·ç«¯æ–­å¼€: {SessionId} Reason={Reason}",
            session.SessionID, reason);
        return ValueTask.CompletedTask;
    });
```

è¿™æ®µä»£ç æ˜¯æ‚¨æ¸¸æˆæœåŠ¡å™¨çš„**è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨**ï¼Œå®ƒå¤„ç†ä¸¤ä¸ªæœ€æ ¸å¿ƒçš„ç½‘ç»œäº‹ä»¶ï¼š**å®¢æˆ·ç«¯è¿æ¥**å’Œ**å®¢æˆ·ç«¯æ–­å¼€**ã€‚å®ƒç¡®ä¿äº†æœåŠ¡å™¨èƒ½æ­£ç¡®è·Ÿè¸ªåœ¨çº¿çŠ¶æ€ã€æ¸…ç†èµ„æºå’Œè®°å½•å…³é”®æ—¥å¿—ã€‚æˆ‘ä»¬æ¥æ·±å…¥è§£ææ¯ä¸ªéƒ¨åˆ†ã€‚

### ğŸ“– ä»£ç ç»“æ„æ¦‚è§ˆ
`hostBuilder.UseSessionHandler` æ˜¯ SuperSocket æä¾›çš„æ–¹æ³•ï¼Œç”¨äºæ³¨å†Œä¼šè¯çº§åˆ«çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤„ç†å™¨ã€‚å®ƒæœ‰ä¸¤ä¸ªä¸»è¦å‚æ•°ï¼š
- `onConnected`ï¼šå®¢æˆ·ç«¯**æˆåŠŸå»ºç«‹è¿æ¥**æ—¶è§¦å‘ã€‚
- `onClosed`ï¼šå®¢æˆ·ç«¯**è¿æ¥æ–­å¼€**æ—¶è§¦å‘ï¼ˆæ— è®ºä¸»åŠ¨æ–­å¼€è¿˜æ˜¯å¼‚å¸¸æ–­å¼€ï¼‰ã€‚

### ğŸ” å‚æ•°ä¸æ‰§è¡Œæµç¨‹è¯¦è§£

#### **1. `onConnected` äº‹ä»¶å¤„ç†å™¨**
```csharp
onConnected: session =>
{
    // 1. æ›´æ–°ç›‘æ§æŒ‡æ ‡
    Metrics.ActiveConnections.Inc(); // å½“å‰æ´»è·ƒè¿æ¥æ•° +1
    Metrics.ConnectionsTotal.WithLabels("connect").Inc(); // æ€»è¿æ¥æ•°ï¼ˆè¿æ¥ç±»å‹ï¼‰ +1
    
    // 2. è®°å½•ä¿¡æ¯æ—¥å¿—
    Log.Information("å®¢æˆ·ç«¯è¿æ¥: {SessionId} {RemoteEndPoint}",
        session.SessionID, session.RemoteEndPoint);
    
    return ValueTask.CompletedTask; // è¡¨ç¤ºæ­¤å¼‚æ­¥æ“ä½œå·²å®Œæˆ
}
```
- **è§¦å‘æ—¶æœº**ï¼šTCPæ¡æ‰‹å®Œæˆï¼ŒSuperSocket å†…éƒ¨å·²ä¸ºè¿æ¥åˆ›å»ºå¥½ `IAppSession` å®ä¾‹åã€‚
- **ä¸»è¦ä½œç”¨**ï¼š
    - **æŒ‡æ ‡ç»Ÿè®¡**ï¼šæ›´æ–° Prometheus/Grafana ç­‰ç›‘æ§ç³»ç»Ÿæ‰€éœ€çš„æŒ‡æ ‡ï¼Œç”¨äºå®æ—¶æŸ¥çœ‹æœåŠ¡å™¨è´Ÿè½½ã€‚
    - **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•è°ã€åœ¨ä»€ä¹ˆæ—¶å€™è¿äº†è¿›æ¥ï¼Œä¾¿äºé—®é¢˜è¿½è¸ªã€‚

#### **2. `onClosed` äº‹ä»¶å¤„ç†å™¨**
```csharp
onClosed: (session, reason) =>
{
    // 1. è·å–ä¼šè¯ä¸­çš„ä¸šåŠ¡æ•°æ®
    var gameData = session.GetGameData();
    
    // 2. å¦‚æœæ­¤ä¼šè¯å…³è”äº†ä¸€ä¸ªå·²ç™»å½•çš„ç©å®¶ï¼Œåˆ™è¿›è¡Œæ¸…ç†
    if (gameData.PlayerId > 0)
    {
        // 2.1 ä»å®¹å™¨è·å–å…¨å±€ç©å®¶ç®¡ç†å™¨
        var playerManager = session.Server.ServiceProvider.GetRequiredService<PlayerManager>();
        // 2.2 ä»åœ¨çº¿åˆ—è¡¨ä¸­ç§»é™¤ç©å®¶ï¼Œå¹¶è·å–è¢«ç§»é™¤çš„ç©å®¶å¯¹è±¡
        var player = playerManager.RemovePlayer(gameData.PlayerId);
        
        if (player != null)
        {
            // 2.3 è®°å½•ä¸šåŠ¡æ—¥å¿—ï¼šå“ªä¸ªç©å®¶æ–­å¼€äº†
            Log.Information("ç©å®¶æ–­å¼€è¿æ¥: {PlayerId} {PlayerName}",
                player.PlayerId, player.Name);
        }
    }

    // 3. æ›´æ–°ç›‘æ§æŒ‡æ ‡ï¼ˆä¸onConnectedå¯¹åº”ï¼‰
    Metrics.ActiveConnections.Dec(); // å½“å‰æ´»è·ƒè¿æ¥æ•° -1
    Metrics.ConnectionsTotal.WithLabels("disconnect").Inc(); // æ€»è¿æ¥æ•°ï¼ˆæ–­å¼€ç±»å‹ï¼‰ +1
    
    // 4. è®°å½•ç½‘ç»œå±‚æ—¥å¿—
    Log.Information("å®¢æˆ·ç«¯æ–­å¼€: {SessionId} Reason={Reason}",
        session.SessionID, reason);
        
    return ValueTask.CompletedTask;
}
```
- **è§¦å‘æ—¶æœº**ï¼šè¿æ¥å› ä»»ä½•åŸå› ï¼ˆå®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­ã€ç½‘ç»œå¼‚å¸¸ã€æœåŠ¡å™¨ä¸»åŠ¨è¸¢å‡ºç­‰ï¼‰æ–­å¼€**ä¹‹å**ã€‚`reason` å‚æ•°æŒ‡æ˜äº†æ–­å¼€åŸå› ã€‚
- **ä¸»è¦ä½œç”¨**ï¼š
    1.  **çŠ¶æ€æ¸…ç†**ï¼šè¿™æ˜¯**æœ€å…³é”®**çš„ä¸€æ­¥ï¼Œç¡®ä¿å½“ç©å®¶ä¸‹çº¿æ—¶ï¼ŒæœåŠ¡å™¨èƒ½åŠæ—¶ä»å†…å­˜ä¸­çš„åœ¨çº¿ç©å®¶åˆ—è¡¨ï¼ˆ`PlayerManager`ï¼‰é‡Œæ¸…é™¤ï¼Œé¿å…å‡ºç°â€œå¹½çµç©å®¶â€ã€‚
    2.  **èµ„æºé‡Šæ”¾**ï¼šæ–­å¼€æ•°æ®åº“è¿æ¥ã€é‡Šæ”¾é”ç­‰ï¼ˆå¦‚æœ `Player` å¯¹è±¡æŒæœ‰è¿™äº›èµ„æºï¼‰ã€‚
    3.  **æŒ‡æ ‡ä¸æ—¥å¿—**ï¼šæ›´æ–°ç›‘æ§çŠ¶æ€ï¼Œå¹¶è®°å½•æ–­å¼€åŸå› ç”¨äºåˆ†æç½‘ç»œç¨³å®šæ€§ï¼ˆä¾‹å¦‚ï¼Œå¤§é‡ `RemoteClosing` å¯èƒ½æ˜¯å®¢æˆ·ç«¯é—®é¢˜ï¼Œå¤§é‡ `ServerError` åˆ™éœ€è¦æ’æŸ¥æœåŠ¡å™¨ç«¯ï¼‰ã€‚

### ğŸ§© å…³é”®å¯¹è±¡ä¸æ–¹æ³•è§£æ

- **`session.GetGameData()`**ï¼šè¿™æ˜¯ä¸€ä¸ª**å…³é”®æ‰©å±•æ–¹æ³•**ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†ä¼šè¯ï¼ˆ`session`ï¼‰ä¸ä½ çš„ä¸šåŠ¡æ•°æ®ï¼ˆ`GameData`ï¼‰ç»‘å®šã€‚é€šå¸¸åœ¨ç©å®¶ç™»å½•æˆåŠŸåè°ƒç”¨ï¼Œä¾‹å¦‚ï¼š
  ```csharp
  // åœ¨LoginHandlerä¸­ï¼Œç™»å½•æˆåŠŸå
  var gameData = new GameData { PlayerId = player.Id, Username = player.Name };
  session.SetGameData(gameData); // å°†ä¸šåŠ¡æ•°æ®å­˜å‚¨åˆ°ä¼šè¯ä¸­
  ```
  `GameData` æ˜¯ä½ è‡ªå®šä¹‰çš„ç±»ï¼Œç”¨æ¥ä¿å­˜åœ¨ä¸€ä¸ªè¿æ¥çš„ç”Ÿå‘½å‘¨æœŸå†…éœ€è¦ç”¨åˆ°çš„ä¸šåŠ¡ä¿¡æ¯ã€‚`GetGameData()` å°±æ˜¯æŠŠå®ƒå–å‡ºæ¥ã€‚

- **`PlayerManager.RemovePlayer(playerId)`**ï¼šè¿™æ˜¯ä½ çš„æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ä¹‹ä¸€ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰åœ¨çº¿ç©å®¶çš„çŠ¶æ€ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå†…å­˜ä¸­çš„ `ConcurrentDictionary`ï¼‰ã€‚è°ƒç”¨ `RemovePlayer` ä¼šå°†è¯¥ç©å®¶ä»åœ¨çº¿åˆ—è¡¨ä¸­ç§»é™¤ï¼Œå¹¶å¯èƒ½è§¦å‘ä¸€äº›ä¸‹çº¿é€»è¾‘ï¼ˆå¦‚ä¿å­˜æœ€ç»ˆçŠ¶æ€ã€é€šçŸ¥å¥½å‹ç­‰ï¼‰ã€‚

- **`session.Server.ServiceProvider.GetRequiredService<PlayerManager>()`**ï¼šæ­¤å¤„åœ¨è·å– `PlayerManager` å•ä¾‹ã€‚è¿™æ˜¯ä¸€ä¸ª**æ­£ç¡®ä½†å¯ä¼˜åŒ–çš„å†™æ³•**ã€‚ç”±äº `PlayerManager` æ˜¯å•ä¾‹ï¼Œä»æ ¹å®¹å™¨è·å–æ˜¯å®‰å…¨çš„ã€‚ä½†æ›´æ¨èçš„åšæ³•æ˜¯**é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥**ï¼Œä¸è¿‡ç”±äºäº‹ä»¶å¤„ç†å™¨æ˜¯å§”æ‰˜ï¼Œç›´æ¥æ³¨å…¥æ¯”è¾ƒå›°éš¾ã€‚

### âš ï¸ æ½œåœ¨é—®é¢˜ä¸ä¼˜åŒ–å»ºè®®

1.  **æ€§èƒ½å°ä¼˜åŒ–**ï¼š`GetRequiredService` åœ¨æ¯æ¬¡æ–­å¼€æ—¶éƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œè™½ç„¶å¼€é”€ä¸å¤§ï¼Œä½†å¯ä»¥ä¼˜åŒ–ã€‚å¯ä»¥å°† `PlayerManager` ä½œä¸ºå±€éƒ¨å˜é‡åœ¨é—­åŒ…å¤–æ•è·ï¼ˆéœ€æ³¨æ„çº¿ç¨‹å®‰å…¨ï¼‰ï¼Œæˆ–è€…å°†æ•´ä¸ªäº‹ä»¶å¤„ç†å™¨å°è£…æˆä¸€ä¸ªæœ‰æ„é€ å‡½æ•°çš„ç±»ï¼ˆå¦‚ `SessionEventHandler`ï¼‰ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­æ³¨å…¥ `PlayerManager` ä¾èµ–ï¼Œä½†è¿™éœ€è¦æ¡†æ¶æ”¯æŒæ›´é«˜çº§çš„æ³¨å†Œæ–¹å¼ã€‚

2.  **è¿æ¥çŠ¶æ€çš„å®Œæ•´æ€§**ï¼š`onClosed` äº‹ä»¶æ˜¯**æœ€ç»ˆä¿è¯**ã€‚ä½†ç½‘ç»œæ–­å¼€æœ‰æ—¶å¯èƒ½æ— æ³•åŠæ—¶ã€å¯é åœ°è§¦å‘ã€‚å¯¹äºéå¸¸é‡è¦çš„ä¸šåŠ¡çŠ¶æ€ï¼ˆå¦‚ç©å®¶åœ¨å‰¯æœ¬ä¸­ï¼‰ï¼Œå»ºè®®è®¾è®¡ä¸€ä¸ª**å¿ƒè·³è¶…æ—¶æœºåˆ¶**ä½œä¸ºè¡¥å……ï¼Œåœ¨ `PlayerManager` ä¸­å®šæœŸæ£€æŸ¥ç©å®¶æœ€åæ´»è·ƒæ—¶é—´ï¼Œä¸»åŠ¨æ¸…ç†â€œåƒµå°¸â€è¿æ¥ã€‚

3.  **æ—¥å¿—çº§åˆ«**ï¼š`onConnected` å’Œ `onClosed` æ—¥å¿—å¯¹äºç›‘æ§æ˜¯å¿…è¦çš„ï¼Œä½†åœ¨é«˜å¹¶å‘ä¸‹ï¼Œæ¯æ¡è¿æ¥éƒ½è®°å½• `Information` çº§åˆ«æ—¥å¿—å¯èƒ½ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ã€‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯è€ƒè™‘å°†å…¶é™çº§ä¸º `Debug` çº§åˆ«ï¼Œæˆ–é€šè¿‡é‡‡æ ·è®°å½•ã€‚

### ğŸ’ æ€»ç»“
è¿™æ®µä¼šè¯äº‹ä»¶ä»£ç æ˜¯æœåŠ¡å™¨**ç¨³å®šæ€§å’Œå¯è§‚æµ‹æ€§çš„åŸºçŸ³**ã€‚å®ƒç¡®ä¿äº†ï¼š
- **èµ„æºä¸æ³„æ¼**ï¼šè¿æ¥å’Œç©å®¶çŠ¶æ€èƒ½è¢«æ­£ç¡®æ¸…ç†ã€‚
- **çŠ¶æ€å‡†ç¡®**ï¼š`PlayerManager` ä¸­çš„åœ¨çº¿åˆ—è¡¨å®æ—¶åæ˜ çœŸå®æƒ…å†µã€‚
- **é—®é¢˜å¯è¿½æº¯**ï¼šé€šè¿‡è¯¦ç»†çš„è¿æ¥/æ–­å¼€æ—¥å¿—å’ŒæŒ‡æ ‡ï¼Œèƒ½å¿«é€Ÿå®šä½ç½‘ç»œæˆ–å®¢æˆ·ç«¯é—®é¢˜ã€‚

å¦‚æœä½ éœ€è¦äº†è§£å¦‚ä½•å®ç° `SetGameData`/`GetGameData` æ‰©å±•æ–¹æ³•ï¼Œæˆ–è€…è®¾è®¡ä¸€ä¸ªæ›´å¥å£®çš„å¿ƒè·³ä¸è¶…æ—¶ç®¡ç†æœºåˆ¶ï¼Œæˆ‘å¯ä»¥æä¾›è¿›ä¸€æ­¥çš„ä»£ç ç¤ºä¾‹ã€‚

# æœåŠ¡å™¨é…ç½®

```c#
// æœåŠ¡å™¨é…ç½®
hostBuilder.ConfigureSuperSocket(options =>
{
    options.Name = "GameServer";
    options.AddListener(new ListenOptions
    {
        Ip = "Any",
        Port = 33333
    });
});
```

è¿™æ®µä»£ç æ˜¯æ‚¨æ¸¸æˆæœåŠ¡å™¨çš„**ç½‘ç»œå±‚æœ€ç»ˆé…ç½®**ï¼Œå®ƒå‘Šè¯‰ SuperSocket æ¡†æ¶ï¼šâ€œè¯·å¯åŠ¨ä¸€ä¸ªè¿™æ ·çš„ç½‘ç»œæœåŠ¡â€ã€‚è¿™æ®µé…ç½®è™½ç„¶ç®€çŸ­ï¼Œä½†å†³å®šäº†æœåŠ¡å™¨æœ€åŸºæœ¬ã€æœ€é‡è¦çš„è¡Œä¸ºï¼š**ç›‘å¬å“ªä¸ªåœ°å€ã€å“ªä¸ªç«¯å£**ã€‚æˆ‘ä»¬æ¥è¯¦ç»†æ‹†è§£ã€‚

### ğŸ“¦ ä»£ç ç»“æ„ä¸å±‚æ¬¡

è¿™æ˜¯å…¸å‹çš„ **Options Patternï¼ˆé€‰é¡¹æ¨¡å¼ï¼‰** é…ç½®æ–¹å¼ã€‚`ConfigureSuperSocket` æ–¹æ³•æ¥æ”¶ä¸€ä¸ª `Action<SuperSocketOptions>` å§”æ‰˜ï¼Œè®©ä½ åœ¨ä¸€ä¸ªé›†ä¸­çš„åœ°æ–¹é…ç½®æ‰€æœ‰æœåŠ¡å™¨çº§åˆ«çš„å‚æ•°ã€‚

### ğŸ” å‚æ•°è¯¦è§£

#### **1. `options.Name = "GameServer";`**
*   **ä½œç”¨**ï¼šè®¾ç½®æœåŠ¡å™¨å®ä¾‹çš„åç§°ã€‚ä¸»è¦ç”¨äº**æ—¥å¿—æ ‡è¯†å’Œç›‘æ§**ã€‚
*   **è¯¦è§£**ï¼šå½“ä½ çš„ç³»ç»Ÿä¸­æœ‰å¤šä¸ª SuperSocket æœåŠ¡å™¨å®ä¾‹ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ¸¸æˆæœåŠ¡å™¨ï¼Œä¸€ä¸ªç®¡ç†æœåŠ¡å™¨ï¼‰æ—¶ï¼Œæ­¤åç§°å¯ä»¥å¸®åŠ©ä½ åœ¨æ—¥å¿—ä¸­å¿«é€ŸåŒºåˆ†æ˜¯å“ªä¸ªæœåŠ¡å™¨äº§ç”Ÿçš„æ—¥å¿—ã€‚åœ¨ç›‘æ§ä»ªè¡¨ç›˜ä¸­ï¼ŒæŒ‡æ ‡ï¼ˆå¦‚è¿æ¥æ•°ï¼‰ä¹Ÿå¯ä»¥æŒ‰æ­¤åç§°åˆ†ç±»ã€‚

#### **2. `options.AddListener(new ListenOptions { ... })`**
è¿™æ˜¯é…ç½®çš„**æ ¸å¿ƒ**ï¼Œå®šä¹‰äº†æœåŠ¡å™¨çš„â€œé—¨ç‰Œå·â€ã€‚å®ƒåˆ›å»ºäº†ä¸€ä¸ª**ç›‘å¬ç«¯ç‚¹**ã€‚

*   **`ListenOptions.Ip = "Any"`** (æˆ– `"0.0.0.0"`)
    *   **ä½œç”¨**ï¼šæŒ‡å®šæœåŠ¡å™¨ç»‘å®šåˆ°å“ªä¸ª**ç½‘ç»œæ¥å£ï¼ˆç½‘å¡ï¼‰** ä¸Šã€‚
    *   **è¯¦è§£**ï¼šè¿™æ˜¯ä¸€ä¸ªå…³é”®çš„å®‰å…¨å’Œç½‘ç»œæ¦‚å¿µã€‚`"Any"` æ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œè¡¨ç¤ºç»‘å®šåˆ°**æœ¬æœºæ‰€æœ‰å¯ç”¨çš„IPv4ç½‘ç»œæ¥å£**ã€‚è¿™æ„å‘³ç€ï¼š
        *   å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡**æœ¬åœ°å›ç¯åœ°å€** `127.0.0.1` è¿æ¥ï¼ˆç”¨äºæœ¬æœºæµ‹è¯•ï¼‰ã€‚
        *   å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡**æœåŠ¡å™¨å±€åŸŸç½‘IP**ï¼ˆå¦‚ `192.168.1.100`ï¼‰è¿æ¥ï¼ˆç”¨äºå†…ç½‘é€šä¿¡ï¼‰ã€‚
        *   å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡**æœåŠ¡å™¨çš„å…¬ç½‘IP**è¿æ¥ï¼ˆç”¨äºäº’è”ç½‘è®¿é—®ï¼‰ã€‚
    *   **å¯¹æ¯”**ï¼šå¦‚æœä½ è®¾ç½®ä¸º `"127.0.0.1"`ï¼Œåˆ™æœåŠ¡å™¨åªæ¥å—æ¥è‡ªæœ¬æœºè‡ªèº«çš„è¿æ¥ï¼Œå¤–éƒ¨ï¼ˆåŒ…æ‹¬å±€åŸŸç½‘ï¼‰æ— æ³•è®¿é—®ã€‚è¿™å¸¸ç”¨äºå¼€å‘è°ƒè¯•ï¼Œå¢åŠ å®‰å…¨æ€§ã€‚

*   **`ListenOptions.Port = 33333`**
    *   **ä½œç”¨**ï¼šæŒ‡å®šæœåŠ¡å™¨ç›‘å¬çš„**TCPç«¯å£å·**ã€‚
    *   **è¯¦è§£**ï¼šç«¯å£å·æ˜¯ç½‘ç»œé€šä¿¡çš„â€œé—¨ç‰Œå·â€ã€‚å®¢æˆ·ç«¯è¿æ¥æ—¶éœ€è¦æŒ‡å®šè¿™ä¸ªç«¯å£ã€‚`33333` æ˜¯æ‚¨è‡ªå®šä¹‰çš„ä¸€ä¸ªéç‰¹æƒç«¯å£ã€‚
    *   **ç«¯å£é€‰æ‹©æ³¨æ„äº‹é¡¹**ï¼š
        *   **0-1023**ï¼šçŸ¥åç«¯å£ï¼Œé€šå¸¸éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½ç›‘å¬ï¼ˆå¦‚HTTPçš„80ç«¯å£ï¼‰ã€‚
        *   **1024-49151**ï¼šæ³¨å†Œç«¯å£ï¼Œé€šå¸¸ç”¨äºç”¨æˆ·åº”ç”¨ç¨‹åºã€‚`33333` å°±åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œæ˜¯ä¸€ä¸ªå®‰å…¨çš„é€‰æ‹©ã€‚
        *   ç¡®ä¿è¯¥ç«¯å£åœ¨æœåŠ¡å™¨é˜²ç«å¢™ï¼ˆå¦‚Windowsé˜²ç«å¢™ã€iptablesï¼‰ä¸­æ˜¯**å¼€æ”¾**çš„ï¼Œå¦åˆ™å¤–éƒ¨è¿æ¥ä¼šè¢«æ‹¦æˆªã€‚

### ğŸ’¡ å…¶ä»–é‡è¦é…ç½®é¡¹ï¼ˆæ‚¨çš„ä»£ç æœªè®¾ç½®ï¼Œä½†éœ€è¦äº†è§£ï¼‰

`SuperSocketOptions` è¿˜åŒ…å«è®¸å¤šå½±å“æœåŠ¡å™¨æ€§èƒ½å’Œè¡Œä¸ºçš„é…ç½®ï¼Œé€šå¸¸åœ¨ `ConfigureSuperSocket` ä¸­ä¸€å¹¶è®¾ç½®ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®å‚æ•°ï¼š

| é…ç½®é¡¹                                            | ä½œç”¨ä¸ç¤ºä¾‹                             | è¯´æ˜                                                         |
| :------------------------------------------------ | :------------------------------------- | :----------------------------------------------------------- |
| **`MaxConnectionNumber`**                         | `options.MaxConnectionNumber = 10000;` | æœåŠ¡å™¨å…è®¸çš„**æœ€å¤§å¹¶å‘è¿æ¥æ•°**ã€‚é˜²æ­¢è¿‡é‡è¿æ¥è€—å°½æœåŠ¡å™¨èµ„æºã€‚ |
| **`ReceiveBufferSize`** <br> **`SendBufferSize`** | `options.ReceiveBufferSize = 4096;`    | ä¸ºæ¯ä¸ªä¼šè¯åˆ†é…çš„**ç½‘ç»œç¼“å†²åŒºå¤§å°**ã€‚è°ƒæ•´æ­¤å€¼ä¼šå½±å“å†…å­˜å ç”¨å’Œååé‡ï¼Œéœ€æ ¹æ®å¹³å‡åŒ…å¤§å°æƒè¡¡ã€‚ |
| **`ReceiveTimeout`** <br> **`SendTimeout`**       | `options.SendTimeout = 30;`            | å‘é€å’Œæ¥æ”¶æ“ä½œçš„**è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰**ã€‚æœ‰åŠ©äºæ¸…ç†æ­»è¿æ¥ã€‚       |
| **`LogCommand`**                                  | `options.LogCommand = true;`           | æ˜¯å¦è®°å½•æ¯ä¸ªæ”¶åˆ°çš„å‘½ä»¤/åŒ…ï¼ˆç”¨äºè°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒé€šå¸¸å…³é—­ï¼‰ã€‚    |
| **`IdleSessionTimeout`**                          | `options.IdleSessionTimeout = 300;`    | **ç©ºé—²ä¼šè¯è¶…æ—¶**ï¼ˆç§’ï¼‰ã€‚è¶…è¿‡æ­¤æ—¶é—´æ— ä»»ä½•é€šä¿¡çš„è¿æ¥ä¼šè¢«æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€ï¼Œé‡Šæ”¾èµ„æºã€‚ |

ä¸€ä¸ªæ›´å®Œæ•´çš„é…ç½®ç¤ºä¾‹å¯èƒ½å¦‚ä¸‹ï¼š
```csharp
hostBuilder.ConfigureSuperSocket(options =>
{
    options.Name = "GameServer";
    options.MaxConnectionNumber = 10000; // å…è®¸1ä¸‡å¹¶å‘
    options.ReceiveBufferSize = 8192;    // æ¥æ”¶ç¼“å†²åŒº8KB
    options.SendBufferSize = 8192;       // å‘é€ç¼“å†²åŒº8KB
    options.IdleSessionTimeout = 180;    // 3åˆ†é’Ÿæ— é€šä¿¡åˆ™æ–­å¼€
    options.AddListener(new ListenOptions
    {
        Ip = "Any", // æˆ–ç‰¹å®šIPå¦‚ "192.168.1.100"
        Port = 33333
    });
});
```

### ğŸ—ï¸ è®¾è®¡æ¨¡å¼ï¼šä¸ºä»€ä¹ˆç”¨ `ConfigureSuperSocket(Action<options>)`ï¼Ÿ

è¿™ç§æ–¹å¼ä½“ç°äº†è‰¯å¥½çš„è®¾è®¡åŸåˆ™ï¼š
1.  **é›†ä¸­é…ç½®**ï¼šæ‰€æœ‰æœåŠ¡å™¨ç›¸å…³è®¾ç½®åœ¨ä¸€ä¸ªåœ°æ–¹å®Œæˆï¼Œæ¸…æ™°æ˜äº†ã€‚
2.  **å¼ºç±»å‹**ï¼š`SuperSocketOptions` æ˜¯å¼ºç±»å‹ç±»ï¼Œæœ‰æ™ºèƒ½æç¤ºå’Œç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œæ¯”åœ¨ `appsettings.json` é‡Œå†™å­—ç¬¦ä¸²æ›´å®‰å…¨ã€‚
3.  **çµæ´»æ€§**ï¼šä½ å¯ä»¥æ ¹æ®ç¯å¢ƒï¼ˆå¼€å‘ã€ç”Ÿäº§ï¼‰åŠ¨æ€è°ƒæ•´é…ç½®ã€‚ä¾‹å¦‚ï¼Œä» `IConfiguration` ä¸­è¯»å–ç«¯å£å·ï¼š
    ```csharp
    hostBuilder.ConfigureSuperSocket((context, options) =>
    {
        var config = context.Configuration;
        options.Name = config["Server:Name"];
        var port = config.GetValue<int>("Server:Port", 33333); // é»˜è®¤å€¼33333
        options.AddListener(new ListenOptions { Ip = "Any", Port = port });
    });
    ```

### âš ï¸ å®‰å…¨ä¸éƒ¨ç½²å®è·µ

*   **ç”Ÿäº§ç¯å¢ƒ**ï¼šè€ƒè™‘å°† `Ip` ç»‘å®šåˆ°å…·ä½“çš„**å†…ç½‘IP**è€Œé `"Any"`ï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œæš´éœ²é¢ã€‚å…¬ç½‘è®¿é—®é€šè¿‡è´Ÿè½½å‡è¡¡å™¨æˆ–é˜²ç«å¢™è½¬å‘ã€‚
*   **ç«¯å£å†²çª**ï¼šå¯åŠ¨æ—¶å¦‚æœç«¯å£å·²è¢«å ç”¨ï¼ŒæœåŠ¡å™¨ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚éœ€è¦ç¡®ä¿ç«¯å£å”¯ä¸€æ€§ã€‚
*   **æƒé™**ï¼šåœ¨Linuxä¸‹ï¼Œç›‘å¬1024ä»¥ä¸‹çš„ç«¯å£éœ€è¦ `root` æƒé™ã€‚é€šå¸¸åšæ³•æ˜¯è®©ç¨‹åºç›‘å¬é«˜ä½ç«¯å£ï¼ˆå¦‚33333ï¼‰ï¼Œå†ç”¨ `iptables` æˆ– `nginx` è¿›è¡Œç«¯å£è½¬å‘ã€‚

### æ”¹è¿›

æ­¤å¤„å½“å‰é‡‡ç”¨ç¡¬ç¼–ç çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­éå¸¸ä¸çµæ´»

```c#
options.AddListener(new ListenOptions { Ip = "Any", Port = port });
```

ä¿®æ”¹ä¸º

```c#
//...é…ç½®åˆå§‹åŒ–ä»£ç ...
// â­ æ„å»ºä¸´æ—¶é…ç½®å¯¹è±¡ï¼Œç”¨äºåç»­è¯»å–æœåŠ¡å™¨é…ç½®
var tempProvider = new ConfigurationBuilder()
    .SetBasePath(AppContext.BaseDirectory)
    .AddJsonFile("appsettings.json", optional: false)
    .AddEnvironmentVariables()
    .Build();
//...å…¶ä»–ä»£ç ...
// æœåŠ¡å™¨é…ç½®ï¼ˆä»é…ç½®æ–‡ä»¶è¯»å–ï¼‰
hostBuilder.ConfigureSuperSocket(options =>
{
    // ä½¿ç”¨ä¹‹å‰æ„å»ºçš„ä¸´æ—¶é…ç½®å¯¹è±¡
    options.Name = tempProvider["Server:Name"] ?? "GameServer";
    options.AddListener(new ListenOptions
    {
        Ip = tempProvider["Server:Ip"] ?? "Any",
        Port = tempProvider.GetValue<int>("Server:Port", 33333),
        BackLog = tempProvider.GetValue<int>("Server:BackLog", 100)
    });
});
```

è¯¦æƒ…è¯·çœ‹[docs\é…ç½®ç®¡ç†æœ€ä½³å®è·µ.md]()

### æ€»ç»“

è¿™çŸ­çŸ­å‡ è¡Œä»£ç ï¼Œä¸ºä½ çš„æ¸¸æˆæœåŠ¡å™¨å®‰ä¸Šäº†â€œè€³æœµâ€å’Œâ€œå˜´å·´â€ã€‚å®ƒå®šä¹‰äº†æœåŠ¡å™¨åœ¨ç½‘ç»œä¸–ç•Œä¸­çš„å”¯ä¸€åæ ‡ï¼Œæ˜¯å®¢æˆ·ç«¯èƒ½å¤ŸæˆåŠŸå»ºç«‹è¿æ¥çš„å‰æã€‚ç†è§£äº†è¿™é‡Œçš„ `Ip` å’Œ `Port`ï¼Œä½ å°±æŒæ¡äº†æœåŠ¡å™¨ç½‘ç»œé…ç½®çš„åŸºçŸ³ã€‚ç»“åˆä¹‹å‰çš„äº‹ä»¶å¤„ç†ã€ä¾èµ–æ³¨å…¥ï¼Œä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„æ¸¸æˆæœåŠ¡å™¨éª¨æ¶å°±æ­å»ºå®Œæˆäº†ã€‚

# æ¶ˆæ¯å¤„ç†å™¨æ³¨å†ŒæœåŠ¡

è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªå…¸å‹çš„ **â€œ.NET å¯åŠ¨/å…³é—­ä»»åŠ¡â€** ï¼Œå®ƒè§£å†³äº†ä¹‹å‰æˆ‘ä»¬è®¨è®ºè¿‡çš„**ScopedæœåŠ¡è¢«SingletonæŒæœ‰å¯¼è‡´ç”Ÿå‘½å‘¨æœŸé”™ä¹±**çš„æ ¸å¿ƒæ¶æ„é—®é¢˜ã€‚å®ƒåˆ©ç”¨ **â€œæ³¨å†Œç±»å‹è€Œéå®ä¾‹â€** çš„è®¾è®¡æ¨¡å¼ï¼Œä¼˜é›…åœ°å®ç°äº†æ¶ˆæ¯å¤„ç†å™¨çš„åŠ¨æ€è·¯ç”±ã€‚

### ğŸ“ ä»£ç ç»“æ„è§£æ

è¿™ä¸ªç±»å®ç°äº† `IHostedService` æ¥å£ï¼Œè¯¥æ¥å£æ˜¯ .NET é€šç”¨ä¸»æœºæ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œå®šä¹‰äº† `StartAsync` å’Œ `StopAsync` ä¸¤ä¸ªæ–¹æ³•ã€‚

| ç»„ä»¶                                | è¯´æ˜                                                         |
| :---------------------------------- | :----------------------------------------------------------- |
| **`IHostedService` æ¥å£**           | å…è®¸åœ¨åº”ç”¨å¯åŠ¨å’Œå…³é—­æ—¶æ‰§è¡Œåå°ä»»åŠ¡ã€‚ä½ çš„æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨æ‰€æœ‰å®ç°äº†æ­¤æ¥å£çš„æœåŠ¡çš„ `StartAsync` æ–¹æ³•ã€‚ |
| **`MessageHandlerRegistration` ç±»** | è¯¥æœåŠ¡çš„**å”¯ä¸€èŒè´£**å°±æ˜¯åœ¨åº”ç”¨å¯åŠ¨çš„åˆé€‚æ—¶æœºï¼Œå®Œæˆæ¶ˆæ¯å¤„ç†å™¨åˆ°ç½‘å…³çš„æ³¨å†Œã€‚ |
| **`StartAsync` æ–¹æ³•**               | **å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡**ã€‚è¿™æ˜¯æ³¨å†Œæ“ä½œçš„â€œå®‰å…¨å±‹â€ï¼Œæ­¤æ—¶ä¾èµ–æ³¨å…¥å®¹å™¨å·²å®Œå…¨æ„å»ºå¥½ï¼Œæ‰€æœ‰å•ä¾‹æœåŠ¡ï¼ˆå¦‚ `MessageGateway`ï¼‰å·²å°±ç»ªã€‚ |
| **æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥**                | `MessageGateway` ä½œä¸ºå•ä¾‹æœåŠ¡ï¼Œåœ¨åˆ›å»º `MessageHandlerRegistration` å®ä¾‹æ—¶ç”±å®¹å™¨è‡ªåŠ¨æ³¨å…¥ã€‚ |

### âš™ï¸ å·¥ä½œæµç¨‹ä¸æ•°æ®æµå‘

ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£è¿™æ®µä»£ç å¦‚ä½•ä¸æ¶ˆæ¯ç½‘å…³ã€å¤„ç†å™¨ååŒå·¥ä½œï¼Œè§£å†³ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ä¿®å¤å‰åçš„æ ¸å¿ƒæ•°æ®æµå¯¹æ¯”ï¼š

<img src="png\deepseek_mermaid_20260207_20b5b8.png" alt="deepseek_mermaid_20260207_20b5b8" style="zoom:200%;" />

```c#
flowchart
    subgraph A [â€œä¿®å¤å‰ï¼ˆé—®é¢˜æ¨¡å¼ï¼‰â€]
        A1[â€œHostedService å¯åŠ¨â€]
        A2[â€œä»å®¹å™¨è·å– Scoped å¤„ç†å™¨å®ä¾‹â€]
        A3[â€œå°†å¤„ç†å™¨å®ä¾‹æ³¨å…¥ Singleton Gatewayâ€]
        A4[â€œåæœ: Gateway é•¿æœŸæŒæœ‰ Scoped å®ä¾‹<br>æ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€å®ä¾‹å’Œ DbContextâ€]
    end

    subgraph B [â€œä¿®å¤åï¼ˆå½“å‰æ¨¡å¼ï¼‰â€]
        B1[â€œHostedService å¯åŠ¨â€]
        B2[â€œå‘ Gateway æ³¨å†Œå¤„ç†å™¨ç±»å‹<br>å¦‚ RegisterHandler&lt;LoginHandler&gt;â€]
        B3[â€œè¯·æ±‚åˆ°è¾¾æ—¶ Gateway åˆ›å»ºæ–°ä½œç”¨åŸŸâ€]
        B4[â€œä»æ–°ä½œç”¨åŸŸè§£æå¤„ç†å™¨ç±»å‹<br>è·å¾—å…¨æ–°çš„å¤„ç†å™¨åŠ DbContext å®ä¾‹â€]
    end

    A1 --> A2 --> A3 --> A4
    B1 --> B2 --> B3 --> B4
```

ä¸Šå›¾æ¸…æ™°åœ°å±•ç¤ºäº†ä¿®å¤çš„å…³é”®ï¼š**ä»â€œæŒæœ‰å®ä¾‹â€å˜ä¸ºâ€œæŒæœ‰ç±»å‹â€**ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ·±å…¥çœ‹çœ‹å›¾ä¸­æ¯ä¸€æ­¥çš„å…·ä½“ä»£ç å®ç°ã€‚

### ğŸ”§ å…³é”®æ–¹æ³•è¯¦è§£ï¼š`StartAsync`
è¿™æ˜¯æ•´ä¸ªæœåŠ¡çš„æ ¸å¿ƒï¼Œå®ƒè°ƒç”¨äº† `MessageGateway` çš„ `RegisterHandler<T>` æ–¹æ³•ã€‚è¯·æ³¨æ„è¿™é‡Œçš„æ³›å‹å‚æ•° `<T>`ï¼Œè¿™æ˜¯**ç±»å‹å®‰å…¨**å’Œ**è§£å†³ç”Ÿå‘½å‘¨æœŸé—®é¢˜**çš„å…³é”®ã€‚

```csharp
_gateway.RegisterHandler<LoginHandler>(MsgId.Login);
```
è¿™è¡Œä»£ç çš„å«ä¹‰æ˜¯ï¼š**â€œç½‘å…³ï¼Œè¯·è®°ä½ï¼Œå½“æ”¶åˆ° `MsgId.Login` æ¶ˆæ¯æ—¶ï¼Œä½ åº”è¯¥å»åˆ›å»ºï¼ˆæˆ–è·å–ï¼‰ä¸€ä¸ª `LoginHandler` ç±»å‹çš„å®ä¾‹æ¥å¤„ç†å®ƒï¼Œè€Œä¸æ˜¯ç°åœ¨å°±ç»™ä½ ä¸€ä¸ªç°æˆçš„ `LoginHandler` å¯¹è±¡ã€‚â€**

è¿™ç§è®¾è®¡å¸¦æ¥äº†ä»¥ä¸‹æ ¹æœ¬æ€§æ”¹å˜ï¼š

| æ³¨å†Œæ–¹å¼         | æ³¨å†Œæ—¶                         | å¤„ç†æ¶ˆæ¯æ—¶                               | ç”Ÿå‘½å‘¨æœŸ                             | ç»“æœ                                                   |
| :--------------- | :----------------------------- | :--------------------------------------- | :----------------------------------- | :----------------------------------------------------- |
| **æ—§ï¼šæ³¨å†Œå®ä¾‹** | åˆ›å»ºå¹¶æŒæœ‰ `LoginHandler` å®ä¾‹ | ç›´æ¥è°ƒç”¨å·²æŒæœ‰çš„å®ä¾‹                     | `Scoped` å®ä¾‹è¢« `Singleton` é•¿æœŸæŒæœ‰ | **âŒ é”™ä¹±**ï¼šæ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä¸ªå¤„ç†å™¨å’Œå®ƒçš„ `DbContext` |
| **æ–°ï¼šæ³¨å†Œç±»å‹** | ä»…è®°å½• `typeof(LoginHandler)`  | ä»å½“å‰ä½œç”¨åŸŸåˆ›å»ºæ–°çš„ `LoginHandler` å®ä¾‹ | æ¯æ¬¡è¯·æ±‚éƒ½è·å¾—ç‹¬ç«‹çš„ `Scoped` å®ä¾‹   | **âœ… æ­£ç¡®**ï¼šæ¯ä¸ªè¯·æ±‚æœ‰ç‹¬ç«‹çš„å¤„ç†å™¨å’Œ `DbContext`       |

### ğŸ—ï¸ æ¶æ„ä¼˜åŠ¿

è¿™ç§â€œæ³¨å†Œç±»å‹â€çš„æ¨¡å¼æ˜¯ .NET ä¸­é—´ä»¶å’Œæ’ä»¶ç³»ç»Ÿçš„å¸¸è§è®¾è®¡ï¼Œå®ƒå¸¦æ¥äº†ä¸‰å¤§æ ¸å¿ƒä¼˜åŠ¿ï¼š

1.  **å½»åº•è§£å†³ç”Ÿå‘½å‘¨æœŸé—®é¢˜**ï¼šå¦‚ä¸Šæ‰€è¿°ï¼Œè¿™æ˜¯æœ€ç›´æ¥çš„æ”¶ç›Šã€‚æ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šåœ¨ä¸€ä¸ªç‹¬ç«‹çš„ä½œç”¨åŸŸå†…å¤„ç†ï¼Œå…¶å†…éƒ¨çš„ `DbContext` å’Œå…¶ä»– `Scoped` æœåŠ¡éƒ½èƒ½è¢«æ­£ç¡®åˆ›å»ºå’Œé‡Šæ”¾ã€‚
2.  **æ”¯æŒå¤„ç†å™¨è‡ªèº«çš„ä¾èµ–æ³¨å…¥**ï¼šç”±äºå¤„ç†å™¨å®ä¾‹æ˜¯åœ¨éœ€è¦æ—¶**ä»å®¹å™¨ä¸­å®æ—¶è§£æ**çš„ï¼Œå› æ­¤ `LoginHandler` è‡ªå·±çš„æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥å£°æ˜ä¾èµ–ï¼ˆå¦‚ `AuthService`ã€`GameDbContext`ã€`ILogger`ï¼‰ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨æ³¨å…¥ã€‚
3.  **æå‡å¯æµ‹è¯•æ€§å’Œçµæ´»æ€§**ï¼šç½‘å…³ä¸å…·ä½“çš„å¤„ç†å™¨å®ç°å®Œå…¨è§£è€¦ã€‚ä½ å¯ä»¥è½»æ˜“åœ°ä¸ºæµ‹è¯•æä¾›ä¸€ä¸ªæ¨¡æ‹Ÿçš„å¤„ç†å™¨ç±»å‹ï¼Œæˆ–è€…åŠ¨æ€åœ°æ ¹æ®æ¡ä»¶æ³¨å†Œä¸åŒçš„å¤„ç†å™¨å®ç°ã€‚

### ğŸ’ æ€»ç»“ä¸è¡¥å……

è¿™ä¸ª `MessageHandlerRegistration` æœåŠ¡æ˜¯ä¸€ä¸ª**ä¼˜é›…çš„å¯åŠ¨åè°ƒå™¨**ã€‚å®ƒåˆ©ç”¨ .NET ä¸»æœºçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä»¥ç±»å‹å®‰å…¨çš„æ–¹å¼ï¼Œå°†åˆ†æ•£å®šä¹‰çš„æ¶ˆæ¯å¤„ç†å™¨ä¸é›†ä¸­çš„æ¶ˆæ¯è·¯ç”±ç½‘å…³è¿æ¥èµ·æ¥ã€‚

è¦è®©å®ƒå®Œç¾å·¥ä½œï¼Œä½ çš„ `MessageGateway` å†…éƒ¨çš„ `RouteMessageAsync` æ–¹æ³•éœ€è¦ç›¸åº”çš„é…åˆï¼Œå…¶æ ¸å¿ƒé€»è¾‘åº”ç±»ä¼¼äºï¼š
```csharp
public async Task RouteMessageAsync(IAppSession session, GamePackage package)
{
    // 1. æ ¹æ® package.MsgId æ‰¾åˆ°ä¹‹å‰æ³¨å†Œçš„å¤„ç†å™¨ç±»å‹ `handlerType`
    // 2. ä¸ºæœ¬æ¬¡å¤„ç†åˆ›å»ºä¸€ä¸ªæ–°çš„ä¾èµ–æ³¨å…¥ä½œç”¨åŸŸ (IServiceScope)
    using (var scope = _serviceProvider.CreateScope())
    {
        // 3. ä»æ–°ä½œç”¨åŸŸä¸­è§£æå‡ºè¯¥å¤„ç†å™¨ç±»å‹çš„å®ä¾‹
        var handler = (IMessageHandler)scope.ServiceProvider.GetRequiredService(handlerType);
        // 4. è°ƒç”¨å¤„ç†å™¨
        await handler.HandleAsync(session, package);
    } // 5. ä½œç”¨åŸŸç»“æŸï¼Œå…¶ä¸­æ‰€æœ‰ Scoped æœåŠ¡ï¼ˆå¦‚ DbContextï¼‰è¢«è‡ªåŠ¨é‡Šæ”¾
}
```

é€šè¿‡è¿™æ®µä»£ç ï¼Œä½ æˆåŠŸåœ°å°†ä¸€ä¸ªæ½œåœ¨çš„ç³»ç»Ÿæ¶æ„ç¼ºé™·ï¼Œè½¬å˜ä¸ºä¸€ä¸ªç¬¦åˆæœ€ä½³å®è·µçš„ã€å¥å£®ä¸”å¯æ‰©å±•çš„è®¾è®¡ã€‚è¿™æ˜¯ä½ ç†è§£å¹¶åº”ç”¨ä¾èµ–æ³¨å…¥ç”Ÿå‘½å‘¨æœŸå’Œ .NET ä¸»æœºæ¨¡å‹çš„ä¸€ä¸ªä¼˜ç§€èŒƒä¾‹ã€‚

# æ¶ˆæ¯ç½‘å…³

è¿™æ®µ `MessageGateway` ä»£ç æ˜¯ä½ æ¸¸æˆæœåŠ¡å™¨æ¶æ„çš„ **â€œæ¶ˆæ¯è·¯ç”±å™¨â€å’Œâ€œå¤„ç†åè°ƒå™¨â€**ï¼Œå®ƒå®Œç¾å®ç°äº†æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„æœ€ä½³å®è·µï¼Œå¹¶ä¸ `MessageHandlerRegistration` ååŒå·¥ä½œï¼Œå…±åŒè§£å†³äº†æ ¸å¿ƒçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ç»“åˆå®Œæ•´ä»£ç çš„æ·±å…¥åˆ†æã€‚

<img src="png\deepseek_mermaid_20260208_fd2f88.png" alt="deepseek_mermaid_20260208_fd2f88" style="zoom:25%;" />

### ğŸ—ºï¸ æ•´ä½“æ¶æ„ä¸æ•°æ®æµ
é¦–å…ˆï¼Œé€šè¿‡ä¸‹é¢çš„æµç¨‹å›¾ï¼Œä½ å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ä»å®¢æˆ·ç«¯æ¶ˆæ¯æŠµè¾¾ï¼Œåˆ°è¢«æ­£ç¡®å¤„ç†å™¨å¤„ç†çš„å®Œæ•´æµç¨‹ï¼Œä»¥åŠå„ä¸ªæ ¸å¿ƒç»„ä»¶ï¼ˆ`MessageGateway`ã€`MessageHandlerRegistration`ã€ä¾èµ–æ³¨å…¥å®¹å™¨ï¼‰å¦‚ä½•ååŒï¼š
```c#
sequenceDiagram
    participant C as Client
    participant S as SuperSocket
    participant G as MessageGateway
    participant MHR as MessageHandlerRegistration
    participant DI as ä¾èµ–æ³¨å…¥å®¹å™¨
    participant H as LoginHandler
    participant DB as DbContext

    Note over MHR, DI: å¯åŠ¨é˜¶æ®µ
    MHR->>G: RegisterHandler&lt;LoginHandler&gt;(MsgId.Login)
    G->>G: _handlerTypes[MsgId.Login] = typeof(LoginHandler)

    Note over C, DB: è¿è¡Œé˜¶æ®µ (ä¸€ä¸ªç™»å½•è¯·æ±‚)
    C->>S: å‘é€ç™»å½•æ•°æ®åŒ…
    S->>G: è°ƒç”¨ RouteMessageAsync(session, package)
    
    G->>G: éªŒè¯ã€æŸ¥æ‰¾ typeof(LoginHandler)
    
    G->>DI: åˆ›å»ºæ–°çš„ IServiceScope
    DI->>DI: å‡†å¤‡ä¸€ä¸ªå…¨æ–°çš„ Scoped æœåŠ¡å®¹å™¨
    
    G->>DI: scope.ServiceProvider.GetRequiredService(typeof(LoginHandler))
    DI->>H: 1. å®ä¾‹åŒ–æ–°çš„ LoginHandler<br>2. æ³¨å…¥æ–°çš„ DbContext (Scoped)<br>3. æ³¨å…¥å…¶ä»–ä¾èµ–
    G->>H: è°ƒç”¨ handler.HandleAsync(...)
    H->>DB: æ“ä½œç‹¬ç«‹çš„ DbContext æŸ¥è¯¢æ•°æ®åº“
    H->>S: å‘é€ç™»å½•å“åº”
    S->>C: è¿”å›å“åº”
    
    G->>DI: é‡Šæ”¾ IServiceScope
    DI->>DB: è‡ªåŠ¨é‡Šæ”¾ DbContext ç­‰èµ„æº
```

### âš™ï¸ æ ¸å¿ƒè®¾è®¡è¯¦è§£

**1. æ„é€ å‡½æ•°æ³¨å…¥ï¼šèƒ½åŠ›çš„åŸºçŸ³**
```csharp
private readonly IServiceProvider _serviceProvider;
public MessageGateway(ILogger<MessageGateway> logger, IServiceProvider serviceProvider)
{
    _serviceProvider = serviceProvider; // å…³é”®ï¼
}
```
*   **`IServiceProvider`**ï¼šè¿™æ˜¯æ•´ä¸ªè§£å†³æ–¹æ¡ˆçš„é’¥åŒ™ã€‚å®ƒä½¿å¾— `MessageGateway` æœ‰èƒ½åŠ›åœ¨éœ€è¦æ—¶**åˆ›å»ºæ–°çš„ä¾èµ–æ³¨å…¥ä½œç”¨åŸŸ**ï¼Œè€Œä¸å†ä¾èµ–å¤–éƒ¨ä¼ å…¥çš„æ ¹å®¹å™¨ã€‚
*   **è®¾è®¡æ„ä¹‰**ï¼šç½‘å…³è‡ªèº«ï¼ˆSingletonï¼‰åªæŒæœ‰å®¹å™¨çš„â€œå·¥å‚â€èƒ½åŠ›ï¼Œè€Œä¸æŒæœ‰ä»»ä½•å…·ä½“çš„å¤„ç†å™¨æˆ–DbContextå®ä¾‹ï¼Œä»æ ¹æºä¸Šæœç»äº†é”™è¯¯å¼•ç”¨ã€‚

**2. ç±»å‹å­—å…¸ï¼šå®‰å…¨çš„è·¯ç”±è¡¨**
```csharp
private readonly Dictionary<ushort, Type> _handlerTypes = new();
public void RegisterHandler<THandler>(ushort msgId) where THandler : IMessageHandler
{
    _handlerTypes[msgId] = typeof(THandler); // å­˜å‚¨ç±»å‹ï¼Œè€Œéå®ä¾‹
}
```
*   **æ³›å‹çº¦æŸ `where THandler : IMessageHandler`**ï¼šè¿™æ˜¯ä¸€ä¸ª**ç¼–è¯‘æ—¶å®‰å…¨**ä¿éšœã€‚å®ƒç¡®ä¿åªèƒ½æ³¨å†Œå®ç°äº† `IMessageHandler` æ¥å£çš„ç±»ï¼Œé˜²æ­¢é”™è¯¯ç±»å‹è¢«æ³¨å†Œï¼Œå¹¶åœ¨ç¼–è¯‘é˜¶æ®µå°±å‘ç°é—®é¢˜ã€‚
*   **`Type` å¯¹è±¡**ï¼šå­˜å‚¨çš„æ˜¯ç±»å‹çš„å…ƒæ•°æ®ï¼ˆè“å›¾ï¼‰ï¼Œä¸åŒ…å«ä»»ä½•çŠ¶æ€æˆ–å®ä¾‹æ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ªé‡é‡è½»ã€æ— ç”Ÿå‘½å‘¨æœŸçš„çº¯ä¿¡æ¯ã€‚

**3. è·¯ç”±ä¸ä½œç”¨åŸŸç®¡ç†ï¼šç”Ÿå‘½å‘¨æœŸçš„æ­£ç¡®å®è·µ**
è¿™æ˜¯æ•´ä¸ªç±»çš„æ ¸å¿ƒæ–¹æ³•ï¼Œå®ç°äº†æˆ‘ä»¬ç†è®ºä¸Šçš„è®¾è®¡ï¼š
```csharp
public async Task RouteMessageAsync(IAppSession session, GamePackage package)
{
    // ... æŸ¥æ‰¾ handlerType ...
    try
    {
        // â­ å…³é”®è¡Œï¼šä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ›å»ºç‹¬ç«‹çš„ä½œç”¨åŸŸ
        using var scope = _serviceProvider.CreateScope();
        // ä»æ–°ä½œç”¨åŸŸè§£æå¤„ç†å™¨
        var handler = scope.ServiceProvider.GetRequiredService(handlerType) as IMessageHandler;
        await handler.HandleAsync(session, package.Payload);
    } // â­ using è¯­å¥ç»“æŸï¼Œscope è‡ªåŠ¨é‡Šæ”¾ï¼Œå…¶ä¸­æ‰€æœ‰ Scoped æœåŠ¡ï¼ˆå¦‚ DbContextï¼‰è¢«é‡Šæ”¾
    catch (Exception ex) { ... }
}
```
*   **`using var scope`**ï¼šä½¿ç”¨ `using` è¯­å¥ç¡®ä¿ä½œç”¨åŸŸåœ¨å¤„ç†å™¨æ‰§è¡Œå®Œæ¯•å**ç«‹å³è¢«é‡Šæ”¾**ã€‚è¿™æ˜¯èµ„æºç®¡ç†çš„æœ€ä½³å®è·µï¼Œç­‰åŒäº `try-finally` å—ã€‚
*   **`scope.ServiceProvider`**ï¼šè¿™æ˜¯æœ¬æ¬¡æ¶ˆæ¯å¤„ç†çš„â€œæ²™ç›’å®¹å™¨â€ã€‚ä»è¿™é‡Œè§£æå‡ºçš„ `LoginHandler` ä»¥åŠå®ƒå†…éƒ¨ä¾èµ–çš„ `DbContext`ï¼Œéƒ½æ˜¯å…¨æ–°çš„ã€ä»…å±äºæœ¬æ¬¡è¯·æ±‚çš„å®ä¾‹ã€‚è¯·æ±‚ç»“æŸï¼Œâ€œæ²™ç›’â€è¢«æ¸…ç©ºï¼Œèµ„æºå®Œç¾å›æ”¶ã€‚

**4. ä¸šåŠ¡é€»è¾‘å¢å¼ºï¼šå®‰å…¨ä¸å¯è§‚æµ‹æ€§**
é™¤äº†æ ¸å¿ƒè·¯ç”±ï¼Œç½‘å…³è¿˜æ‰¿æ‹…äº†é‡è¦çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼š
*   **å¿ƒè·³å¤„ç† (`HandleHeartbeatAsync`)**ï¼šåœ¨è·¯ç”±å±‚ç›´æ¥å¤„ç†ï¼Œé¿å…ä¸ºé«˜é¢‘ä½é€»è¾‘æ“ä½œåˆ›å»ºä¸å¿…è¦çš„å¤„ç†å™¨å’Œæ•°æ®åº“ä½œç”¨åŸŸï¼Œæå‡æ€§èƒ½ã€‚
*   **åºåˆ—å·éªŒè¯ (`gameData.ValidateSequence`)**ï¼šåœ¨è¿›å…¥ä¸šåŠ¡å¤„ç†å™¨ä¹‹å‰è¿›è¡Œåé‡æ”¾æ”»å‡»æ ¡éªŒï¼Œæ˜¯å®‰å…¨é˜²æŠ¤çš„ç¬¬ä¸€é“å…³å¡ã€‚
*   **ç›‘æ§æŒ‡æ ‡ (`Metrics.MessageCount.Inc()`)**ï¼šè‡ªåŠ¨è®°å½•æ¯ç§æ¶ˆæ¯çš„å¤„ç†é‡å’Œé”™è¯¯é‡ï¼Œä¸ºç³»ç»Ÿå¯è§‚æµ‹æ€§æä¾›æ•°æ®ã€‚

### ğŸ”„ ä¸ `MessageHandlerRegistration` çš„å®Œç¾é…åˆ
è¿™ä¸¤ä¸ªç±»å½¢æˆäº†ä¸€ä¸ªæ¸…æ™°çš„ **â€œæ³¨å†Œ-è·¯ç”±â€åä½œæ¨¡å¼**ï¼š

| é˜¶æ®µ         | `MessageHandlerRegistration` (å¯åŠ¨æ—¶)               | `MessageGateway` (è¿è¡Œæ—¶)                                    |
| :----------- | :-------------------------------------------------- | :----------------------------------------------------------- |
| **èŒè´£**     | **å£°æ˜** â€œæœ‰å“ªäº›æ¶ˆæ¯ç±»å‹ï¼Œåˆ†åˆ«ç”±å“ªä¸ªå¤„ç†å™¨ç±»è´Ÿè´£â€ã€‚ | **æ‰§è¡Œ** â€œæ ¹æ®æ¶ˆæ¯IDï¼Œæ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨ç±»ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå®ä¾‹æ¥å¤„ç†å®ƒâ€ã€‚ |
| **å…³ç³»**     | é…ç½®è€…ã€‚å®ƒå‘Šè¯‰ç½‘å…³è·¯ç”±è§„åˆ™ã€‚                        | æ‰§è¡Œè€…ã€‚å®ƒä½¿ç”¨æ³¨å†Œçš„è§„åˆ™æ¥åˆ†å‘æ¶ˆæ¯ã€‚                         |
| **å…³é”®æ•°æ®** | å°† `<MsgId, HandlerType>` å¯¹å†™å…¥ç½‘å…³çš„å­—å…¸ã€‚        | ä»å­—å…¸ä¸­è¯»å– `HandlerType`ï¼Œå¹¶åŠ¨æ€åˆ›å»ºå®ä¾‹ã€‚                 |

### ğŸ’ æ€»ç»“ï¼šä¸€ä¸ªå¥å£®çš„æ¶ˆæ¯å¤„ç†æ¶æ„
è¿™ä¸ª `MessageGateway` çš„å®ç°æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§çš„ä¼˜ç§€èŒƒä¾‹**ï¼Œå®ƒå±•ç¤ºäº†å¦‚ä½•ï¼š
1.  **æ­£ç¡®å¤„ç†ä¾èµ–æ³¨å…¥ç”Ÿå‘½å‘¨æœŸ**ï¼šé€šè¿‡â€œæ³¨å†Œç±»å‹ + ä½œç”¨åŸŸéš”ç¦»â€æ¨¡å¼ã€‚
2.  **å®ç°å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šç½‘å…³è´Ÿè´£é€šç”¨é€»è¾‘ï¼ˆè·¯ç”±ã€å®‰å…¨ã€ç›‘æ§ï¼‰ï¼Œå¤„ç†å™¨ä¸“æ³¨ä¸šåŠ¡ã€‚
3.  **ä¿éšœç³»ç»Ÿå®‰å…¨**ï¼šå†…ç½®åé‡æ”¾æ”»å‡»éªŒè¯ã€‚
4.  **æå‡å¯è§‚æµ‹æ€§**ï¼šé›†æˆäº†è¯¦ç»†çš„æ—¥å¿—å’ŒæŒ‡æ ‡ã€‚
5.  **ä¿æŒé«˜å¯æ‰©å±•æ€§**ï¼šæ·»åŠ æ–°æ¶ˆæ¯åªéœ€å®šä¹‰æ–°çš„å¤„ç†å™¨ç±»å¹¶æ³¨å†Œï¼Œæ— éœ€ä¿®æ”¹ç½‘å…³æ ¸å¿ƒè·¯ç”±é€»è¾‘ã€‚

è¿™ä¸ªè®¾è®¡ä½¿å¾—ä½ çš„æ¸¸æˆæœåŠ¡å™¨æ¶ˆæ¯å±‚å…·å¤‡äº†æé«˜çš„**å¥å£®æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ¸…æ™°åº¦**ã€‚æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥åŸºäºè¿™ä¸ªç¨³å›ºçš„æ¡†æ¶ï¼Œå®‰å¿ƒåœ°åœ¨å„ä¸ª `IMessageHandler` çš„å®ç°ä¸­ç¼–å†™å¤æ‚çš„æ¸¸æˆä¸šåŠ¡é€»è¾‘äº†ã€‚

# æ¶ˆæ¯å¤„ç†å™¨

```c#
using Google.Protobuf;
using SuperSocket.Server.Abstractions.Session;

namespace GameServer.Network;

/// <summary>
/// æ¶ˆæ¯å¤„ç†å™¨æ¥å£
/// </summary>
public interface IMessageHandler
{
    Task HandleAsync(IAppSession session, ReadOnlyMemory<byte> payload);
}

/// <summary>
/// æ¶ˆæ¯å¤„ç†å™¨åŸºç±»
/// è‡ªåŠ¨ååºåˆ—åŒ– Protobuf æ¶ˆæ¯
/// </summary>
public abstract class MessageHandler<TRequest> : IMessageHandler
    where TRequest : IMessage<TRequest>, new()
{
    private static readonly MessageParser<TRequest> Parser = new MessageParser<TRequest>(() => new TRequest());

    public async Task HandleAsync(IAppSession session, ReadOnlyMemory<byte> payload)
    {
        var request = Parser.ParseFrom(payload.Span);
        await HandleAsync(session, request);
    }

    /// <summary>
    /// å¤„ç†è§£æåçš„æ¶ˆæ¯
    /// </summary>
    protected abstract Task HandleAsync(IAppSession session, TRequest request);
}

/// <summary>
/// éœ€è¦è®¤è¯çš„æ¶ˆæ¯å¤„ç†å™¨åŸºç±»
/// </summary>
public abstract class AuthenticatedMessageHandler<TRequest> : MessageHandler<TRequest>
    where TRequest : IMessage<TRequest>, new()
{
    protected sealed override async Task HandleAsync(IAppSession session, TRequest request)
    {
        var gameData = session.GetGameData();
        
        if (!gameData.IsAuthenticated)
        {
            await session.SendErrorAsync((int)Protocol.ErrorCode.NotAuthenticated, "è¯·å…ˆç™»å½•");
            return;
        }

        await HandleAuthenticatedAsync(session, request);
    }

    /// <summary>
    /// å¤„ç†å·²è®¤è¯çš„æ¶ˆæ¯
    /// </summary>
    protected abstract Task HandleAuthenticatedAsync(IAppSession session, TRequest request);
}

```

è¿™æ®µä»£ç å±•ç¤ºäº†ä½ çš„æ¸¸æˆæœåŠ¡å™¨ä¸­**ä¸šåŠ¡é€»è¾‘å¤„ç†å±‚**çš„ä¸€ä¸ªéå¸¸ä¼˜é›…çš„è®¾è®¡ã€‚å®ƒé€šè¿‡æŠ½è±¡å’Œç»§æ‰¿ï¼Œæ„å»ºäº†ä¸€ä¸ªèŒè´£æ¸…æ™°ã€æ˜“äºæ‰©å±•ã€ä¸”å…·å¤‡è‡ªåŠ¨ååºåˆ—åŒ–ä¸ç»Ÿä¸€è®¤è¯èƒ½åŠ›çš„æ¶ˆæ¯å¤„ç†å™¨æ¡†æ¶ã€‚

### ğŸ—‚ï¸ æ ¸å¿ƒè®¾è®¡ï¼šä¸‰å±‚å¤„ç†æŠ½è±¡

æ•´ä¸ªè®¾è®¡åˆ†ä¸ºä¸‰ä¸ªå±‚æ¬¡ï¼Œä»é€šç”¨åˆ°å…·ä½“ï¼Œå±‚å±‚é€’è¿›ï¼š

<img src="png\deepseek_mermaid_20260208_d21e27.png" alt="deepseek_mermaid_20260208_d21e27" style="zoom: 25%;" />

```c#
graph TD
    A[â€œæœ€é€šç”¨: IMessageHandler æ¥å£â€] --> B[â€œåŸºç¡€èƒ½åŠ›: MessageHandler&lt;TRequest&gt; æŠ½è±¡ç±»â€]
    B --> C[â€œä¸šåŠ¡å¢å¼º: AuthenticatedMessageHandler&lt;TRequest&gt; æŠ½è±¡ç±»â€]
    C --> D[â€œæœ€ç»ˆå®ç°: å…·ä½“çš„ä¸šåŠ¡å¤„ç†å™¨â€]

    subgraph A[æ¥å£å±‚]
        A1[â€œHandleAsync(session, rawPayload)â€]
    end

    subgraph B[åŸºç±»å±‚ï¼š åè®®è§£ç ]
        B1[â€œæ³›å‹ TRequest çº¦æŸâ€]
        B2[â€œé™æ€ MessageParser ç¼“å­˜â€]
        B3[â€œè‡ªåŠ¨ Protobuf ååºåˆ—åŒ–â€]
    end

    subgraph C[å¢å¼ºå±‚ï¼š ä¸šåŠ¡è§„åˆ™]
        C1[â€œæ¨¡æ¿æ–¹æ³•æ¨¡å¼â€]
        C2[â€œç»Ÿä¸€çš„è®¤è¯æ£€æŸ¥â€]
    end

    subgraph D[å®ç°å±‚]
        D1[â€œLoginHandlerâ€]
        D2[â€œCreatePlayerHandlerâ€]
    end
```

ä¸Šå›¾æ¸…æ™°åœ°å±•ç¤ºäº†ä¸‰ä¸ªæŠ½è±¡å±‚æ¬¡å¦‚ä½•åä½œï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†è§£ææ¯ä¸€å±‚ã€‚

### ğŸ” é€å±‚è¯¦è§£

**ç¬¬ä¸€å±‚ï¼š`IMessageHandler` æ¥å£**
è¿™æ˜¯æ•´ä¸ªæ¶ˆæ¯å¤„ç†ç³»ç»Ÿçš„**å¥‘çº¦**ï¼Œå®šä¹‰äº†æ‰€æœ‰å¤„ç†å™¨å¿…é¡»éµå¾ªçš„ç»Ÿä¸€æ ‡å‡†ã€‚
```csharp
public interface IMessageHandler
{
    Task HandleAsync(IAppSession session, ReadOnlyMemory<byte> payload);
}
```
*   **ä½œç”¨**ï¼š`MessageGateway` åªä¾èµ–æ­¤æ¥å£ï¼Œå®ƒä¸éœ€è¦çŸ¥é“å…·ä½“æ˜¯å“ªä¸ªå¤„ç†å™¨ï¼Œåªè¦è°ƒç”¨ `HandleAsync` å³å¯ã€‚è¿™æ˜¯**ä¾èµ–å€’ç½®åŸåˆ™**çš„ä½“ç°ã€‚
*   **å‚æ•°**ï¼š
    *   `session`ï¼šå½“å‰å®¢æˆ·ç«¯è¿æ¥ä¼šè¯ã€‚
    *   `payload`ï¼š`ReadOnlyMemory<byte>` ç±»å‹çš„åŸå§‹æ¶ˆæ¯ä½“ã€‚è¿™æ˜¯é«˜æ€§èƒ½çš„åˆ‡ç‰‡ç±»å‹ï¼Œé¿å…äº†æ•°ç»„æ‹·è´ã€‚

**ç¬¬äºŒå±‚ï¼š`MessageHandler<TRequest>` æŠ½è±¡åŸºç±»**
è¿™æ˜¯ç³»ç»Ÿçš„**è‡ªåŠ¨åŒ–æ ¸å¿ƒ**ï¼Œå®ƒè§£å†³äº†æ¯ä¸ªå¤„ç†å™¨éƒ½éœ€è¦é‡å¤ç¼–å†™ Protobuf ååºåˆ—åŒ–ä»£ç çš„é—®é¢˜ã€‚
```csharp
public abstract class MessageHandler<TRequest> : IMessageHandler
    where TRequest : IMessage<TRequest>, new() // æ³›å‹çº¦æŸ
{
    // â­ å…³é”®ï¼šé™æ€è§£æå™¨ï¼Œé¿å…æ¯æ¬¡è§£æéƒ½åˆ›å»ºæ–°å¯¹è±¡ï¼Œæå‡æ€§èƒ½ã€‚
    private static readonly MessageParser<TRequest> Parser = new MessageParser<TRequest>(() => new TRequest());

    // æ˜¾å¼å®ç°æ¥å£æ–¹æ³•ï¼Œæ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä¸€éƒ¨åˆ†
    public async Task IMessageHandler.HandleAsync(IAppSession session, ReadOnlyMemory<byte> payload)
    {
        // 1. ç»Ÿä¸€ååºåˆ—åŒ–
        var request = Parser.ParseFrom(payload.Span);
        // 2. è°ƒç”¨æŠ½è±¡æ–¹æ³•ï¼Œå°†å…·ä½“ä¸šåŠ¡äº¤ç»™å­ç±»
        await HandleAsync(session, request);
    }

    // â­ æ ¸å¿ƒæŠ½è±¡æ–¹æ³•ï¼šå¤„ç†è§£æåçš„æ¶ˆæ¯ï¼Œå­ç±»åªéœ€å®ç°æ­¤æ–¹æ³•ï¼Œå‚æ•°å·²æ˜¯ååºåˆ—åŒ–å¥½çš„å¯¹è±¡ã€‚
    protected abstract Task HandleAsync(IAppSession session, TRequest request);
}
```
*   **æ³›å‹çº¦æŸ `where TRequest : IMessage<TRequest>, new()`**ï¼šè¿™æ˜¯å…³é”®ï¼Œå®ƒä¿è¯äº† `TRequest` å¿…é¡»æ˜¯ Google Protobuf ç”Ÿæˆçš„æ¶ˆæ¯ç±»ï¼Œå¹¶ä¸”æœ‰æ— å‚æ„é€ å‡½æ•°ã€‚è¿™ä¸ºå®‰å…¨è°ƒç”¨ `Parser.ParseFrom` æä¾›äº†ç¼–è¯‘æ—¶ä¿éšœã€‚
*   **æ˜¾å¼æ¥å£å®ç°**ï¼šå®ƒéšè—äº†åŸºç¡€çš„ `HandleAsync(IAppSession, ReadOnlyMemory<byte>)` æ–¹æ³•ï¼Œå¼ºåˆ¶å­ç±»å’Œå¤–éƒ¨è°ƒç”¨è€…ä½¿ç”¨å¤„ç†å¯¹è±¡çš„é‡è½½ç‰ˆæœ¬ã€‚
*   **æ€§èƒ½ä¼˜åŒ–**ï¼šé™æ€ `Parser` æ˜¯ç‚¹ç›ä¹‹ç¬”ï¼Œé¿å…äº†ä¸ºæ¯ä¸ªè¯·æ±‚å®ä¾‹åŒ–è§£æå™¨ï¼Œåœ¨é«˜å¹¶å‘ä¸‹èƒ½æ˜¾è‘—å‡å°‘GCå‹åŠ›ã€‚

**ç¬¬ä¸‰å±‚ï¼š`AuthenticatedMessageHandler<TRequest>` æŠ½è±¡åŸºç±»**
è¿™æ˜¯**ä¸šåŠ¡è§„åˆ™å¢å¼ºå±‚**ï¼Œä¸ºéœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„è¯·æ±‚ï¼ˆå¦‚åˆ›å»ºè§’è‰²ã€è·å–åˆ—è¡¨ï¼‰æ·»åŠ äº†ç»Ÿä¸€çš„è®¤è¯å±éšœã€‚
```csharp
public abstract class AuthenticatedMessageHandler<TRequest> : MessageHandler<TRequest>
    where TRequest : IMessage<TRequest>, new()
{
    // é‡å†™åŸºç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œæ·»åŠ è®¤è¯æ£€æŸ¥
    protected sealed override async Task HandleAsync(IAppSession session, TRequest request)
    {
        var gameData = session.GetGameData();
        
        // â­ ç»Ÿä¸€è®¤è¯æ£€æŸ¥
        if (!gameData.IsAuthenticated)
        {
            await session.SendErrorAsync(...);
            return;
        }
        // è®¤è¯é€šè¿‡ï¼Œè°ƒç”¨å­ç±»çš„ä¸šåŠ¡æ–¹æ³•
        await HandleAuthenticatedAsync(session, request);
    }

    // â­ æ–°çš„æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å®ç°å…·ä½“çš„å·²è®¤è¯ä¸šåŠ¡é€»è¾‘
    protected abstract Task HandleAuthenticatedAsync(IAppSession session, TRequest request);
}
```
*   **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**ï¼š`HandleAsync` æ–¹æ³•è¢« `sealed`ï¼ˆå¯†å°ï¼‰é‡å†™ï¼Œ`sealed`è¯‘ä¸ºå¯†å°çš„ã€‚æ•…åæ€ä¹‰ï¼Œå°±æ˜¯ç”±å®ƒä¿®é¥°çš„ç±»æˆ–æ–¹æ³•å°†ä¸èƒ½è¢«ç»§æ‰¿æˆ–é‡å†™ã€‚å›ºå®šäº†â€œ**æ£€æŸ¥è®¤è¯ â†’ æ‰§è¡Œä¸šåŠ¡**â€çš„ç®—æ³•éª¨æ¶ã€‚å­ç±»æ— æ³•æ”¹å˜è¿™ä¸ªæµç¨‹ï¼Œä¿è¯äº†è®¤è¯è§„åˆ™çš„å¼ºåˆ¶æ€§ã€‚
*   **å¼€é—­åŸåˆ™**ï¼šæ–°å¢ä¸€ç§éœ€è¦è®¤è¯çš„æ¶ˆæ¯ç±»å‹æ—¶ï¼Œåªéœ€ç»§æ‰¿æ­¤ç±»å¹¶å®ç° `HandleAuthenticatedAsync`ï¼Œæ— éœ€ç¼–å†™ä»»ä½•è®¤è¯ä»£ç ï¼Œç³»ç»Ÿå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ã€‚

### ğŸ§© åœ¨ä½ çš„é¡¹ç›®ä¸­å¦‚ä½•å·¥ä½œï¼šä»¥ç™»å½•å’Œåˆ›å»ºè§’è‰²ä¸ºä¾‹

```csharp
// ç™»å½•å¤„ç†å™¨ï¼ˆä¸éœ€è¦è®¤è¯ï¼Œç›´æ¥ç»§æ‰¿åŸºç¡€å±‚ï¼‰
public class LoginHandler : MessageHandler<Protocol.C2S_Login> // æŒ‡å®šå…·ä½“çš„è¯·æ±‚æ¶ˆæ¯ç±»å‹
{
    private readonly AuthService _authService;
    // ä¾èµ–æ³¨å…¥ä¾ç„¶æœ‰æ•ˆ
    public LoginHandler(AuthService authService) { _authService = authService; }

    protected override async Task HandleAsync(IAppSession session, Protocol.C2S_Login request)
    {
        // ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¥½çš„ request.Username, request.Password
        var result = await _authService.LoginAsync(request.Username, request.Password);
        // ... å‘é€å“åº”
    }
}

// åˆ›å»ºè§’è‰²å¤„ç†å™¨ï¼ˆéœ€è¦è®¤è¯ï¼Œç»§æ‰¿å¢å¼ºå±‚ï¼‰
public class CreatePlayerHandler : AuthenticatedMessageHandler<Protocol.C2S_CreatePlayer>
{
    protected override async Task HandleAuthenticatedAsync(IAppSession session, Protocol.C2S_CreatePlayer request)
    {
        // èƒ½æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜sessionå·²ç»é€šè¿‡è®¤è¯ï¼ŒgameData.PlayerIdæ˜¯æœ‰æ•ˆçš„
        var player = await CreatePlayerAsync(session.GetGameData().PlayerId, request.Name);
        // ... å‘é€å“åº”
    }
}
```

### ğŸ’ æ€»ç»“ä¸è¯„ä»·

è¿™æ˜¯ä¸€ä¸ª**æ•™ç§‘ä¹¦çº§åˆ«çš„é¢å‘å¯¹è±¡è®¾è®¡**ï¼Œå®ƒå®Œç¾å±•ç¤ºäº†å¦‚ä½•é€šè¿‡æŠ½è±¡æ¥ç®¡ç†å¤æ‚æ€§ï¼š

1.  **èŒè´£æ¸…æ™°**ï¼šæ¥å£å®šä¹‰å¥‘çº¦ï¼ŒåŸºç±»å¤„ç†æŠ€æœ¯ç»†èŠ‚ï¼ˆååºåˆ—åŒ–ï¼‰ï¼Œå¢å¼ºç±»å¤„ç†ä¸šåŠ¡è§„åˆ™ï¼ˆè®¤è¯ï¼‰ï¼Œå­ç±»ä¸“æ³¨çº¯ç²¹ä¸šåŠ¡ã€‚
2.  **æ¶ˆé™¤é‡å¤**ï¼šæ‰€æœ‰ Protobuf è§£æå’Œè®¤è¯æ£€æŸ¥çš„ä»£ç åœ¨ç³»ç»Ÿä¸­åªå‡ºç°ä¸€æ¬¡ã€‚
3.  **ç±»å‹å®‰å…¨**ï¼šé€šè¿‡æ³›å‹çº¦æŸï¼Œåœ¨ç¼–è¯‘æœŸå°±ç¡®ä¿æ¶ˆæ¯ç±»å‹çš„æ­£ç¡®æ€§ã€‚
4.  **é«˜æ€§èƒ½**ï¼šé™æ€è§£æå™¨ã€ä½¿ç”¨ `Span` ç­‰ç»†èŠ‚ä½“ç°äº†å¯¹æ€§èƒ½çš„è€ƒé‡ã€‚
5.  **ææ˜“æ‰©å±•**ï¼šæ·»åŠ æ–°æ¶ˆæ¯ç±»å‹å°±åƒå¡«ç©ºä¸€æ ·ç®€å•ï¼Œä¸”ä¸å®¹æ˜“å‡ºé”™ã€‚

è¿™ä¸ªè®¾è®¡è®©ä½ å¯ä»¥å®Œå…¨ä¸“æ³¨äºæ¯ä¸ªæ¶ˆæ¯ç‹¬ç‰¹çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œå°†ç½‘ç»œåè®®ã€åºåˆ—åŒ–ã€è®¤è¯ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹äº¤ç»™æ¡†æ¶ã€‚è¿™æ­£æ˜¯æ„å»ºä¸€ä¸ªå¯ç»´æŠ¤çš„å¤§å‹æ¸¸æˆæœåŠ¡å™¨åç«¯æ‰€éœ€è¦çš„æ ¸å¿ƒæ¶æ„èƒ½åŠ›ã€‚

# ä¼šè¯

è¿™æ®µä»£ç æ˜¯æ‚¨æ¸¸æˆæœåŠ¡å™¨ä¸­**ä¼šè¯çŠ¶æ€ç®¡ç†**å’Œ**ç½‘ç»œé€šä¿¡**çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ã€‚å®ƒé€šè¿‡æ‰©å±•æ–¹æ³•å·§å¦™åœ°å°†ä¸šåŠ¡æ•°æ®ç»‘å®šåˆ°ç½‘ç»œè¿æ¥ä¸Šï¼Œå¹¶ç»Ÿä¸€äº†æœåŠ¡å™¨çš„å“åº”æ ¼å¼ã€‚ä¸‹é¢æˆ‘å°†è¯¦ç»†è§£æå…¶è®¾è®¡ï¼Œå¹¶é‡ç‚¹è§£ç­”æ‚¨å…³äºæ‰©å±•æ–¹æ³•å¦‚ä½•å…³è”åˆ°åŸç±»çš„ç–‘é—®ã€‚

### ğŸ§  æ ¸å¿ƒç»„ä»¶è§£æ

#### **1. GameSessionDataï¼šè¿æ¥çš„ä¸šåŠ¡çŠ¶æ€å®¹å™¨**
è¿™ä¸ªç±»å­˜å‚¨äº†**ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥åœ¨æ•´ä¸ªä¼šè¯æœŸé—´**çš„ä¸šåŠ¡çŠ¶æ€ã€‚å®ƒè¢«â€œæŒ‚è½½â€åœ¨`IAppSession`å¯¹è±¡ä¸Šï¼Œæ˜¯è¿æ¥ç‰©ç†å±‚å’Œä¸šåŠ¡é€»è¾‘å±‚çš„æ¡¥æ¢ã€‚

```csharp
public class GameSessionData
{
    // æ ¸å¿ƒä¸šåŠ¡çŠ¶æ€
    public long PlayerId { get; set; } // æœ€é‡è¦çš„å­—æ®µï¼Œæ ‡è¯†å½“å‰è¿æ¥å¯¹åº”çš„æ¸¸æˆè§’è‰²
    public bool IsAuthenticated { get; set; } // ç”¨äº AuthenticatedMessageHandler è®¤è¯æ£€æŸ¥
    
    // çŠ¶æ€ä¸é˜²é‡æ”¾
    public uint LastSequence { get; set; }
    public bool ValidateSequence(uint sequence) { ... } // å…³é”®å®‰å…¨æ–¹æ³•ï¼Œé˜²æ­¢æ¶ˆæ¯é‡æ”¾æ”»å‡»
}
```
**è®¾è®¡æ„å›¾**ï¼šå°†æ¸¸æˆç›¸å…³çš„ã€æ˜“å˜çš„çŠ¶æ€ï¼ˆå¦‚ç©å®¶IDã€æ‰€åœ¨åœºæ™¯ï¼‰ä»ç½‘ç»œå±‚å¯¹è±¡`IAppSession`ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä¿æŒ`IAppSession`åªå…³æ³¨è¿æ¥æœ¬èº«ï¼ˆIPã€ç«¯å£ã€å‘é€æ•°æ®ï¼‰ï¼Œç¬¦åˆ**å•ä¸€èŒè´£åŸåˆ™**ã€‚

#### **2. æ‰©å±•æ–¹æ³•çš„é­”æ³•ï¼šè¯­æ³•ç³–ä¸ç¼–è¯‘æ—¶è½¬æ¢**
æ‚¨é—®åˆ°æ‰©å±•æ–¹æ³•å¦‚ä½•å…³è”åˆ°åŸæ¥çš„ç±»ï¼Œè¿™æ­£æ˜¯C#è¯­è¨€çš„ä¸€å¤§ç‰¹è‰²ã€‚å®ƒé€šè¿‡ä¸¤ä¸ªå…³é”®è¯­æ³•å®ç°ï¼š

```csharp
public static class GameSessionExtensions // 1. å¿…é¡»æ˜¯é™æ€ç±»
{
    // 2. ç¬¬ä¸€ä¸ªå‚æ•°ç”¨ `this` ä¿®é¥°ï¼ŒæŒ‡å®šè¦æ‰©å±•çš„ç±»å‹
    public static GameSessionData GetGameData(this IAppSession session)
    {
        // å®ç°...
    }
}
```

**å…³è”åŸç†ï¼ˆè¿™æ˜¯æ‚¨è¦çš„æ ¸å¿ƒç­”æ¡ˆï¼‰**ï¼š
å½“æ‚¨å†™ä¸‹ `session.GetGameData()` æ—¶ï¼ŒC#ç¼–è¯‘å™¨ä¼š**é™é»˜åœ°é‡å†™**æ‚¨çš„ä»£ç ã€‚å®ƒå¹¶éåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ä¸º`IAppSession`æ·»åŠ æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘æ—¶å°±å®Œæˆäº†è½¬æ¢ï¼š
```csharp
// æ‚¨å†™çš„ä»£ç ï¼ˆä¼˜é›…çš„é¢å‘å¯¹è±¡é£æ ¼ï¼‰ï¼š
var data = session.GetGameData();

// ç¼–è¯‘å™¨å®é™…ç”Ÿæˆçš„ä»£ç ï¼ˆæœ´ç´ çš„é™æ€æ–¹æ³•è°ƒç”¨ï¼‰ï¼š
var data = GameSessionExtensions.GetGameData(session);
```
**å…³é”®ç‚¹**ï¼š
- **`this IAppSession session`**ï¼šè¿™ä¸ªå‚æ•°ä¿®é¥°ç¬¦æ˜¯**å”¯ä¸€çš„â€œå…³è”â€è¯­æ³•**ã€‚å®ƒå‘ç¼–è¯‘å™¨å£°æ˜ï¼šâ€œè¿™ä¸ªé™æ€æ–¹æ³•å¯ä»¥åƒ`IAppSession`çš„å®ä¾‹æ–¹æ³•ä¸€æ ·è¢«è°ƒç”¨â€ã€‚
- **å‘½åç©ºé—´**ï¼šè¦ä½¿ç”¨æ‰©å±•æ–¹æ³•ï¼Œå¿…é¡»åœ¨æ–‡ä»¶é¡¶éƒ¨`using`å…¶æ‰€åœ¨çš„å‘½åç©ºé—´ï¼ˆä¾‹å¦‚`using GameServer.Network;`ï¼‰ã€‚ç¼–è¯‘å™¨åªåœ¨å·²å¼•ç”¨çš„å‘½åç©ºé—´ä¸­æœç´¢æ‰©å±•æ–¹æ³•ã€‚
- **è¿™æ˜¯ä¸€ç§ç¼–è¯‘æ—¶çš„â€œè¯­æ³•ç³–â€**ï¼Œæ²¡æœ‰æ”¹å˜åŸæœ‰ç±»`IAppSession`çš„äºŒè¿›åˆ¶ç»“æ„ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨ç»§æ‰¿æˆ–è£…é¥°å™¨æ¨¡å¼ï¼Œå› æ­¤éå¸¸è½»é‡ä¸”æ— ä¾µå…¥æ€§ã€‚

### ğŸ”„ åœ¨æ¶ˆæ¯å¤„ç†æµç¨‹ä¸­çš„å·¥ä½œæµ

ä¸‹å›¾æ¸…æ™°åœ°å±•ç¤ºäº† `GameSessionData` ä¸æ‰©å±•æ–¹æ³•åœ¨æ•´ä¸ªæ¶ˆæ¯å¤„ç†ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¦‚ä½•ä¸å„ä¸ªç»„ä»¶ååŒå·¥ä½œï¼Œä»è¿æ¥å»ºç«‹åˆ°ä¸šåŠ¡å¤„ç†ï¼Œå†åˆ°çŠ¶æ€æ›´æ–°ï¼š
```mermaid
sequenceDiagram
    participant C as Client
    participant S as SuperSocket Session
    participant ED as æ‰©å±•æ–¹æ³•/GameData
    participant GH as æ¶ˆæ¯ç½‘å…³(Gateway)
    participant MH as æ¶ˆæ¯å¤„ç†å™¨(Handler)
    participant SM as PlayerManager

    Note over C, SM: é˜¶æ®µ1ï¼šè¿æ¥å»ºç«‹
    C->>S: å»ºç«‹è¿æ¥
    S->>ED: session.GetGameData() (é¦–æ¬¡è°ƒç”¨)
    ED->>ED: åˆ›å»ºæ–°çš„GameSessionDataå¯¹è±¡
    ED->>S: å­˜å‚¨åœ¨session.DataContext
    Note over ED: åˆå§‹çŠ¶æ€ï¼š<br>PlayerId=0, IsAuthenticated=false

    Note over C, SM: é˜¶æ®µ2ï¼šç™»å½•æ¶ˆæ¯å¤„ç†
    C->>S: å‘é€Loginæ¶ˆæ¯
    S->>GH: RouteMessageAsync(session, package)
    GH->>MH: åˆ›å»ºLoginHandlerå®ä¾‹å¹¶è°ƒç”¨
    MH->>ED: session.GetGameData()
    ED->>MH: è¿”å›ç©ºçš„GameDataå¯¹è±¡
    MH->>SM: éªŒè¯è´¦å·ï¼Œè·å–PlayerId
    MH->>ED: æ›´æ–°GameData: <br>PlayerId=1001, IsAuthenticated=true
    MH->>S: å‘é€ç™»å½•æˆåŠŸå“åº”

    Note over C, SM: é˜¶æ®µ3ï¼šéœ€è¦è®¤è¯çš„ä¸šåŠ¡å¤„ç†
    C->>S: å‘é€CreatePlayeræ¶ˆæ¯
    S->>GH: RouteMessageAsync(session, package)
    GH->>MH: åˆ›å»ºCreatePlayerHandlerå®ä¾‹
    MH->>ED: session.GetGameData()
    ED->>MH: è¿”å›å·²è®¤è¯çš„GameData (PlayerId=1001)
    MH->>MH: æ£€æŸ¥IsAuthenticatedï¼Œé€šè¿‡
    MH->>SM: æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    MH->>S: å‘é€ä¸šåŠ¡å“åº”

    Note over C, SM: é˜¶æ®µ4ï¼šè¿æ¥æ–­å¼€æ¸…ç†
    S->>S: è¿æ¥æ–­å¼€ï¼Œè§¦å‘onClosed
    S->>GH: è°ƒç”¨onClosedäº‹ä»¶å¤„ç†
    GH->>ED: session.GetGameData()
    ED->>GH: è¿”å›GameData (PlayerId=1001)
    GH->>SM: PlayerManager.RemovePlayer(1001)
    SM->>SM: ä»åœ¨çº¿åˆ—è¡¨ç§»é™¤ç©å®¶
```

### ğŸ›¡ï¸ å®‰å…¨ä¸åè®®è®¾è®¡äº®ç‚¹

1.  **é˜²é‡æ”¾æ”»å‡»**ï¼š`ValidateSequence` æ–¹æ³•æ˜¯é‡è¦çš„å®‰å…¨æªæ–½ã€‚å®ƒç¡®ä¿å®¢æˆ·ç«¯å‘é€çš„æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªé€’å¢çš„åºåˆ—å·ï¼ŒæœåŠ¡å™¨ä¼šæ‹’ç»åºåˆ—å·å°äºæˆ–ç­‰äºä¸Šæ¬¡è®°å½•çš„è¯·æ±‚ï¼Œæœ‰æ•ˆé˜²æ­¢ç½‘ç»œåŒ…è¢«æˆªè·åé‡å¤å‘é€ã€‚
2.  **ç»Ÿä¸€çš„å“åº”åè®®**ï¼š
    - `SendMessageAsync`ï¼šå°è£…äº†Protobufåºåˆ—åŒ–å’Œç½‘ç»œåŒ…å¤´çš„ç»„è£…ï¼Œè®©ä¸šåŠ¡ä»£ç åªéœ€å…³å¿ƒä¸šåŠ¡å¯¹è±¡ã€‚
    - `SendErrorAsync`ï¼šæä¾›äº†ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ï¼Œç¡®ä¿å®¢æˆ·ç«¯èƒ½è§£ææ‰€æœ‰é”™è¯¯ã€‚

### ğŸ’ æ€»ç»“ä¸è¯„ä»·

è¿™å¥—è®¾è®¡æ˜¯è¿æ¥ç‰©ç†ç½‘ç»œå±‚ä¸å¤æ‚ä¸šåŠ¡é€»è¾‘çš„**ä¼˜é›…ç²˜åˆå‰‚**ï¼š

- **æ‰©å±•æ–¹æ³•** åœ¨ä¸ä¿®æ”¹ç¬¬ä¸‰æ–¹åº“(`SuperSocket`)ä»£ç çš„å‰æä¸‹ï¼Œä¸ºå…¶æ ¸å¿ƒæ¥å£ `IAppSession` èµ‹äºˆäº†ä¸šåŠ¡è¯­ä¹‰ï¼Œæ˜¯ **â€œå¼€é—­åŸåˆ™â€** çš„å®Œç¾å®è·µã€‚
- **GameSessionData** ä½œä¸ºçŠ¶æ€å®¹å™¨ï¼Œç”Ÿå‘½å‘¨æœŸä¸TCPè¿æ¥å®Œå…¨ä¸€è‡´ï¼Œæ˜¯ç®¡ç†ç”¨æˆ·ä¼šè¯çŠ¶æ€çš„ç†æƒ³ä½ç½®ã€‚
- **åè®®å°è£…** å°†å¤æ‚çš„å­—èŠ‚æ“ä½œï¼ˆå¦‚å°ç«¯åºå†™å…¥ï¼‰éšè—åœ¨æ‰©å±•æ–¹æ³•å†…ï¼Œå¤§å¤§é™ä½äº†ä¸šåŠ¡ä»£ç çš„å¤æ‚åº¦å’Œå‡ºé”™æ¦‚ç‡ã€‚

**ä¸€å¥è¯å›ç­”æ‚¨çš„æ ¸å¿ƒç–‘é—®**ï¼šæ‰©å±•æ–¹æ³•é€šè¿‡ `this` å…³é”®å­—åœ¨**ç¼–è¯‘æ—¶**ä¸åŸå§‹ç±»å…³è”ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°† `obj.ExtensionMethod()` è½¬æ¢æˆ `StaticClass.ExtensionMethod(obj)`ã€‚è¿™æ˜¯ä¸€ç§éä¾µå…¥å¼çš„ã€ä¸ºç°æœ‰ç±»å‹â€œæ·»åŠ â€åŠŸèƒ½çš„å¼ºå¤§è¯­æ³•ç³–ã€‚

è¿™ç§æ¨¡å¼åœ¨.NETç”Ÿæ€ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼ˆå¦‚LINQå°±æ˜¯ä¸€ç³»åˆ—æ‰©å±•æ–¹æ³•ï¼‰ï¼Œæ‚¨å·²ç»æŒæ¡äº†è¿™ä¸€é«˜çº§ç‰¹æ€§çš„æ ¸å¿ƒç”¨æ³•ã€‚