# MServer éƒ¨ç½²æŒ‡å—ï¼ˆè‡ªåŒ…å«å‘å¸ƒ + å¤šç¯å¢ƒé…ç½®ï¼‰

## ğŸ“¦ å‘å¸ƒè¯´æ˜

**å‘å¸ƒç±»å‹**ï¼šè‡ªåŒ…å« + å•æ–‡ä»¶ 

```c#
dotnet publish MServer.csproj -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o ./publish/linux
```

**å‘å¸ƒç±»å‹**ï¼šè‡ªåŒ…å« + å•æ–‡ä»¶ + è£å‰ª

```c#
dotnet publish MServer.csproj -c Release -r linux-x64 --self-contained true -p:PublishTrimmed=true -p:PublishSingleFile=true -o ./publish/linux
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä¸éœ€è¦æœåŠ¡å™¨å®‰è£… .NET è¿è¡Œæ—¶
- âœ… å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆçº¦ 30-50MBï¼‰
- âœ… æ”¯æŒå¤šç¯å¢ƒé…ç½®ï¼ˆDevelopment/Productionï¼‰
- âœ… æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤ï¼ˆå®å¡”é¢æ¿ï¼‰

### 1. ä¸Šä¼ æ–‡ä»¶

å°† `publish/linux-selfcontained` ç›®å½•ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼š

```bash
# ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼‰
/www/wwwroot/mserver/
```

**éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶**ï¼š
- âœ… `GameServer`ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
- âœ… `appsettings.json`ï¼ˆé»˜è®¤é…ç½®ï¼‰
- âœ… `appsettings.Production.json`ï¼ˆç”Ÿäº§ç¯å¢ƒé…ç½®ï¼‰
- âœ… å…¶ä»– `.dll` æ–‡ä»¶

### 2. èµ‹äºˆæ‰§è¡Œæƒé™

SSH ç™»å½•æœåŠ¡å™¨æˆ–ä½¿ç”¨å®å¡”ç»ˆç«¯ï¼š

```bash
cd /www/wwwroot/mserver
chmod +x GameServer
```

### 3. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**æ–¹å¼ Aï¼šä½¿ç”¨å®å¡”è¿›ç¨‹å®ˆæŠ¤**

åœ¨å®å¡”é¢æ¿ â†’ è½¯ä»¶å•†åº— â†’ è¿›ç¨‹å®ˆæŠ¤ç®¡ç†å™¨ï¼š

```bash
# å¯åŠ¨å‘½ä»¤
cd /www/wwwroot/mserver && ASPNETCORE_ENVIRONMENT=Production ./GameServer

# æˆ–è€…åˆ†å¼€è®¾ç½®
å·¥ä½œç›®å½•ï¼š/www/wwwroot/mserver
å¯åŠ¨å‘½ä»¤ï¼š./GameServer
ç¯å¢ƒå˜é‡ï¼šASPNETCORE_ENVIRONMENT=Production
```

**æ–¹å¼ Bï¼šä½¿ç”¨ systemd æœåŠ¡**

åˆ›å»º `/etc/systemd/system/mserver.service`ï¼š

```ini
[Unit]
Description=MServer Game Server
After=network.target

[Service]
Type=simple
User=www
WorkingDirectory=/www/wwwroot/mserver
ExecStart=/www/wwwroot/mserver/GameServer
Restart=on-failure
RestartSec=10

# ç¯å¢ƒå˜é‡
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
systemctl daemon-reload
systemctl enable mserver
systemctl start mserver
systemctl status mserver
```

---

## ğŸŒ ç¯å¢ƒé…ç½®è¯´æ˜

### é…ç½®ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰

1. **ç¯å¢ƒå˜é‡**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **ç¯å¢ƒç‰¹å®šé…ç½®**ï¼ˆå¦‚ `appsettings.Production.json`ï¼‰
3. **é»˜è®¤é…ç½®**ï¼ˆ`appsettings.json`ï¼‰

### ç¯å¢ƒå˜é‡ç¤ºä¾‹

```bash
# è®¾ç½®ç¯å¢ƒä¸ºç”Ÿäº§
export ASPNETCORE_ENVIRONMENT=Production

# è¦†ç›–ç«¯å£ï¼ˆä½¿ç”¨åŒä¸‹åˆ’çº¿æ›¿ä»£å†’å·ï¼‰
export Server__Port=8888

# è¦†ç›–æ•°æ®åº“è¿æ¥
export Database__ConnectionString="Server=new-db;Port=3306;..."

# å¯åŠ¨æœåŠ¡å™¨
./GameServer
```

---

## ğŸ“ é…ç½®æ–‡ä»¶è¯´æ˜

### appsettings.jsonï¼ˆé»˜è®¤/å¼€å‘ï¼‰

```json
{
  "Server": { "Port": 33333 },
  "Database": { "ConnectionString": "Server=127.0.0.1;..." },
  "Logging": { "MinimumLevel": "Information" }
}
```

### appsettings.Production.jsonï¼ˆç”Ÿäº§ï¼‰

```json
{
  "Server": { "Port": 33333 },
  "Database": { "ConnectionString": "Server=8.134.90.3;..." },
  "Logging": { "MinimumLevel": "Warning" }  // ç”Ÿäº§ç¯å¢ƒå‡å°‘æ—¥å¿—
}
```

**å·®å¼‚**ï¼š
- æ•°æ®åº“åœ°å€ä¸åŒï¼ˆæœ¬åœ°å¼€å‘ vs ç”Ÿäº§æœåŠ¡å™¨ï¼‰
- æ—¥å¿—çº§åˆ«ä¸åŒï¼ˆå¼€å‘è¯¦ç»† vs ç”Ÿäº§ç²¾ç®€ï¼‰

---

## ğŸ”§ å¸¸è§åœºæ™¯

### åœºæ™¯ 1ï¼šä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œ

```bash
./GameServer
# ä½¿ç”¨ appsettings.json
```

### åœºæ™¯ 2ï¼šä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
ASPNETCORE_ENVIRONMENT=Production ./GameServer
# åŠ è½½ appsettings.json + appsettings.Production.jsonï¼ˆåè€…è¦†ç›–å‰è€…ï¼‰
```

### åœºæ™¯ 3ï¼šä¸´æ—¶ä¿®æ”¹ç«¯å£ï¼ˆä¸æ”¹é…ç½®æ–‡ä»¶ï¼‰

```bash
Server__Port=9999 ./GameServer
# ç«¯å£ä¸´æ—¶æ”¹ä¸º 9999
```

### åœºæ™¯ 4ï¼šç»„åˆä½¿ç”¨

```bash
ASPNETCORE_ENVIRONMENT=Production Server__Port=8888 ./GameServer
# ä½¿ç”¨ç”Ÿäº§é…ç½® + ç«¯å£æ”¹ä¸º 8888
```

---

## ğŸ› ï¸ å®å¡”é¢æ¿é…ç½®

### æ–¹æ³• 1ï¼šä½¿ç”¨è¿›ç¨‹å®ˆæŠ¤ç®¡ç†å™¨ï¼ˆæ¨èï¼‰

1. å®‰è£…ã€Œè¿›ç¨‹å®ˆæŠ¤ç®¡ç†å™¨ã€æ’ä»¶
2. æ·»åŠ å®ˆæŠ¤è¿›ç¨‹ï¼š
   - **åç§°**ï¼šMServer
   - **å¯åŠ¨ç›®å½•**ï¼š`/www/wwwroot/mserver`
   - **å¯åŠ¨å‘½ä»¤**ï¼š`./GameServer`
   - **ç¯å¢ƒå˜é‡**ï¼š`ASPNETCORE_ENVIRONMENT=Production`
   - **å¯åŠ¨ç”¨æˆ·**ï¼š`www`

### æ–¹æ³• 2ï¼šä½¿ç”¨ Supervisor

åœ¨å®å¡”é¢æ¿ â†’ Supervisorï¼š

```ini
[program:mserver]
directory=/www/wwwroot/mserver
command=/www/wwwroot/mserver/GameServer
environment=ASPNETCORE_ENVIRONMENT="Production"
autostart=true
autorestart=true
user=www
stdout_logfile=/www/wwwroot/mserver/logs/stdout.log
stderr_logfile=/www/wwwroot/mserver/logs/stderr.log
```

---

## ğŸ” éªŒè¯éƒ¨ç½²

### æ£€æŸ¥è¿›ç¨‹

```bash
ps aux | grep GameServer
```

### æ£€æŸ¥ç«¯å£

```bash
netstat -tlnp | grep 33333
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# åº”ç”¨æ—¥å¿—
tail -f /www/wwwroot/mserver/logs/server-*.log

# Systemd æ—¥å¿—
journalctl -u mserver -f
```

### æµ‹è¯•è¿æ¥

```bash
# æœ¬åœ°æµ‹è¯•
telnet localhost 33333

# è¿œç¨‹æµ‹è¯•ï¼ˆéœ€å¼€æ”¾é˜²ç«å¢™ï¼‰
telnet ä½ çš„æœåŠ¡å™¨IP 33333
```

---

## ğŸ”’ å®‰å…¨é…ç½®

### 1. ä¿®æ”¹ç”Ÿäº§ç¯å¢ƒå¯†é’¥

ç¼–è¾‘ `appsettings.Production.json`ï¼š

```json
{
  "Jwt": {
    "SecretKey": "è¯·ä¿®æ”¹ä¸ºè‡³å°‘32ä½çš„éšæœºå­—ç¬¦ä¸²"
  }
}
```

### 2. å®å¡”é˜²ç«å¢™

æ”¾è¡Œç«¯å£ï¼š
- TCP 33333ï¼ˆæ¸¸æˆæœåŠ¡å™¨ï¼‰
- TCP 9090ï¼ˆPrometheus ç›‘æ§ï¼Œå¯é€‰ï¼‰

### 3. æ–‡ä»¶æƒé™

```bash
chown -R www:www /www/wwwroot/mserver
chmod 755 /www/wwwroot/mserver
chmod +x /www/wwwroot/mserver/GameServer
```

---

## ğŸ“Š ç›‘æ§

### Prometheus æŒ‡æ ‡

è®¿é—®ï¼š`http://ä½ çš„æœåŠ¡å™¨IP:9090/metrics`

### æŸ¥çœ‹åœ¨çº¿ç©å®¶

```bash
curl http://localhost:9090/metrics | grep game_players_online
```

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥æ‰§è¡Œæƒé™
ls -l GameServer

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
./GameServer
```

### é—®é¢˜ 2ï¼šé…ç½®æ–‡ä»¶æœªç”Ÿæ•ˆ

```bash
# æ£€æŸ¥å½“å‰ç¯å¢ƒ
echo $ASPNETCORE_ENVIRONMENT

# éªŒè¯é…ç½®æ–‡ä»¶å­˜åœ¨
ls -l appsettings*.json
```

### é—®é¢˜ 3ï¼šç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep 33333

# ä¿®æ”¹ç«¯å£
export Server__Port=å¦ä¸€ä¸ªç«¯å£
./GameServer
```

---

## ğŸ“± å¿«æ·å‘½ä»¤

```bash
# å¯åŠ¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
ASPNETCORE_ENVIRONMENT=Production ./GameServer

# åœæ­¢
pkill -f GameServer

# é‡å¯ï¼ˆSystemdï¼‰
systemctl restart mserver

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/server-$(date +%Y%m%d).log
```

---

## âœ… æ€»ç»“

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| è¿è¡Œæ—¶ä¾èµ– | **æ— **ï¼ˆè‡ªåŒ…å«å‘å¸ƒï¼‰ |
| ç¯å¢ƒå˜é‡ | **å®Œå…¨æ”¯æŒ** |
| é…ç½®æ–‡ä»¶ | æ”¯æŒå¤šç¯å¢ƒï¼ˆDevelopment/Productionï¼‰ |
| éƒ¨ç½²æ–¹å¼ | ç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ |
| å»ºè®®å®ˆæŠ¤ | Systemd æˆ–å®å¡”è¿›ç¨‹å®ˆæŠ¤ |
