# æ¸¸æˆæœåŠ¡å™¨æ¡†æ¶ - æ¶æ„è®¾è®¡æ–‡æ¡£

> [!IMPORTANT]
> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜æ¸¸æˆæœåŠ¡å™¨çš„ç³»ç»Ÿæ¶æ„ã€æ¨¡å—è®¾è®¡ã€æ•°æ®åº“è®¾è®¡å’Œéƒ¨ç½²æ–¹æ¡ˆã€‚

---

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **é¡¹ç›®åç§°** | SuperSocket MMO æ¸¸æˆæœåŠ¡å™¨æ¡†æ¶ |
| **æ–‡æ¡£ç±»å‹** | æ¶æ„è®¾è®¡æ–‡æ¡£ |
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.0 |
| **åˆ›å»ºæ—¶é—´** | 2026-02-06 |

---

## ğŸ›ï¸ ç³»ç»Ÿæ€»ä½“æ¶æ„

### äº”å±‚æ¶æ„å›¾

```mermaid
graph TB
    subgraph å®¢æˆ·ç«¯å±‚
        Unity[Unity å®¢æˆ·ç«¯<br/>åç»­å¼€å‘]
    end
    
    subgraph æ¥å…¥å±‚
        TCP[TCP Server<br/>Port: 33333]
        UDP[UDP Server<br/>Port: 33334]
        KCP[KCP Server<br/>Port: 33335<br/>å¯é€‰]
    end
    
    subgraph ç½‘å…³å±‚
        Gateway[Gateway Layer<br/>åè®®è·¯ç”± | è®¤è¯ | åŠ å¯†]
    end
    
    subgraph ä¸šåŠ¡å±‚
        PlayerMgr[PlayerManager<br/>ç©å®¶ç®¡ç†]
        WorldMgr[WorldManager<br/>å¤§ä¸–ç•Œç³»ç»Ÿ]
        RoomMgr[RoomManager<br/>æˆ¿é—´ç³»ç»Ÿ]
        SocialMgr[SocialManager<br/>ç¤¾äº¤ç³»ç»Ÿ]
        DataMgr[DataManager<br/>æ•°æ®ç³»ç»Ÿ]
    end
    
    subgraph æ•°æ®å±‚
        MySQL[(MySQL 5.7<br/>æŒä¹…åŒ–æ•°æ®)]
        Redis[(Redis 7.x<br/>ç¼“å­˜/ä¼šè¯)]
    end
    
    subgraph åŸºç¡€è®¾æ–½å±‚
        Log[Serilog<br/>æ—¥å¿—]
        Monitor[Prometheus<br/>ç›‘æ§]
        GM[GM Tool<br/>ç®¡ç†åå°]
    end
    
    Unity -->|TCP/UDP/KCP| TCP
    Unity -->|TCP/UDP/KCP| UDP
    Unity -->|TCP/UDP/KCP| KCP
    
    TCP --> Gateway
    UDP --> Gateway
    KCP --> Gateway
    
    Gateway --> PlayerMgr
    Gateway --> WorldMgr
    Gateway --> RoomMgr
    Gateway --> SocialMgr
    Gateway --> DataMgr
    
    PlayerMgr --> MySQL
    WorldMgr --> MySQL
    RoomMgr --> MySQL
    SocialMgr --> MySQL
    DataMgr --> MySQL
    
    PlayerMgr --> Redis
    WorldMgr --> Redis
    RoomMgr --> Redis
    SocialMgr --> Redis
    
    PlayerMgr -.-> Log
    WorldMgr -.-> Log
    RoomMgr -.-> Log
    
    Monitor -.ç›‘æ§.-> PlayerMgr
    Monitor -.ç›‘æ§.-> WorldMgr
    
    GM -.ç®¡ç†.-> PlayerMgr
```

---

## ğŸŒ ç½‘ç»œå±‚æ¶æ„è®¾è®¡

### 1. æ¥å…¥å±‚è®¾è®¡

#### TCP Server

**èŒè´£**: å¯é é€šä¿¡ï¼ˆç™»å½•ã€èŠå¤©ã€äº¤æ˜“ç­‰ï¼‰

**å®ç°**:
```csharp
public class TcpGameServer : SuperSocketServer<TcpSession, GamePackage>
{
    protected override void ConfigureServer(ServerOptions options)
    {
        options.Listeners = new[]
        {
            new ListenOptions
            {
                Ip = "0.0.0.0",
                Port = 33333,
                NoDelay = true,      // ç¦ç”¨ Nagle
                BackLog = 100,
                KeepAlive = true
            }
        };
        
        options.MaxConnectionNumber = 1500;  // 2C2G é™åˆ¶
        options.ReceiveTimeout = TimeSpan.FromMinutes(5);
    }
}
```

**åè®®æ ¼å¼**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Length    â”‚  Message   â”‚  Sequence  â”‚  Payload   â”‚
â”‚  (4 bytes) â”‚  ID        â”‚  Number    â”‚  (Protobuf)â”‚
â”‚            â”‚  (2 bytes) â”‚  (4 bytes) â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### UDP Server

**èŒè´£**: å¿«é€Ÿé€šé“ï¼ˆå¸§åŒæ­¥ã€ç§»åŠ¨åŒæ­¥ï¼‰

**å®ç°**:
```csharp
public class UdpGameServer : SuperSocketServer<UdpSession, GamePackage>
{
    // UDP ä¸ä¿è¯å¯é æ€§
    // é€‚åˆå®æ—¶æ•°æ®ï¼Œæœ€æ–°æ•°æ®è¦†ç›–æ—§æ•°æ®
}
```

**ä½¿ç”¨åœºæ™¯**:
- å¸§åŒæ­¥è¾“å…¥ï¼ˆ15fps = 66ms/å¸§ï¼‰
- ç©å®¶ç§»åŠ¨ï¼ˆ10fps = 100ms/æ¬¡ï¼‰
- æˆ˜æ–—ç‰¹æ•ˆ

---

#### Session ç®¡ç†

```csharp
public class GameSession : AppSession
{
    // ä¼šè¯ä¿¡æ¯
    public long PlayerId { get; set; }
    public string Token { get; set; }
    public bool IsAuthenticated { get; set; }
    
    // æœ€åæ´»è·ƒæ—¶é—´
    public DateTime LastActiveTime { get; set; }
    
    // æ¶ˆæ¯åºåˆ—å·ï¼ˆé˜²é‡æ”¾ï¼‰
    public long LastSequence { get; set; }
    
    // åè®®è·¯ç”±
    protected override async ValueTask OnPackageReceivedAsync(GamePackage package)
    {
        LastActiveTime = DateTime.UtcNow;
        
        // éªŒè¯åºåˆ—å·
        if (package.Sequence <= LastSequence)
        {
            return; // ä¸¢å¼ƒé‡æ”¾æ¶ˆæ¯
        }
        LastSequence = package.Sequence;
        
        // è·¯ç”±åˆ° Gateway
        await Gateway.RouteMessageAsync(this, package);
    }
}
```

---

### 2. ç½‘å…³å±‚è®¾è®¡

#### æ¶ˆæ¯è·¯ç”±

```csharp
public class MessageGateway
{
    private readonly Dictionary<ushort, IMessageHandler> _handlers = new();
    
    public void RegisterHandler(ushort msgId, IMessageHandler handler)
    {
        _handlers[msgId] = handler;
    }
    
    public async Task RouteMessageAsync(GameSession session, GamePackage package)
    {
        // è®¤è¯æ£€æŸ¥
        if (!session.IsAuthenticated && package.MessageId != MsgId.Login)
        {
            await session.SendErrorAsync(ErrorCode.NotAuthenticated);
            return;
        }
        
        // æŸ¥æ‰¾å¤„ç†å™¨
        if (!_handlers.TryGetValue(package.MessageId, out var handler))
        {
            _logger.LogWarning($"Unknown message: {package.MessageId}");
            return;
        }
        
        // æ‰§è¡Œå¤„ç†
        await handler.HandleAsync(session, package.Payload);
    }
}
```

---

#### æ¶ˆæ¯å¤„ç†å™¨æ¥å£

```csharp
public interface IMessageHandler
{
    Task HandleAsync(GameSession session, byte[] payload);
}

// ç¤ºä¾‹ï¼šç™»å½•å¤„ç†å™¨
public class LoginHandler : IMessageHandler
{
    public async Task HandleAsync(GameSession session, byte[] payload)
    {
        // ååºåˆ—åŒ–
        var req = C2S_Login.Parser.ParseFrom(payload);
        
        // ä¸šåŠ¡é€»è¾‘
        var (success, player) = await _authService.LoginAsync(
            req.Username, req.Password);
        
        // å“åº”
        var resp = new S2C_Login
        {
            Code = success ? 0 : (int)ErrorCode.LoginFailed,
            Token = player?.Token,
            Player = player?.ToProto()
        };
        
        await session.SendAsync(MsgId.Login, resp);
    }
}
```

---

## ğŸ® ä¸šåŠ¡å±‚æ¶æ„è®¾è®¡

### 1. æ¨¡å—åˆ’åˆ†

```
BusinessLayer/
â”œâ”€â”€ Player/              # ç©å®¶æ¨¡å—
â”‚   â”œâ”€â”€ PlayerManager.cs
â”‚   â”œâ”€â”€ PlayerService.cs
â”‚   â””â”€â”€ Player.cs
â”œâ”€â”€ World/               # å¤§ä¸–ç•Œæ¨¡å—
â”‚   â”œâ”€â”€ WorldManager.cs
â”‚   â”œâ”€â”€ Scene.cs
â”‚   â”œâ”€â”€ AOI/
â”‚   â”‚   â”œâ”€â”€ Grid9AOI.cs
â”‚   â”‚   â””â”€â”€ Entity.cs
â”‚   â””â”€â”€ Movement/
â”‚       â””â”€â”€ MovementValidator.cs
â”œâ”€â”€ Room/                # æˆ¿é—´æ¨¡å—
â”‚   â”œâ”€â”€ RoomManager.cs
â”‚   â”œâ”€â”€ Room.cs
â”‚   â”œâ”€â”€ FrameSync/
â”‚   â”‚   â”œâ”€â”€ LockstepEngine.cs
â”‚   â”‚   â””â”€â”€ FrameBuffer.cs
â”‚   â””â”€â”€ Match/
â”‚       â””â”€â”€ MatchmakingService.cs
â”œâ”€â”€ Social/              # ç¤¾äº¤æ¨¡å—
â”‚   â”œâ”€â”€ ChatService.cs
â”‚   â”œâ”€â”€ FriendService.cs
â”‚   â”œâ”€â”€ LeaderboardService.cs
â”‚   â””â”€â”€ MailService.cs
â””â”€â”€ Data/                # æ•°æ®æ¨¡å—
    â”œâ”€â”€ InventoryService.cs
    â”œâ”€â”€ QuestService.cs
    â””â”€â”€ AchievementService.cs
```

---

### 2. PlayerManager è®¾è®¡

```csharp
public class PlayerManager : ISingletonService
{
    // åœ¨çº¿ç©å®¶ï¼ˆå†…å­˜ï¼‰
    private readonly ConcurrentDictionary<long, Player> _onlinePlayers = new();
    
    // æ·»åŠ ç©å®¶
    public void AddPlayer(Player player)
    {
        _onlinePlayers[player.Id] = player;
        
        // æ›´æ–° Redis
        _ = _redis.HashSetAsync("online:players", player.Id, player.SessionId);
        
        // ç›‘æ§æŒ‡æ ‡
        OnlinePlayersGauge.Set(_onlinePlayers.Count);
    }
    
    // ç§»é™¤ç©å®¶
    public async Task RemovePlayerAsync(long playerId)
    {
        if (_onlinePlayers.TryRemove(playerId, out var player))
        {
            // ä¿å­˜æ•°æ®
            await player.SaveAsync();
            
            // ä»åœºæ™¯ç§»é™¤
            player.CurrentScene?.RemovePlayer(player);
            
            // æ›´æ–° Redis
            await _redis.HashDeleteAsync("online:players", playerId);
            
            OnlinePlayersGauge.Set(_onlinePlayers.Count);
        }
    }
    
    // è·å–ç©å®¶
    public Player GetPlayer(long playerId)
    {
        return _onlinePlayers.GetValueOrDefault(playerId);
    }
}
```

---

### 3. WorldManager è®¾è®¡ï¼ˆçŠ¶æ€åŒæ­¥ï¼‰

#### Scene åœºæ™¯

```csharp
public class Scene
{
    public int SceneId { get; set; }
    public string Name { get; set; }
    
    // AOI ç®¡ç†å™¨
    private readonly Grid9AOI _aoi;
    
    // åœºæ™¯å†…å®ä½“
    private readonly ConcurrentDictionary<long, Entity> _entities = new();
    
    // æ·»åŠ ç©å®¶
    public void AddPlayer(Player player)
    {
        var entity = new PlayerEntity(player);
        _entities[player.Id] = entity;
        _aoi.Enter(entity);
        
        // å¹¿æ’­è¿›å…¥è§†é‡
        BroadcastEnterAOI(entity);
    }
    
    // ç©å®¶ç§»åŠ¨
    public void OnPlayerMove(long playerId, Vector3 position, Vector3 direction)
    {
        if (!_entities.TryGetValue(playerId, out var entity))
            return;
        
        // éªŒè¯ç§»åŠ¨åˆæ³•æ€§
        if (!MovementValidator.Validate(entity, position))
        {
            // æ‹‰å›å®¢æˆ·ç«¯
           _logger.LogWarning($"Invalid movement: {playerId}");
            return;
        }
        
        // æ›´æ–°ä½ç½®
        var oldPos = entity.Position;
        entity.Position = position;
        
        // æ›´æ–° AOI
        _aoi.UpdatePosition(entity, oldPos, position);
        
        // å¹¿æ’­ç»™è§†é‡å†…ç©å®¶
        BroadcastMovement(entity);
    }
}
```

---

#### Grid9 AOI ç®—æ³•

```csharp
public class Grid9AOI
{
    private const int GridSize = 50;  // æ¯æ ¼ 50 ç±³
    private readonly Dictionary<(int, int), HashSet<Entity>> _grids = new();
    
    // è¿›å…¥ AOI
    public void Enter(Entity entity)
    {
        var grid = GetGrid(entity.Position);
        GetOrCreateGrid(grid).Add(entity);
        entity.CurrentGrid = grid;
    }
    
    // è·å–è§†é‡å†…å®ä½“
    public List<Entity> GetEntitiesInAOI(Entity entity)
    {
        var result = new List<Entity>();
        var (gx, gy) = entity.CurrentGrid;
        
        // ä¹å®«æ ¼
        for (int dx = -1; dx <= 1; dx++)
        {
            for (int dy = -1; dy <= 1; dy++)
            {
                var grid = (gx + dx, gy + dy);
                if (_grids.TryGetValue(grid, out var entities))
                {
                    result.AddRange(entities.Where(e => 
                        e != entity && 
                        Vector3.Distance(e.Position, entity.Position) <= 50));
                }
            }
        }
        
        return result;
    }
}
```

---

### 4. RoomManager è®¾è®¡ï¼ˆå¸§åŒæ­¥ï¼‰

#### Room æˆ¿é—´

```csharp
public class Room
{
    public int RoomId { get; set; }
    public RoomState State { get; set; }  // Waiting, Preparing, Fighting, Ended
    
    // æˆ¿é—´å†…ç©å®¶
    private readonly List<RoomPlayer> _players = new();
    
    // å¸§åŒæ­¥å¼•æ“
    private readonly LockstepEngine _lockstep;
    
    // å½“å‰å¸§å·
    private int _currentFrame = 0;
    
    // å¼€å§‹æˆ˜æ–—
    public void StartBattle()
    {
        State = RoomState.Fighting;
        _currentFrame = 0;
        
        // å¯åŠ¨å¸§åŒæ­¥
        _lockstep.Start(UpdateFrame, frameRate: 15);  // 15fps
    }
    
    // æ¥æ”¶ç©å®¶è¾“å…¥
    public void ReceivePlayerInput(long playerId, int frame, byte[] input)
    {
        _lockstep.AddInput(playerId, frame, input);
    }
    
    // æ¯å¸§æ›´æ–°
    private void UpdateFrame(int frame, Dictionary<long, byte[]> inputs)
    {
        _currentFrame = frame;
        
        // å¹¿æ’­å¸§æ•°æ®ç»™æ‰€æœ‰ç©å®¶
        var frameData = new S2C_FrameData
        {
            Frame = frame,
            Inputs = { inputs.Select(kv => new PlayerInput
            {
                PlayerId = kv.Key,
                Data = ByteString.CopyFrom(kv.Value)
            })}
        };
        
        BroadcastToAll(MsgId.FrameData, frameData);
    }
}
```

---

#### Lockstep å¼•æ“

```csharp
public class LockstepEngine
{
    private const int FrameRate = 15;  // 15fps
    private const int FrameMs = 1000 / FrameRate;  // 66ms
    
    // å¸§è¾“å…¥ç¼“å†²
    private readonly Dictionary<int, Dictionary<long, byte[]>> _frameInputs = new();
    
    // ç©å®¶åˆ—è¡¨
    private readonly List<long> _playerIds;
    
    private Timer _timer;
    
    public void Start(Action<int, Dictionary<long, byte[]>> onFrame, int frameRate = 15)
    {
        _timer = new Timer(_ =>
        {
            _currentFrame++;
            
            // æ”¶é›†å½“å‰å¸§çš„æ‰€æœ‰ç©å®¶è¾“å…¥
            var inputs = GetFrameInputs(_currentFrame);
            
            // æ‰§è¡Œå¸§é€»è¾‘
            onFrame(_currentFrame, inputs);
            
            // æ¸…ç†æ—§å¸§
            CleanOldFrames();
            
        }, null, 0, FrameMs);
    }
    
    public void AddInput(long playerId, int frame, byte[] input)
    {
        if (!_frameInputs.ContainsKey(frame))
            _frameInputs[frame] = new Dictionary<long, byte[]>();
        
        _frameInputs[frame][playerId] = input;
    }
    
    private Dictionary<long, byte[]> GetFrameInputs(int frame)
    {
        if (_frameInputs.TryGetValue(frame, out var inputs))
            return inputs;
        
        // å¦‚æœæŸä¸ªç©å®¶æ²¡æœ‰è¾“å…¥ï¼Œä½¿ç”¨ç©ºè¾“å…¥
        var result = new Dictionary<long, byte[]>();
        foreach (var playerId in _playerIds)
        {
            result[playerId] = inputs?.GetValueOrDefault(playerId) ?? Array.Empty<byte>();
        }
        return result;
    }
}
```

---

### 5. ChatService è®¾è®¡

```csharp
public class ChatService
{
    private readonly IRedisClient _redis;
    
    // å‘é€èŠå¤©æ¶ˆæ¯
    public async Task SendMessageAsync(ChatMessage msg)
    {
        // æ•æ„Ÿè¯è¿‡æ»¤
        msg.Content = await FilterSensitiveWordsAsync(msg.Content);
        
        // å†·å´æ£€æŸ¥
        if (!await CheckCooldownAsync(msg.SenderId, msg.Channel))
        {
            throw new GameException(ErrorCode.ChatCooldown);
        }
        
        // ä¿å­˜åˆ° Redisï¼ˆæœ€è¿‘ 100 æ¡ï¼‰
        await _redis.ListLeftPushAsync($"chat:{msg.Channel}", msg.ToJson());
        await _redis.ListTrimAsync($"chat:{msg.Channel}", 0, 99);
        
        // å¹¿æ’­
        switch (msg.Channel)
        {
            case ChatChannel.World:
                BroadcastToWorld(msg);
                break;
            case ChatChannel.Scene:
                BroadcastToScene(msg.SceneId, msg);
                break;
            case ChatChannel.Private:
                SendToPlayer(msg.ReceiverId, msg);
                break;
        }
        
        // ä¿å­˜åˆ° MySQLï¼ˆå¼‚æ­¥ï¼‰
        _ = SaveToDatabaseAsync(msg);
    }
}
```

---

## ğŸ’¾ æ•°æ®å±‚è®¾è®¡

### 1. æ•°æ®åº“è®¾è®¡

#### ER å›¾

```mermaid
erDiagram
    USERS ||--o{ PLAYERS : has
    PLAYERS ||--o{ PLAYER_ITEMS : owns
    PLAYERS ||--o{ PLAYER_QUESTS : has
    PLAYERS ||--o{ FRIENDSHIPS : has
    PLAYERS ||--o{ MAILS : receives
    ROOMS ||--o{ BATTLE_RECORDS : generates
    
    USERS {
        bigint id PK
        varchar username UK
        varchar email UK
        varchar password_hash
        datetime created_at
        datetime last_login
    }
    
    PLAYERS {
        bigint id PK
        bigint user_id FK
        varchar name UK
        int level
        bigint exp
        int scene_id
        float pos_x
        float pos_y
        float pos_z
        datetime created_at
    }
    
    PLAYER_ITEMS {
        bigint id PK
        bigint player_id FK
        int item_id
        int count
        int slot
    }
    
    FRIENDSHIPS {
        bigint id PK
        bigint player_id FK
        bigint friend_id FK
        datetime created_at
    }
```

---

#### æ ¸å¿ƒè¡¨è®¾è®¡

**users ç”¨æˆ·è¡¨**:
```sql
CREATE TABLE `users` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `username` VARCHAR(32) NOT NULL UNIQUE,
  `email` VARCHAR(100) UNIQUE,
  `password_hash` VARCHAR(100) NOT NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `last_login` DATETIME,
  INDEX idx_username (username),
  INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**players è§’è‰²è¡¨**:
```sql
CREATE TABLE `players` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `user_id` BIGINT NOT NULL,
  `name` VARCHAR(32) NOT NULL UNIQUE,
  `level` INT DEFAULT 1,
  `exp` BIGINT DEFAULT 0,
  `scene_id` INT DEFAULT 1,
  `pos_x` FLOAT DEFAULT 0,
  `pos_y` FLOAT DEFAULT 0,
  `pos_z` FLOAT DEFAULT 0,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_user_id (user_id),
  INDEX idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**player_items èƒŒåŒ…è¡¨**:
```sql
CREATE TABLE `player_items` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `player_id` BIGINT NOT NULL,
  `item_id` INT NOT NULL,
  `count` INT DEFAULT 1,
  `slot` INT,
  FOREIGN KEY (player_id) REFERENCES players(id) ON DELETE CASCADE,
  INDEX idx_player_id (player_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**battle_records æˆ˜æ–—è®°å½•è¡¨**:
```sql
CREATE TABLE `battle_records` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `room_id` INT,
  `winner_team` INT,
  `duration` INT,
  `player_ids` JSON,  -- [1001, 1002, 1003, ...]
  `replay_data` LONGBLOB,  -- å›æ”¾æ•°æ®ï¼ˆå¯é€‰ï¼‰
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

### 2. Redis æ•°æ®è®¾è®¡

#### Key å‘½åè§„èŒƒ

```
ä¸šåŠ¡æ¨¡å—:æ•°æ®ç±»å‹:æ ‡è¯†ç¬¦

ç¤ºä¾‹:
session:token:abc123                  # Session
online:players                         # Hash, åœ¨çº¿ç©å®¶
player:data:1001                       # Hash, ç©å®¶æ•°æ®ç¼“å­˜
leaderboard:level                      # Sorted Set, ç­‰çº§æ’è¡Œæ¦œ
chat:world                             # List, ä¸–ç•ŒèŠå¤©å†å²
match:queue:1v1                        # List, åŒ¹é…é˜Ÿåˆ—
lock:player:1001                       # String, åˆ†å¸ƒå¼é”
```

---

#### æ•°æ®ç»“æ„ä½¿ç”¨

**1. Session (String)**:
```redis
SET session:token:abc123 '{"playerId":1001,"expireAt":...}' EX 604800
# 7 å¤©è¿‡æœŸ
```

**2. åœ¨çº¿ç©å®¶ (Hash)**:
```redis
HSET online:players 1001 "session_abc123"
HSET online:players 1002 "session_def456"
HLEN online:players  # è·å–åœ¨çº¿äººæ•°
```

**3. æ’è¡Œæ¦œ (Sorted Set)**:
```redis
ZADD leaderboard:level 99 1001  # ç©å®¶1001ï¼Œç­‰çº§99
ZADD leaderboard:level 88 1002
ZREVRANGE leaderboard:level 0 99 WITHSCORES  # Top 100
ZREVRANK leaderboard:level 1001  # æŸ¥è¯¢æ’å
```

**4. èŠå¤©å†å² (List)**:
```redis
LPUSH chat:world '{"sender":"å¼ ä¸‰","content":"ä½ å¥½"}'
LTRIM chat:world 0 99  # åªä¿ç•™æœ€è¿‘100æ¡
LRANGE chat:world 0 -1  # è·å–å…¨éƒ¨
```

**5. åŒ¹é…é˜Ÿåˆ— (List)**:
```redis
LPUSH match:queue:1v1 '{"playerId":1001,"rating":1500}'
BRPOP match:queue:1v1 5  # é˜»å¡å¼å¼¹å‡º,è¶…æ—¶5ç§’
```

---

### 3. ORM è®¾è®¡

#### Entity Framework Core

**DbContext**:
```csharp
public class GameDbContext : DbContext
{
    public DbSet<User> Users { get; set; }
    public DbSet<Player> Players { get; set; }
    public DbSet<PlayerItem> PlayerItems { get; set; }
    public DbSet<Quest> Quests { get; set; }
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // é…ç½®ç´¢å¼•
        modelBuilder.Entity<User>()
            .HasIndex(u => u.Username)
            .IsUnique();
        
        // é…ç½®å…³ç³»
        modelBuilder.Entity<Player>()
            .HasOne(p => p.User)
            .WithMany()
            .HasForeignKey(p => p.UserId);
    }
}
```

**Repository æ¨¡å¼**:
```csharp
public class PlayerRepository
{
    private readonly GameDbContext _db;
    
    public async Task<Player> GetByIdAsync(long id)
    {
        return await _db.Players
            .Include(p => p.Items)
            .FirstOrDefaultAsync(p => p.Id == id);
    }
    
    public async Task SaveAsync(Player player)
    {
        _db.Players.Update(player);
        await _db.SaveChangesAsync();
    }
}
```

#### Dapperï¼ˆé«˜æ€§èƒ½æŸ¥è¯¢ï¼‰

```csharp
public class LeaderboardRepository
{
    private readonly IDbConnection _db;
    
    public async Task<List<RankInfo>> GetTopPlayersAsync(int count)
    {
        const string sql = @"
            SELECT id, name, level, exp
            FROM players
            ORDER BY level DESC, exp DESC
            LIMIT @count";
        
        return (await _db.QueryAsync<RankInfo>(sql, new { count })).ToList();
    }
}
```

---

## ğŸ› ï¸ åŸºç¡€è®¾æ–½è®¾è®¡

### 1. æ—¥å¿—ç³»ç»Ÿ

#### Serilog é…ç½®

```csharp
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", LogLevel.Warning)
    .Enrich.FromLogContext()
    .Enrich.WithProperty("Application", "GameServer")
    .Enrich.WithMachineName()
    .WriteTo.Console(
        outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}")
    .WriteTo.Async(a => a.File(
        path: "logs/server-.log",
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 30,
        outputTemplate: "{Timestamp:yyyy-MM-dd HH:mm:ss.fff} [{Level:u3}] {Message:lj}{NewLine}{Exception}"))
    .CreateLogger();
```

#### æ—¥å¿—åˆ†ç±»

```csharp
// ç©å®¶æ“ä½œæ—¥å¿—
_logger.LogInformation("Player {PlayerId} logged in from {IP}", 
    playerId, session.RemoteEndPoint);

// é”™è¯¯æ—¥å¿—
_logger.LogError(ex, "Failed to save player {PlayerId}", playerId);

// æ€§èƒ½æ—¥å¿—
using (_logger.BeginTimedOperation("LoadPlayerData", playerId))
{
    await LoadPlayerDataAsync(playerId);
}
```

---

### 2. ç›‘æ§ç³»ç»Ÿ

#### Prometheus æŒ‡æ ‡

```csharp
public static class Metrics
{
    // åœ¨çº¿äººæ•°
    public static readonly Gauge OnlinePlayers = Prometheus.Metrics
        .CreateGauge("game_online_players", "Number of online players");
    
    // ç™»å½•æ¬¡æ•°
    public static readonly Counter LoginCount = Prometheus.Metrics
        .CreateCounter("game_login_total", "Total login count");
    
    // æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
    public static readonly Histogram RequestDuration = Prometheus.Metrics
        .CreateHistogram("game_request_duration_seconds", 
            "Request duration in seconds",
            new HistogramConfiguration
            {
                Buckets = Histogram.LinearBuckets(0.001, 0.01, 10)
            });
    
    // æ•°æ®åº“æŸ¥è¯¢å»¶è¿Ÿ
    public static readonly Histogram DbQueryDuration = Prometheus.Metrics
        .CreateHistogram("game_db_query_duration_seconds", 
            "Database query duration");
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```csharp
// æ›´æ–°åœ¨çº¿äººæ•°
Metrics.OnlinePlayers.Set(playerManager.GetOnlineCount());

// ç»Ÿè®¡ç™»å½•
Metrics.LoginCount.Inc();

// æµ‹é‡å»¶è¿Ÿ
using (Metrics.RequestDuration.NewTimer())
{
    await ProcessRequestAsync();
}
```

---

### 3. é…ç½®ç®¡ç†

#### appsettings.json

```json
{
  "Server": {
    "Name": "GameServer",
    "MaxPlayers": 1500,
    "TcpPort": 33333,
    "UdpPort": 33334
  },
  "Database": {
    "ConnectionString": "Server=localhost;Database=game;User=root;Password=***;",
    "MaxPoolSize": 50,
    "MinPoolSize": 5
  },
  "Redis": {
    "ConnectionString": "localhost:6379",
    "Database": 0
  },
  "Jwt": {
    "SecretKey": "your-secret-key-min-32-chars",
    "Issuer": "GameServer",
    "Audience": "GameClient",
    "ExpireMinutes": 10080
  },
  "Serilog": {
    "MinimumLevel": "Information"
  }
}
```

---

## ğŸ³ éƒ¨ç½²æ¶æ„

### Docker Compose ç¼–æ’

```yaml
version: '3.8'

services:
  # æ¸¸æˆæœåŠ¡å™¨
  gameserver:
    build: .
    image: gameserver:latest
    container_name: gameserver
    ports:
      - "33333:33333"  # TCP
      - "33334:33334/udp"  # UDP
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Database__ConnectionString=Server=mysql;Database=game;User=root;Password=123456
      - Redis__ConnectionString=redis:6379
    depends_on:
      - mysql
      - redis
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs
  
  # MySQL
  mysql:
    image: mysql:5.7
    container_name: game_mysql
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: game
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
  
  # Redis
  redis:
    image: redis:7-alpine
    container_name: game_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
  
  # Prometheus
  prometheus:
    image: prom/prometheus
    container_name: game_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped
  
  # Grafana
  grafana:
    image: grafana/grafana
    container_name: game_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
  prometheus_data:
  grafana_data:
```

---

### éƒ¨ç½²æµç¨‹

```bash
# 1. å…‹éš†ä»£ç 
git clone https://github.com/yourname/gameserver.git
cd gameserver

# 2. æ„å»ºé•œåƒ
docker-compose build

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f gameserver

# 5. åœæ­¢æœåŠ¡
docker-compose down
```

---

## ğŸ“ é¡¹ç›®ç›®å½•ç»“æ„

```
SuperSocket/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ GameServer/                    # ä¸»æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ Network/                   # ç½‘ç»œå±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ TcpServer.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ UdpServer.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ GameSession.cs
â”‚   â”‚   â”‚   â””â”€â”€ PackageFilter.cs
â”‚   â”‚   â”œâ”€â”€ Gateway/                   # ç½‘å…³å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageGateway.cs
â”‚   â”‚   â”‚   â””â”€â”€ Handlers/
â”‚   â”‚   â”‚       â”œâ”€â”€ LoginHandler.cs
â”‚   â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ Business/                  # ä¸šåŠ¡å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ Player/
â”‚   â”‚   â”‚   â”œâ”€â”€ World/
â”‚   â”‚   â”‚   â”œâ”€â”€ Room/
â”‚   â”‚   â”‚   â”œâ”€â”€ Social/
â”‚   â”‚   â”‚   â””â”€â”€ Data/
â”‚   â”‚   â”œâ”€â”€ Data/                      # æ•°æ®å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ GameDbContext.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ Repositories/
â”‚   â”‚   â”‚   â””â”€â”€ Entities/
â”‚   â”‚   â”œâ”€â”€ Infrastructure/            # åŸºç¡€è®¾æ–½
â”‚   â”‚   â”‚   â”œâ”€â”€ Logging/
â”‚   â”‚   â”‚   â”œâ”€â”€ Monitoring/
â”‚   â”‚   â”‚   â””â”€â”€ Configuration/
â”‚   â”‚   â””â”€â”€ Program.cs
â”‚   â”œâ”€â”€ GameServer.Protocol/           # Protobuf åè®®
â”‚   â”‚   â”œâ”€â”€ protos/
â”‚   â”‚   â”‚   â”œâ”€â”€ common.proto
â”‚   â”‚   â”‚   â”œâ”€â”€ login.proto
â”‚   â”‚   â”‚   â”œâ”€â”€ world.proto
â”‚   â”‚   â”‚   â””â”€â”€ room.proto
â”‚   â”‚   â””â”€â”€ Generated/
â”‚   â””â”€â”€ GameServer.Shared/             # å…±äº«åº“
â”‚       â”œâ”€â”€ Constants/
â”‚       â”œâ”€â”€ Utils/
â”‚       â””â”€â”€ Extensions/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ GameServer.Tests/
â”‚   â””â”€â”€ GameServer.IntegrationTests/
â”œâ”€â”€ sql/
â”‚   â”œâ”€â”€ init.sql                       # åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ migrations/                    # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ é¡¹ç›®éœ€æ±‚æ–‡æ¡£.md
â”‚   â”œâ”€â”€ æŠ€æœ¯é€‰å‹æ–‡æ¡£.md
â”‚   â””â”€â”€ æ¶æ„è®¾è®¡æ–‡æ¡£.md
â””â”€â”€ README.md
```

---

## ğŸ”„ æ‰©å±•åˆ°åˆ†å¸ƒå¼æ¶æ„

### æœªæ¥æ¼”è¿›è·¯å¾„

**é˜¶æ®µ 1: å½“å‰å•æœºæ¶æ„**
```
Client â†’ SuperSocket â†’ Business Layer â†’ MySQL/Redis
```

**é˜¶æ®µ 2: ç½‘å…³ + ä¸šåŠ¡åˆ†ç¦»**
```
Client â†’ SuperSocket Gateway â†’ Business Servers â†’ MySQL/Redis
                                  â†‘
                            (è´Ÿè½½å‡è¡¡)
```

**é˜¶æ®µ 3: å¼•å…¥ Orleans**
```
Client â†’ SuperSocket Gateway â†’ Orleans Cluster â†’ MySQL/Redis
                                 â”œâ”€ PlayerGrain
                                 â”œâ”€ RoomGrain
                                 â””â”€ WorldGrain
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-02-06

> [!TIP]
> æ¶æ„è®¾è®¡è¦éµå¾ª"å¤Ÿç”¨åŸåˆ™"ï¼Œå…ˆæŠŠå•æœºæ¶æ„åšæ‰å®ï¼Œå†è€ƒè™‘åˆ†å¸ƒå¼ã€‚è¿‡åº¦è®¾è®¡ä¼šå¢åŠ å¤æ‚åº¦å’Œå¼€å‘æˆæœ¬ã€‚
