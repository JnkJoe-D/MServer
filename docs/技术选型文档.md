# 游戏服务器框架 - 技术选型文档

> [!IMPORTANT]
> 本文档说明项目采用的技术栈、选型理由、替代方案以及技术风险评估。

---

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **项目名称** | SuperSocket MMO 游戏服务器框架 |
| **文档类型** | 技术选型文档 |
| **文档版本** | v1.0 |
| **创建时间** | 2026-02-06 |

---

## 🎯 技术选型原则

### 选型标准

1. **生产级标准**: 所有技术选型以生产环境为准
2. **学习价值**: 优先选择主流、有学习价值的技术
3. **性能优先**: 在 2C2G 资源下保证性能
4. **扩展性**: 预留分布式扩展能力
5. **社区活跃**: 优先选择活跃维护的开源项目

---

## 🌐 网络层技术栈

### 主框架: SuperSocket 2.0

**选型理由**:
- ✅ **.NET 生态**: 基于 .NET 6/8，跨平台支持
- ✅ **高性能**: 基于 System.IO.Pipelines，性能远超传统 Socket
- ✅ **易用性**: API 简洁，上手快
- ✅ **协议支持**: 灵活的协议解析，支持自定义
- ✅ **生产验证**: 大量商业项目使用
- ✅ **中文友好**: 国人开发，文档和社区支持好

**性能指标**:
```
并发连接: 10,000+ (单机)
QPS: 50,000+ (2C2G 环境下可达 10,000-20,000)
延迟: < 1ms (网络层)
内存占用: 低
```

**替代方案**:
| 方案 | 优点 | 缺点 | 评分 |
|------|------|------|------|
| **DotNetty** | 性能天花板，Netty 移植 | 学习曲线陡峭 | ⭐⭐⭐⭐ |
| **原生 Socket** | 完全控制 | 开发成本高，易出错 | ⭐⭐ |
| **Orleans** | 自带网络层 | 基于 HTTP/gRPC，延迟高 | ⭐⭐⭐ |

**最终选择**: **SuperSocket** ⭐⭐⭐⭐⭐

---

### TCP 协议支持

**用途**: 可靠通信（登录、聊天、交易等）

**实现方式**: SuperSocket TcpServer

**配置**:
```csharp
options.Listeners = new[]
{
    new ListenOptions
    {
        Ip = "0.0.0.0",
        Port = 33333,
        NoDelay = true,  // 禁用 Nagle，降低延迟
        BackLog = 100
    }
};
```

---

### UDP 协议支持

**用途**: 快速通道（帧同步、移动同步）

**实现方式**: SuperSocket UdpServer

**特点**:
- ✅ 低延迟
- ✅ 容忍丢包
- ✅ 适合实时数据

**使用场景**:
- 战斗中的帧数据
- 玩家移动数据
- 实时语音（可选）

---

### KCP 协议支持（可选）

**用途**: 可靠 UDP（ARQ 算法）

**实现方式**: C# KCP 库（kcp.net）

**特点**:
- ✅ 比 TCP 低延迟 30-40%
- ✅ 比 UDP 更可靠
- ✅ 适合弱网环境

**是否必需**: **可选**，初期可以只用 TCP+UDP

**库推荐**: https://github.com/KumoKyaku/KCP

---

## 📦 协议序列化

### 主方案: Protocol Buffers (Protobuf)

**选型理由**:
- ✅ **性能**: 序列化/反序列化速度快
- ✅ **体积小**: 比 JSON 小 3-10 倍
- ✅ **强类型**: 编译期类型检查
- ✅ **跨语言**: 客户端(C#/Lua)和服务端统一
- ✅ **向后兼容**: 支持版本演进
- ✅ **工具完善**: 自动生成代码

**性能对比**:
| 序列化方式 | 序列化速度 | 反序列化速度 | 体积 | 可读性 |
|-----------|-----------|-------------|------|--------|
| **Protobuf** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 100% | ⭐⭐ |
| **JSON** | ⭐⭐⭐ | ⭐⭐⭐ | 300% | ⭐⭐⭐⭐⭐ |
| **MessagePack** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 150% | ⭐⭐ |

**NuGet 包**: `Google.Protobuf`

**协议示例**:
```protobuf
syntax = "proto3";
package game.protocol;

// 登录请求
message C2S_Login {
    string username = 1;
    string password = 2;
    string device_id = 3;
}

// 登录响应
message S2C_Login {
    int32 code = 1;        // 0=成功
    string message = 2;
    string token = 3;
    PlayerInfo player = 4;
}

// 玩家信息
message PlayerInfo {
    int64 player_id = 1;
    string name = 2;
    int32 level = 3;
    int64 exp = 4;
}
```

**代码生成**:
```bash
protoc --csharp_out=./Generated *.proto
```

---

## 💾 数据层技术栈

### 关系型数据库: MySQL 5.7

**选型理由**:
- ✅ **主流**: 最广泛使用的开源数据库
- ✅ **稳定**: 生产环境验证
- ✅ **阿里云支持**: 你的服务器只能装 5.7
- ✅ **ORM 支持**: EF Core / Dapper 完美支持
- ✅ **高性能**: InnoDB 引擎，支持事务

**配置建议**:
- 字符集: `utf8mb4`
- 存储引擎: `InnoDB`
- 连接池: 最小 5，最大 50

**替代方案**:
| 方案 | 优点 | 缺点 | 评分 |
|------|------|------|------|
| **PostgreSQL** | 功能更强大 | 阿里云支持受限 | ⭐⭐⭐⭐ |
| **SQL Server** | .NET 原生 | 成本高，Linux 支持一般 | ⭐⭐⭐ |
| **MariaDB** | MySQL 分支，兼容 | 无特殊优势 | ⭐⭐⭐⭐ |

**最终选择**: **MySQL 5.7** ⭐⭐⭐⭐⭐

---

### ORM: EF Core + Dapper 混合

**EF Core**:
- **用途**: 复杂查询、开发效率高
- **场景**: 用户注册、角色创建、任务系统
- **版本**: EF Core 8.0

**Dapper**:
- **用途**: 高性能查询、简单 CRUD
- **场景**: 排行榜查询、背包查询、战斗记录
- **优势**: 性能接近原生 SQL

**为什么混合使用?**
```
EF Core: 开发效率 > 性能（非热点路径）
Dapper: 性能 > 开发效率（热点路径）
```

**NuGet 包**:
- `Microsoft.EntityFrameworkCore`
- `Pomelo.EntityFrameworkCore.MySql`
- `Dapper`

---

### 缓存: Redis 7.x

**选型理由**:
- ✅ **性能**: 读写速度极快（10 万 QPS+）
- ✅ **数据结构**: String, Hash, List, Set, Sorted Set
- ✅ **持久化**: RDB + AOF
- ✅ **主流**: 行业标准缓存方案

**使用场景**:
| 场景 | 数据结构 | 说明 |
|------|----------|------|
| **在线玩家** | Hash | `online:players:{id}` |
| **排行榜** | Sorted Set | `leaderboard:level` |
| **聊天历史** | List | `chat:world` (LPUSH + LTRIM) |
| **匹配队列** | List | `match:queue:1v1` |
| **Session** | String | `session:{token}` (TTL) |
| **锁** | String | `lock:{resource}` (SETNX) |

**NuGet 包**: `StackExchange.Redis`

**连接配置**:
```csharp
ConnectionMultiplexer.Connect("localhost:6379,abortConnect=false");
```

---

### 文档数据库: MongoDB（可选）

**用途**: 
- 聊天记录存储
- 战斗回放数据
- 日志归档

**是否必需**: **可选**，初期可以用 MySQL 代替

**如果使用**:
- **NuGet**: `MongoDB.Driver`
- **场景**: 非结构化数据、大量写入

---

## 🔐 安全技术栈

### 密码哈希: BCrypt

**选型理由**:
- ✅ **安全**: 加盐 + 慢哈希
- ✅ **防彩虹表**: 每次哈希不同
- ✅ **行业标准**: OWASP 推荐

**NuGet 包**: `BCrypt.Net-Next`

**使用示例**:
```csharp
// 注册时
string hashedPassword = BCrypt.Net.BCrypt.HashPassword(plainPassword);

// 登录验证
bool isValid = BCrypt.Net.BCrypt.Verify(plainPassword, hashedPassword);
```

---

### Token 认证: JWT

**选型理由**:
- ✅ **无状态**: 服务端不存储
- ✅ **跨域**: 适合分布式
- ✅ **标准**: RFC 7519

**NuGet 包**: `System.IdentityModel.Tokens.Jwt`

**Token 内容**:
```json
{
  "sub": "player_id",
  "name": "username",
  "exp": 1234567890,
  "iat": 1234567890
}
```

**过期时间**: 7 天（可配置）

---

### 通信加密: TLS 1.2/1.3（可选）

**是否启用**: **可选**

**理由**:
- ✅ 优点: 防窃听
- ❌ 缺点: 性能损耗 10-15%

**建议**: 
- 登录/支付接口使用 HTTPS
- 游戏内通信初期可以不加密（降  低延迟）

---

## 📊 监控和日志技术栈

### 日志: Serilog

**选型理由**:
- ✅ **结构化日志**: 支持 JSON 格式
- ✅ **灵活**: 多种 Sink（控制台、文件、数据库）
- ✅ **性能**: 异步写入
- ✅ **.NET 原生**: 与 ASP.NET Core 集成

**NuGet 包**:
- `Serilog`
- `Serilog.Sinks.Console`
- `Serilog.Sinks.File`
- `Serilog.Sinks.Async`

**配置示例**:
```csharp
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .WriteTo.Console()
    .WriteTo.File("logs/server-.log", 
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 30)
    .CreateLogger();
```

**日志级别**:
- **Debug**: 开发调试
- **Information**: 一般信息（登录/登出）
- **Warning**: 警告（异常登录尝试）
- **Error**: 错误（异常堆栈）
- **Fatal**: 严重错误（服务器崩溃）

---

### 监控: Prometheus + Grafana

**Prometheus**:
- **用途**: 指标收集和存储
- **指标类型**: Counter, Gauge, Histogram, Summary
- **NuGet**: `prometheus-net`

**监控指标**:
```csharp
// 在线人数
private static readonly Gauge OnlinePlayers = Metrics
    .CreateGauge("game_online_players", "Number of online players");

// 登录次数
private static readonly Counter LoginCount = Metrics
    .CreateCounter("game_login_total", "Total login count");

// 请求延迟
private static readonly Histogram RequestDuration = Metrics
    .CreateHistogram("game_request_duration_seconds", "Request duration");
```

**Grafana**:
- **用途**: 数据可视化
- **安装**: Docker 部署
- **仪表盘**: 预制模板

---

### 性能分析: dotnet-counters / dotnet-trace

**dotnet-counters**:
- 实时监控 CPU、内存、GC
- 命令行工具

**dotnet-trace**:
- 性能追踪
- 生成性能报告

**安装**:
```bash
dotnet tool install --global dotnet-counters
dotnet tool install --global dotnet-trace
```

---

## 🛠️ 开发工具链

### IDE: Visual Studio 2022

**选型理由**:
- ✅ .NET 原生支持
- ✅ 调试强大
- ✅ Profiler 工具

**替代方案**: Rider（JetBrains）

---

### 版本控制: Git + GitHub

**分支策略**: Git Flow
- `main`: 生产环境
- `develop`: 开发环境
- `feature/*`: 功能分支
- `hotfix/*`: 热修复

---

### CI/CD: GitHub Actions

**自动化流程**:
1. 代码提交
2. 自动测试
3. 自动构建 Docker 镜像
4. 推送到 Docker Hub / 阿里云镜像仓库
5. 自动部署到服务器（可选）

---

### 单元测试: xUnit

**NuGet 包**:
- `xUnit`
- `Moq`（Mock 框架）
- `FluentAssertions`（断言库）

**测试覆盖率目标**: 60%+

---

## 🐳 容器化和部署

### Docker

**Dockerfile 示例**:
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["GameServer/GameServer.csproj", "GameServer/"]
RUN dotnet restore
COPY . .
RUN dotnet build -c Release -o /app/build

FROM build AS publish
RUN dotnet publish -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "GameServer.dll"]
```

---

### Docker Compose

**编排服务**:
```yaml
version: '3.8'
services:
  gameserver:
    image: gameserver:latest
    ports:
      - "33333:33333"
    depends_on:
      - mysql
      - redis
  
  mysql:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: game
  
  redis:
    image: redis:7-alpine
  
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
```

---

## 🌟 未来扩展技术

### 分布式框架: Orleans

**何时引入**: 单机超过 2000 玩家时

**集成方式**:
- SuperSocket 保留为网关
- Orleans 作为业务层
- 玩家/房间管理迁移到 Grain

---

### 消息队列: RabbitMQ / Kafka

**用途**:
- 服务器间通信
- 事件溯源
- 日志收集

**何时引入**: 需要多服通信时

---

## 📋 技术栈总览

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| **网络层** | SuperSocket | 2.0+ | TCP/UDP 服务器 |
| **协议** | Protobuf | 3.x | 序列化 |
| **业务层** | .NET | 8.0 | 核心框架 |
| **数据库** | MySQL | 5.7 | 关系型数据 |
| **缓存** | Redis | 7.x | 内存缓存 |
| **ORM** | EF Core + Dapper | 8.0 | 数据访问 |
| **日志** | Serilog | 3.x | 结构化日志 |
| **监控** | Prometheus + Grafana | Latest | 指标监控 |
| **认证** | JWT | - | Token 认证 |
| **密码** | BCrypt | - | 密码哈希 |
| **容器** | Docker | Latest | 容器化 |
| **CI/CD** | GitHub Actions | - | 自动化 |
| **测试** | xUnit | Latest | 单元测试 |

---

## ⚠️ 技术风险评估

### 高风险项

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| **2C2G 性能瓶颈** | 高 | 性能测试、代码优化、Redis 缓存 |
| **MySQL 5.7 限制** | 中 | 避免使用新特性，规划升级路径 |
| **帧同步复杂度** | 高 | 充分测试、参考开源实现 |

### 中风险项

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| **网络波动** | 中 | 断线重连、数据补偿 |
| **分布式迁移** | 中 | 接口抽象、预留扩展点 |

---

## 📚 学习资源

### 官方文档

- **SuperSocket**: https://docs.supersocket.net/
- **Protobuf**: https://protobuf.dev/
- **EF Core**: https://learn.microsoft.com/ef/core/
- **Redis**: https://redis.io/docs/
- **Serilog**: https://serilog.net/
- **Prometheus**: https://prometheus.io/docs/

### 推荐书籍

- 《CLR via C#》
- 《游戏服务器编程》
- 《分布式系统原理与范型》

---

**文档版本**: v1.0  
**最后更新**: 2026-02-06

> [!TIP]
> 技术选型不是一成不变的，根据项目进展和性能测试结果，可以适时调整。重要的是理解每个技术的优缺点和适用场景。
