# 游戏服务器框架 - 项目需求文档

> [!IMPORTANT]
> 本文档定义了基于 SuperSocket 的 MMO 游戏服务器框架的完整功能需求和性能指标。

---

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **项目名称** | SuperSocket MMO 游戏服务器框架 |
| **项目类型** | 学习实践项目（面向就业） |
| **文档版本** | v1.0 |
| **创建时间** | 2026-02-06 |
| **目标环境** | 生产级标准 |

---

## 🎯 项目目标

### 核心目标

1. **学习目标**: 掌握生产级游戏服务器开发的完整技术栈
2. **技术目标**: 构建高性能、可扩展的 MMO 游戏服务器框架
3. **就业目标**: 积累分布式系统、网络编程、游戏服务器开发经验

### 项目定位

- **游戏类型**: MMO（大型多人在线）
- **同步方案**: 大世界状态同步 + PVP 帧同步混合模式
- **目标规模**: 500-2000 并发玩家
- **架构理念**: 单机起步，预留分布式扩展能力

---

## 🏗️ 项目概述

### 系统架构层次

```
┌─────────────────────────────────────┐
│  Unity 客户端（测试用，暂不开发）    │
└──────────────┬──────────────────────┘
               │ TCP/UDP/KCP
┌──────────────▼──────────────────────┐
│  接入层 - SuperSocket                │
│  ├─ TCP 连接管理                     │
│  ├─ UDP 快速通道（战斗）             │
│  └─ KCP 可靠 UDP（可选）             │
├─────────────────────────────────────┤
│  网关层 - Protobuf 协议              │
│  ├─ 协议编解码                       │
│  ├─ 消息路由                         │
│  └─ 身份认证                         │
├─────────────────────────────────────┤
│  业务层 - 游戏逻辑                   │
│  ├─ 玩家管理                         │
│  ├─ 大世界系统（状态同步）           │
│  ├─ 房间/副本系统（帧同步）          │
│  ├─ 社交系统                         │
│  └─ 后续可接入 Orleans 分布式        │
├─────────────────────────────────────┤
│  数据层 - MySQL 5.7 + Redis          │
│  ├─ 关系型数据（玩家/角色）          │
│  └─ 缓存（在线状态/排行榜）          │
├─────────────────────────────────────┤
│  基础设施层                          │
│  ├─ 日志（Serilog）                  │
│  ├─ 监控（Prometheus + Grafana）     │
│  ├─ GM 工具（Web 管理后台）          │
│  └─ Docker 容器化部署                │
└─────────────────────────────────────┘
```

---

## 📊 性能指标

### 硬件环境

| 配置项 | 规格 |
|--------|------|
| **服务器** | 阿里云轻量服务器 |
| **CPU** | 2 核 |
| **内存** | 2GB |
| **带宽** | 200M 峰值（共享） |
| **存储** | 40GB SSD |
| **管理面板** | 宝塔 Linux 面板 |

### 性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **并发连接数** | 500-2,000 | 充分利用 2C2G 资源 |
| **消息吞吐量** | 10,000-50,000 QPS | 根据消息类型 |
| **平均延迟** | < 50ms | 大世界状态同步 |
| **帧同步延迟** | < 30ms | PVP 战斗 |
| **CPU 占用** | < 70% | 平均值 |
| **内存占用** | < 1.5GB | 留余量给系统 |

---

## 🎮 功能需求

### 1. 核心功能模块

#### 1.1 用户认证系统

**功能描述**: 完整的用户注册、登录、认证流程

**详细需求**:
- ✅ 用户注册
  - 用户名/邮箱注册
  - 密码强度验证（最少 8 位，包含大小写字母+数字）
  - 邮箱验证（可选）
- ✅ 用户登录
  - 用户名/邮箱 + 密码登录
  - Token 认证（JWT）
  - 防止重复登录（踢出旧连接）
  - 自动重连机制
- ✅ 安全措施
  - 密码加盐哈希（BCrypt）
  - 登录失败次数限制（5 次锁定 15 分钟）
  - Token 过期刷新

**数据表**:
- `users` - 用户账号表
- `login_logs` - 登录日志表

---

#### 1.2 角色管理系统

**功能描述**: 玩家角色的创建、选择、删除

**详细需求**:
- ✅ 角色创建
  - 每账号最多 3 个角色
  - 角色名称唯一性检查
  - 初始属性配置
- ✅ 角色选择
  - 角色列表展示
  - 进入游戏
- ✅ 角色删除
  - 软删除（保留 7 天）
  - 删除确认机制

**数据表**:
- `players` - 角色表
- `player_attributes` - 角色属性表

---

#### 1.3 大世界系统（状态同步）

**功能描述**: MMO 核心功能，大量玩家在同一世界中交互

**详细需求**:
- ✅ AOI（Area of Interest）管理
  - 九宫格 AOI 算法
  - 玩家进入/离开视野广播
  - 可视范围: 半径 50 米
- ✅ 玩家移动
  - 客户端预测 + 服务端验证
  - 移动速度校验（防加速）
  - 位置同步频率: 100ms（10Hz）
- ✅ 场景管理
  - 多场景支持（新手村、主城、野外等）
  - 场景切换
  - 传送点系统
- ✅ NPC 系统
  - NPC 数据配置
  - NPC 交互（对话/商店/任务）
- ✅ 怪物系统
  - 怪物生成/巡逻
  - AI 简单行为树
  - 战斗（状态同步）

**技术指标**:
- 单场景承载: 200-500 玩家
- 状态同步频率: 10Hz
- AOI 更新频率: 200ms

**数据表**:
- `scenes` - 场景配置表
- `npcs` - NPC 配置表
- `monsters` - 怪物配置表

---

#### 1.4 房间/副本系统（帧同步）

**功能描述**: PVP/PVE 副本，使用帧同步保证一致性

**详细需求**:
- ✅ 房间管理
  - 创建房间（自定义/快速匹配）
  - 房间列表（支持筛选）
  - 加入/退出房间
  - 房间最大人数: 2v2, 3v3, 5v5 可配置
- ✅ 准备机制
  - 玩家准备状态
  - 房主开始游戏
  - 全员准备倒计时
- ✅ 帧同步
  - 帧率: 15fps（66ms 一帧）
  - Lockstep 算法
  - 客户端预测 + 服务端验证
  - 掉线重连（快照恢复）
- ✅ 战斗结算
  - 胜负条件判定
  - 战绩统计
  - 奖励发放
  - 战斗回放（可选）

**技术指标**:
- 帧同步延迟: < 30ms
- 支持掉线重连
- 战斗回放支持

**数据表**:
- `rooms` - 房间表（内存）
- `battle_records` - 战斗记录表

---

#### 1.5 匹配系统

**功能描述**: 自动匹配合适的对手

**详细需求**:
- ✅ 匹配队列
  - 单人匹配
  - 组队匹配
  - 匹配超时（60 秒）
- ✅ 匹配算法
  - ELO 评分匹配
  - 匹配范围动态扩大（超时后）
- ✅ 匹配确认
  - 匹配成功通知
  - 确认倒计时（10 秒）
  - 拒绝/超时重新匹配

**数据表**:
- `match_queue` - 匹配队列（内存/Redis）
- `player_ratings` - 玩家评分表

---

### 2. 社交功能模块

#### 2.1 聊天系统

**功能描述**: 多频道聊天通信

**详细需求**:
- ✅ 聊天频道
  - 世界频道（全服）
  - 场景频道（当前场景）
  - 房间频道（副本内）
  - 私聊（1v1）
  - 队伍频道（可选）
  - 公会频道（可选）
- ✅ 消息功能
  - 文本消息
  - 表情（预定义）
  - 物品链接（可选）
- ✅ 管理功能
  - 敏感词过滤
  - 发言冷却（防刷屏）
  - 禁言功能（GM）
  - 消息历史（最近 100 条）

**技术指标**:
- 世界聊天限制: 10 秒/条
- 私聊限制: 1 秒/条
- 消息长度: 最大 200 字符

**数据表**:
- `chat_messages` - 聊天记录表
- `sensitive_words` - 敏感词表

---

#### 2.2 好友系统

**功能描述**: 好友关系管理

**详细需求**:
- ✅ 好友操作
  - 添加好友（需确认）
  - 删除好友
  - 好友上限: 100 人
- ✅ 好友信息
  - 在线状态
  - 最后登录时间
  - 等级/战力
- ✅ 黑名单
  - 屏蔽玩家
  - 黑名单上限: 50 人

**数据表**:
- `friendships` - 好友关系表
- `blacklist` - 黑名单表

---

#### 2.3 排行榜系统

**功能描述**: 多维度排行榜

**详细需求**:
- ✅ 排行榜类型
  - 等级排行榜
  - 战力排行榜
  - 胜场排行榜
  - PVP 评分排行榜
- ✅ 排行榜功能
  - 实时更新（Redis Sorted Set）
  - 榜单查询（Top 100）
  - 个人排名查询
  - 每日/每周/赛季榜单
- ✅ 奖励系统
  - 排名奖励配置
  - 定时发放

**技术方案**: Redis Sorted Set

---

#### 2.4 邮件系统

**功能描述**: 系统邮件和玩家邮件

**详细需求**:
- ✅ 邮件类型
  - 系统邮件（公告/奖励）
  - 玩家邮件（私信）
- ✅ 邮件功能
  - 发送邮件
  - 接收邮件
  - 删除邮件
  - 附件系统（道具/货币）
  - 邮件保留: 7 天
- ✅ 一键领取
  - 批量领取附件

**数据表**:
- `mails` - 邮件表
- `mail_attachments` - 邮件附件表

---

### 3. 数据功能模块

#### 3.1 背包系统

**功能描述**: 道具存储和管理

**详细需求**:
- ✅ 背包功能
  - 背包容量: 100 格（可扩展）
  - 道具堆叠
  - 道具使用
  - 道具丢弃/出售
- ✅ 装备系统
  - 装备穿戴/卸下
  - 装备强化（可选）
  - 装备品质（白绿蓝紫橙）

**数据表**:
- `items` - 道具配置表
- `player_items` - 玩家背包表
- `player_equipments` - 玩家装备表

---

#### 3.2 任务系统

**功能描述**: 主线/支线/每日任务

**详细需求**:
- ✅ 任务类型
  - 主线任务
  - 支线任务
  - 每日任务
  - 成就任务
- ✅ 任务功能
  - 任务接取
  - 任务进度追踪
  - 任务完成/提交
  - 任务奖励
- ✅ 任务条件
  - 击杀怪物 X 只
  - 收集道具 X 个
  - 对话 NPC
  - 到达指定位置

**数据表**:
- `quests` - 任务配置表
- `player_quests` - 玩家任务进度表

---

#### 3.3 成就系统

**功能描述**: 成就奖励系统

**详细需求**:
- ✅ 成就类型
  - 等级成就
  - 战斗成就
  - 收集成就
  - 社交成就
- ✅ 成就功能
  - 成就进度
  - 成就完成奖励
  - 成就展示（称号）

**数据表**:
- `achievements` - 成就配置表
- `player_achievements` - 玩家成就表

---

#### 3.4 数据持久化

**功能描述**: 玩家数据的保存和恢复

**详细需求**:
- ✅ 数据保存策略
  - 定时保存（5 分钟）
  - 关键操作立即保存（装备/道具交易）
  - 下线保存
  - 服务器关闭保存
- ✅ 数据恢复
  - 登录时加载
  - 数据校验
  - 异常数据回滚
- ✅ 数据备份
  - 每日全量备份（数据库）
  - 增量备份（binlog）

---

## 🔒 安全需求

### 网络安全

| 功能 | 说明 | 实现方式 |
|------|------|----------|
| **通信加密** | 防止数据被窃听 | TLS 1.2/1.3（可选，性能考虑） |
| **Token 认证** | 防止未授权访问 | JWT Token |
| **防重放攻击** | 防止消息重复发送 | 消息序列号 + 时间戳 |
| **流量限制** | 防止 DDoS | 连接频率限制、消息频率限制 |

### 游戏逻辑安全

| 功能 | 说明 | 实现方式 |
|------|------|----------|
| **服务端权威** | 防止客户端作弊 | 所有逻辑服务端验证 |
| **移动校验** | 防止加速/瞬移 | 速度校验、距离校验 |
| **资源校验** | 防止刷物品 | 资源变动日志、异常检测 |
| **输入校验** | 防止注入攻击 | 参数化查询、输入过滤 |

### 数据安全

| 功能 | 说明 | 实现方式 |
|------|------|----------|
| **密码安全** | 防止密码泄露 | BCrypt 加盐哈希 |
| **数据加密** | 敏感数据加密 | AES-256（敏感字段） |
| **SQL 防注入** | 防止 SQL 注入 | 参数化查询、ORM |
| **日志脱敏** | 防止日志泄露敏感信息 | 密码/Token 不记录 |

---

## 📈 运维需求

### 日志系统

**需求**:
- ✅ 日志级别: Debug, Info, Warning, Error, Fatal
- ✅ 日志内容:
  - 服务器启动/关闭
  - 玩家登录/登出
  - 关键操作（交易/战斗/道具使用）
  - 异常错误（堆栈信息）
- ✅ 日志存储:
  - 控制台输出
  - 文件存储（按日期切分）
  - 远程日志（ELK，可选）
- ✅ 日志保留: 30 天

**技术方案**: Serilog

---

### 监控系统

**需求**:
- ✅ 性能监控
  - CPU 使用率
  - 内存使用率
  - 网络流量
  - QPS（每秒请求数）
- ✅ 业务监控
  - 在线人数
  - 注册/登录数
  - 邮件发送量
  - 错误率
- ✅ 告警机制
  - CPU > 80% 告警
  - 内存 > 90% 告警
  - 错误率 > 5% 告警
  - 告警方式: 邮件/钉钉/企业微信

**技术方案**: Prometheus + Grafana

---

### GM 工具（管理后台）

**需求**:
- ✅ 玩家管理
  - 查询玩家信息
  - 封禁/解封账号
  - 禁言/解禁
  - 踢下线
- ✅ 道具管理
  - 发放道具/货币
  - 删除道具
  - 查看背包
- ✅ 邮件管理
  - 发送全服邮件
  - 发送个人邮件
- ✅ 服务器管理
  - 服务器状态查看
  - 服务器重启/关闭
  - 热更新配置
- ✅ 日志查询
  - 操作日志查询
  - 错误日志查询

**技术方案**: ASP.NET Core Web API + Vue.js 前端

---

### 部署需求

**需求**:
- ✅ 容器化部署
  - Docker 镜像
  - Docker Compose 编排
- ✅ 自动化部署
  - CI/CD 流程（GitHub Actions）
  - 自动测试
  - 自动发布
- ✅ 配置管理
  - 配置文件（appsettings.json）
  - 环境变量支持
  - 配置热更新
- ✅ 版本管理
  - Git 版本控制
  - 语义化版本号
  - 版本回滚能力

---

## 🔌 协议需求

### Protobuf 协议

**需求**:
- ✅ 协议设计规范
  - 消息 ID 统一管理
  - 请求/响应配对
  - 错误码标准化
- ✅ 协议类型
  - C2S（Client to Server）
  - S2C（Server to Client）
  - S2S（Server to Server，预留）
- ✅ 协议文件管理
  - .proto 文件组织
  - 自动生成 C# 代码
  - 版本兼容性

**协议示例**:
```protobuf
// login.proto
syntax = "proto3";

message C2S_Login {
  string username = 1;
  string password = 2;
}

message S2C_Login {
  int32 code = 1;        // 0=成功, 其他=错误码
  string message = 2;    // 错误信息
  string token = 3;      // JWT Token
  PlayerInfo player = 4; // 玩家信息
}
```

---

## 🌐 网络协议需求

### TCP 协议

**用途**: 可靠通信（登录、聊天、道具操作等）

**需求**:
- ✅ 粘包/拆包处理
- ✅ 心跳机制（30 秒）
- ✅ 断线重连
- ✅ 消息队列（防消息丢失）

---

### UDP 协议

**用途**: 快速通道（帧同步、移动同步）

**需求**:
- ✅ 对战中的帧数据传输
- ✅ 玩家移动数据
- ✅ 容忍丢包（最新数据覆盖）
- ✅ 客户端预测 + 服务端校正

---

### KCP 协议（可选）

**用途**: 可靠 UDP（性能介于 TCP 和 UDP 之间）

**需求**:
- ✅ 比 TCP 更低延迟
- ✅ 比 UDP 更可靠
- ✅ 用于对延迟敏感但需要可靠性的场景

---

## 📅 开发阶段规划

### 第一阶段: 基础框架（2-3 周）

- [ ] SuperSocket 网络层搭建
- [ ] Protobuf 协议集成
- [ ] TCP/UDP/KCP 多协议支持
- [ ] 数据库设计和 ORM 集成
- [ ] Redis 缓存集成
- [ ] 日志系统搭建

---

### 第二阶段: 核心功能（4-6 周）

- [ ] 用户认证系统
- [ ] 角色管理系统
- [ ] 大世界系统（状态同步）
- [ ] 房间/副本系统（帧同步）
- [ ] 匹配系统

---

### 第三阶段: 社交功能（2-3 周）

- [ ] 聊天系统
- [ ] 好友系统
- [ ] 排行榜系统
- [ ] 邮件系统

---

### 第四阶段: 数据功能（2-3 周）

- [ ] 背包系统
- [ ] 任务系统
- [ ] 成就系统

---

### 第五阶段: 安全和运维（2-3 周）

- [ ] 安全措施实施
- [ ] 监控系统部署
- [ ] GM 工具开发
- [ ] Docker 容器化
- [ ] CI/CD 流程

---

### 第六阶段: 优化和扩展（长期）

- [ ] 性能优化
- [ ] 压力测试
- [ ] 分布式改造（Orleans 集成）
- [ ] 高级功能（战斗回放、AI 等）

---

## 💡 技术债务和未来规划

### 单机到分布式演进

当前设计为单机架构，但预留分布式扩展能力：

**预留接口**:
- 玩家管理接口（未来可接入 Orleans PlayerGrain）
- 房间管理接口（未来可接入 RoomGrain）
- 消息总线（未来可接入 RabbitMQ/Kafka）

**分布式改造路径**:
1. 网关层保持 SuperSocket
2. 业务层接入 Orleans
3. 数据层分库分表（ShardingSphere）

---

## 📚 参考资料

### 学习资源

- **SuperSocket**: https://docs.supersocket.net/
- **Protobuf**: https://protobuf.dev/
- **Orleans**: https://learn.microsoft.com/orleans/
- **Redis**: https://redis.io/docs/
- **Serilog**: https://serilog.net/
- **Prometheus**: https://prometheus.io/docs/

---

**文档版本**: v1.0  
**最后更新**: 2026-02-06  
**负责人**: 开发者

> [!TIP]
> 这是一个雄心勃勃的项目！建议按阶段逐步实施，先完成基础框架和核心功能，再逐步添加高级功能。每个阶段完成后都要进行充分测试。
