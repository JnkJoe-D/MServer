# 连接健康检查使用说明

## 功能说明

`ConnectionHealthCheck` 是一个启动时健康检查服务，会在程序启动时自动测试 MySQL 和 Redis 的连接。

---

## 测试内容

### 1. MySQL 连接测试

- ✅ 检查数据库是否可达（`CanConnectAsync`）
- ✅ 查询用户表数量（验证读取权限）
- ✅ 捕获并记录连接异常

### 2. Redis 连接测试

- ✅ 测试写入操作（`SET`）
- ✅ 测试读取操作（`GET`）
- ✅ 测试删除操作（`DEL`）
- ✅ 验证数据一致性
- ✅ 捕获并记录连接异常

---

## 启动日志示例

### 成功场景

```log
[02:50:00 INF] ========================================
[02:50:00 INF] 游戏服务器启动中...
[02:50:00 INF] ========================================
[02:50:01 INF] ========================================
[02:50:01 INF] 开始连接健康检查...
[02:50:01 INF] ========================================
[02:50:01 INF] 测试 MySQL 连接...
[02:50:02 INF] ✅ MySQL 连接成功！当前用户数: 5
[02:50:02 INF] 测试 Redis 连接...
[02:50:02 INF] Redis连接成功: 127.0.0.1:6379, Database=0
[02:50:02 INF] ✅ Redis 连接成功！写入/读取/删除测试通过
[02:50:02 INF] ========================================
[02:50:02 INF] ✅ 所有连接健康检查通过！
[02:50:02 INF] ========================================
[02:50:02 INF] 消息处理器注册完成
[02:50:02 INF] 服务器启动完成，监听端口: 33333
```

### 失败场景（MySQL 无法连接）

```log
[02:50:00 INF] ========================================
[02:50:00 INF] 游戏服务器启动中...
[02:50:00 INF] ========================================
[02:50:01 INF] ========================================
[02:50:01 INF] 开始连接健康检查...
[02:50:01 INF] ========================================
[02:50:01 INF] 测试 MySQL 连接...
[02:50:16 ERR] ❌ MySQL 连接测试异常
MySqlConnector.MySqlException (0x80004005): Unable to connect to any of the specified MySQL hosts.
[02:50:16 INF] 测试 Redis 连接...
[02:50:16 INF] Redis连接成功: 127.0.0.1:6379, Database=0
[02:50:16 INF] ✅ Redis 连接成功！写入/读取/删除测试通过
[02:50:16 INF] ========================================
[02:50:16 WRN] ⚠️ 部分连接健康检查失败，请查看上方日志
[02:50:16 INF] ========================================
```

**注意**：健康检查失败**不会阻止程序启动**，只是记录警告日志。

---

## 如何使用

### 启动程序即可自动测试

```bash
# 开发环境
dotnet run

# 生产环境
ASPNETCORE_ENVIRONMENT=Production ./GameServer
```

启动后会自动执行健康检查并输出日志。

---

## 禁用健康检查（可选）

如果不需要启动时检查，可以注释掉注册代码：

**Program.cs**

```csharp
// 注册处理器到网关
services.AddHostedService<MessageHandlerRegistration>();

// 连接健康检查（可选）
// services.AddHostedService<ConnectionHealthCheck>();  // ← 注释掉即可禁用
```

---

## 手动测试建议

### 测试 1：正常连接

**操作**：正常启动程序

**预期结果**：
```
✅ MySQL 连接成功！当前用户数: X
✅ Redis 连接成功！写入/读取/删除测试通过
✅ 所有连接健康检查通过！
```

### 测试 2：MySQL 连接失败

**操作**：修改配置文件，使用错误的 MySQL 连接字符串

```json
{
  "Database": {
    "ConnectionString": "Server=127.0.0.1;Port=9999;Database=wrong;..."
  }
}
```

**预期结果**：
```
❌ MySQL 连接测试异常
MySqlConnector.MySqlException: ...
⚠️ 部分连接健康检查失败
```

### 测试 3：Redis 连接失败

**操作**：修改配置文件，使用错误的 Redis 端口

```json
{
  "Redis": {
    "ConnectionString": "127.0.0.1:9999"
  }
}
```

**预期结果**：
```
❌ Redis 连接测试异常
StackExchange.Redis.RedisConnectionException: ...
⚠️ 部分连接健康检查失败
```

### 测试 4：Redis 密码错误

**操作**：使用错误的 Redis 密码

```json
{
  "Redis": {
    "ConnectionString": "127.0.0.1:6379",
    "Password": "wrong-password"
  }
}
```

**预期结果**：
```
❌ Redis 连接测试异常
StackExchange.Redis.RedisConnectionException: ...
⚠️ 部分连接健康检查失败
```

---

## 代码结构

```
Infrastructure/
└── ConnectionHealthCheck.cs
    ├── StartAsync()           # 启动时执行
    ├── CheckMySqlAsync()      # MySQL 测试
    ├── CheckRedisAsync()      # Redis 测试
    └── StopAsync()            # 停止时执行（空实现）
```

---

## 常见问题

### Q1: 健康检查失败会导致程序无法启动吗？

**A**: 不会。健康检查只是记录日志，不影响程序启动。程序会继续运行，但相应的功能可能无法正常工作。

### Q2: 为什么启动时会看到两次 "Redis连接成功" 日志？

**A**: 
1. 第一次：`ConnectionHealthCheck` 创建 `RedisService` 时输出
2. 健康检查测试成功后也会输出一次确认

### Q3: 可以自定义测试内容吗？

**A**: 可以。直接编辑 `Infrastructure/ConnectionHealthCheck.cs`，添加您需要的测试逻辑。

例如，测试特定的 Redis 键：

```csharp
// 测试特定配置是否存在
var config = await redis.GetAsync("game:config:version");
if (string.IsNullOrEmpty(config))
{
    _logger.LogWarning("⚠️ 游戏配置未初始化");
}
```

### Q4: 健康检查会影响启动性能吗？

**A**: 影响很小。通常只需要 1-2 秒，且是一次性的。

---

## 生产环境建议

### 建议保留健康检查

**原因**：
- ✅ 及早发现配置错误
- ✅ 确认依赖服务可用
- ✅ 方便排查启动问题
- ✅ 提供启动时的确认信息

### 监控日志

使用日志监控工具（如 ELK、Grafana）监控健康检查失败：

```bash
# 搜索健康检查失败
grep "部分连接健康检查失败" logs/server-*.log

# 或者使用 journalctl
journalctl -u mserver | grep "健康检查失败"
```

---

## 扩展建议

如果需要更复杂的健康检查，可以考虑：

### 1. 添加 HTTP 健康检查端点

```csharp
// 添加 ASP.NET Core HealthCheck
services.AddHealthChecks()
    .AddDbContextCheck<GameDbContext>()
    .AddRedis(redisConnectionString);

app.MapHealthChecks("/health");
```

访问：`http://localhost:8080/health`

### 2. 定期健康检查

```csharp
public class PeriodicHealthCheck : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            // 每 5 分钟检查一次
            await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
            await CheckConnectionsAsync();
        }
    }
}
```

### 3. 集成到 Prometheus

```csharp
private static readonly Gauge ConnectionHealth = Metrics.CreateGauge(
    "connection_health",
    "Connection health status (1=healthy, 0=unhealthy)",
    new GaugeConfiguration
    {
        LabelNames = new[] { "service" }
    });

// 设置指标
ConnectionHealth.WithLabels("mysql").Set(mysqlHealthy ? 1 : 0);
ConnectionHealth.WithLabels("redis").Set(redisHealthy ? 1 : 0);
```

---

## 总结

| 特性 | 说明 |
|------|------|
| 触发时机 | 程序启动时自动执行 |
| 测试内容 | MySQL 连接 + Redis 读写 |
| 失败处理 | 记录日志但不阻止启动 |
| 性能影响 | 1-2 秒，一次性 |
| 推荐使用 | ✅ 生产环境保留 |
